<div class="container">
    <h2 class="mb-4"><span class="marca-texto-roxo">Gerenciar Chats & DMs</span></h2>

    <!-- Mensagens de alerta -->
    <div id="alertsContainer"></div>

    <div class="row">
        <!-- Criar chat público -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><span class="marca-texto-verde">Criar Chat Público</span></h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Crie um chat público visível para todos.</p>
                    <div class="mb-2">
                        <input type="text" id="publicChatName" class="form-control mb-2" placeholder="Nome do chat">
                        <select id="publicChatTopic" class="form-select mb-2"></select>
                        <button class="btn btn-primary w-100" id="createPublicChatBtn">
                            <i class="fas fa-plus-circle me-1"></i> Criar Chat
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Criar DM entre dois usuários -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><span class="marca-texto-verde">Criar DM (Admin)</span></h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Crie uma conversa direta entre dois usuários.</p>
                    <div id="adminDmPanel">
                        <select id="adminUser1" class="form-select mb-2"></select>
                        <select id="adminUser2" class="form-select mb-2"></select>
                        <button class="btn btn-success w-100" id="createAdminDmBtn">
                            <i class="fas fa-comments me-1"></i> Criar DM
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de chats -->
    <div id="chatSearchContainer" class="mb-3" style="display:none;">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" id="chatSearchInput" class="form-control" placeholder="Buscar por título ou participante...">
        </div>
    </div>

    <div class="chat-list mb-4" id="chatList">
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2">Carregando...</p>
        </div>
    </div>  
</div>

<!-- Modal de edição -->
<div class="modal fade" id="editChatModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Administrar Conversa</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="editChatFields">
          <div class="mb-3" id="editChatNameGroup">
            <label for="editChatName" class="form-label">Nome do chat</label>
            <input type="text" id="editChatName" class="form-control">
          </div>
          <div class="mb-3" id="editParticipantsContainer" style="display:none;">
            <label class="form-label">Participantes</label>
            <select id="editParticipant1" class="form-select mb-2"></select>
            <select id="editParticipant2" class="form-select mb-2"></select>
          </div>
        </div>
        <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Cuidado:</strong> Excluir um chat removerá todas as mensagens permanentemente.
        </div>
        <button class="btn btn-danger w-100" id="deleteChatBtn">
            <i class="fas fa-trash-alt me-1"></i> Excluir Chat/DM
        </button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button type="button" class="btn btn-primary" id="saveChatBtn">Salvar Alterações</button>
      </div>
    </div>
  </div>
</div>

<style>
    .chat-card { cursor: pointer; transition: all 0.2s ease-in-out; margin-bottom: 12px; }
    .chat-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .border-primary { border-left: 4px solid #007bff !important; }
    .border-success { border-left: 4px solid #28a745 !important; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    .alert { animation: fadeIn 0.5s; }
</style>

<script>
// ==================== Estado Global ====================
const state = {
    currentChat: null,
    loggedUser: null,
    searchTimeout: null
};

// ==================== Utilitários UI ====================
function showAlert(message, type = 'success') {
    const alertDiv = document.createElement("div");
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
    `;
    document.querySelector(".container").prepend(alertDiv);
    setTimeout(() => alertDiv.remove(), 5000);
}

// ==================== Carregamento de Dados ====================
async function carregarChats() {
    const chatList = document.getElementById("chatList");
    try {
        const search = document.getElementById("chatSearchInput")?.value || "";
        const res = await fetch(`/api/admin/chats?search=${encodeURIComponent(search)}`, { credentials: "include" });
        if (!res.ok) throw new Error("Erro ao carregar");
        
        const data = await res.json();
        const chats = data.chats || [];
        
        if (chats.length === 0) {
            chatList.innerHTML = `<div class="alert alert-info">Nenhuma conversa encontrada.</div>`;
            return;
        }

        chatList.innerHTML = "<h5 class='mb-3'><span class='marca-texto-verde'>Gerenciar Conversas</span></h5>";
        document.getElementById("chatSearchContainer").style.display = "block";

        chats.forEach(chat => {
            const date = chat.lastmessageat ? new Date(chat.lastmessageat).toLocaleString('pt-BR') : 'Sem atividade';
            const card = document.createElement("div");
            card.className = `card mb-2 chat-card border-${chat.type === 'public' ? 'primary' : 'success'}`;
            
            card.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <h6 class="card-title">${chat.title}</h6>
                        <span class="badge bg-${chat.type === 'public' ? 'primary' : 'success'}" style="color: white !important">${chat.type.toUpperCase()}</span>
                    </div>
                    <small class="text-muted d-block">
                        Assunto: ${chat.topic} | Criador: ${chat.creatorusername} | Msg: ${chat.messagecount}
                    </small>
                    <small class="text-muted">Atividade: ${date}</small>
                    <div class="mt-2 text-end">
                        <button class="btn btn-sm btn-outline-primary edit-btn">
                            <i class="fas fa-edit"></i>
                        </button>
                        <a href="/chat/${chat.publicid}" class="btn btn-sm btn-outline-secondary"><i class="fas fa-external-link-alt"></i></a>
                    </div>
                </div>
            `;

            card.querySelector(".edit-btn").onclick = (e) => {
                e.stopPropagation();
                abrirModalEdicao(chat);
            };

            chatList.appendChild(card);
        });
    } catch (err) {
        chatList.innerHTML = `<div class="alert alert-danger">Erro: ${err.message}</div>`;
    }
}

// ==================== Ações de Chat ====================
async function abrirModalEdicao(chat) {
    state.currentChat = chat;
    document.getElementById("editChatName").value = chat.title || "";
    
    const isDM = chat.type === 'dm';
    const isOwner = state.loggedUser?.roleId === 1;

    document.getElementById("editChatNameGroup").style.display = !isDM ? "block" : "none";
    document.getElementById("editParticipantsContainer").style.display = isDM ? "block" : "none";
    document.getElementById("editChatFields").style.display = isOwner ? "block" : "none";
    document.getElementById("saveChatBtn").style.display = isOwner ? "block" : "none";

    if (isDM && isOwner) {
        await carregarUsuariosAdmin();
        const u1 = document.getElementById("editParticipant1");
        const u2 = document.getElementById("editParticipant2");
        if (u1) u1.value = chat.participants[0]?.publicid || "";
        if (u2) u2.value = chat.participants[1]?.publicid || "";
    }
    
    new bootstrap.Modal(document.getElementById('editChatModal')).show();
}

document.getElementById("saveChatBtn").addEventListener("click", async () => {
    const btn = document.getElementById("saveChatBtn");
    try {
        btn.disabled = true;
        const body = { 
            title: document.getElementById("editChatName").value.trim(),
            type: state.currentChat.type,
            participants: state.currentChat.type === 'dm' ? [
                document.getElementById("editParticipant1").value,
                document.getElementById("editParticipant2").value
            ] : []
        };

        const res = await fetch(`/api/admin/chats/${state.currentChat.publicid}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
            credentials: "include"
        });

        if (res.ok) {
            showAlert("Atualizado com sucesso!");
            carregarChats();
            bootstrap.Modal.getInstance(document.getElementById('editChatModal')).hide();
        } else {
            const d = await res.json();
            alert(d.message);
        }
    } catch (e) { alert(e.message); }
    finally { btn.disabled = false; }
});

document.getElementById("deleteChatBtn").addEventListener("click", async () => {
    if (!(await confirm("Excluir permanentemente?"))) return;
    try {
        const res = await fetch(`/api/admin/chats/${state.currentChat.publicid}?type=${state.currentChat.type}`, {
            method: "DELETE",
            credentials: "include"
        });
        if (res.ok) {
            showAlert("Excluído!");
            carregarChats();
            bootstrap.Modal.getInstance(document.getElementById('editChatModal')).hide();
        }
    } catch (e) { alert(e.message); }
});

// ==================== Criação de Chat/DM ====================
document.getElementById("createPublicChatBtn").addEventListener("click", async () => {
    const title = document.getElementById("publicChatName").value.trim();
    const topic = document.getElementById("publicChatTopic").value;
    if (!title) return alert("Digite um nome");

    const btn = document.getElementById("createPublicChatBtn");
    try {
        btn.disabled = true;
        const res = await fetch(`/api/admin/chats/public`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title, topic }),
            credentials: "include"
        });
        if (res.ok) {
            showAlert("Chat criado!");
            document.getElementById("publicChatName").value = "";
            carregarChats();
        }
    } catch (e) { alert(e.message); }
    finally { btn.disabled = false; }
});

document.getElementById("createAdminDmBtn").addEventListener("click", async () => {
    const user1 = document.getElementById("adminUser1").value;
    const user2 = document.getElementById("adminUser2").value;
    if (!user1 || !user2 || user1 === user2) return alert("Selecione usuários diferentes");

    const btn = document.getElementById("createAdminDmBtn");
    try {
        btn.disabled = true;
        const res = await fetch(`/api/admin/chats/dm`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ otherUserPublicId: user2, creatorPublicId: user1 }),
            credentials: "include"
        });
        if (res.ok) {
            showAlert("DM criada!");
            carregarChats();
        } else {
            const d = await res.json();
            alert(d.message);
        }
    } catch (e) { alert(e.message); }
    finally { btn.disabled = false; }
});

// ==================== Carregamento de Auxiliares ====================
async function carregarTopicos() {
    try {
        const res = await fetch(`/api/admin/chats/topics`, { credentials: "include" });
        const topics = await res.json();
        const select = document.getElementById("publicChatTopic");
        select.innerHTML = topics.map(t => `<option value="${t.name}" ${t.name==='Geral'?'selected':''}>Assunto: ${t.name}</option>`).join("");
    } catch (e) {}
}

async function carregarUsuariosAdmin() {
    try {
        const res = await fetch(`/api/admin/users`, { credentials: "include" });
        const data = await res.json();
        const users = data.users || data;
        
        const selects = ["adminUser1", "adminUser2", "editParticipant1", "editParticipant2"];
        selects.forEach(id => {
            const el = document.getElementById(id);
            if (!el) return;
            const currentVal = el.value;
            el.innerHTML = '<option value="">Selecione...</option>' + 
                users.map(u => `<option value="${u.publicid}">${u.username}</option>`).join("");
            el.value = currentVal;
        });
    } catch (e) {}
}

async function buscarUsuarioLogado() {
    try {
        const res = await fetch('/api/users/me', { credentials: "include" });
        if (res.ok) state.loggedUser = await res.json();
    } catch (e) {}
}

// ==================== Inicialização ====================
window.addEventListener("DOMContentLoaded", () => {
    // Busca em tempo real
    document.getElementById("chatSearchInput")?.addEventListener("input", () => {
        clearTimeout(state.searchTimeout);
        state.searchTimeout = setTimeout(carregarChats, 500);
    });

    buscarUsuarioLogado();
    carregarChats();
    carregarUsuariosAdmin();
    carregarTopicos();
});
</script>

<!-- Modais necessários -->
<%- include('../../utils/modal-aviso') %>
<%- include('../../utils/modal-confirmacao') %>
