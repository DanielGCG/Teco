<div class="container mt-4">
    <h2 class="mb-4">Gerenciamento de Usuários</h2>

    <!-- Lista de usuários -->
    <div class="user-list" id="userList"></div>
</div>

<!-- Modal de edição de usuário -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Editar Usuário</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body text-center">
        <img id="editUserProfile" src="" alt="Foto de perfil" class="rounded-circle mb-3" width="100" height="100">

        <div class="mb-3 text-start">
            <label for="editUsername" class="form-label">Nome de usuário</label>
            <input type="text" id="editUsername" class="form-control">
        </div>

        <div class="mb-3 text-start">
            <label for="editRole" class="form-label">Função</label>
            <select id="editRole" class="form-select">
                <option value="0">Usuário</option>
                <option value="1">Administrador</option>
                <option value="2">Dono</option>
            </select>
        </div>

        <div class="mb-3 text-start">
            <label for="editBio" class="form-label">Bio</label>
            <textarea id="editBio" class="form-control" rows="3"></textarea>
        </div>

        <button class="btn btn-danger w-100" id="deleteUserBtn">Excluir Usuário</button>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary w-100" id="saveUserBtn">Salvar Alterações</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
let currentUser = null;
let usuariosLista = [];
let currentLoggedUser = null;

// ==================== Buscar usuário logado ====================
async function buscarUsuarioLogado() {
    try {
        const res = await fetch('/api/users/me', { credentials: "include" });
        if (res.ok) {
            currentLoggedUser = await res.json();
        }
    } catch(err) {
        console.error("Erro ao buscar usuário logado:", err);
    }
}

// ==================== Carregar usuários ====================
async function carregarUsuarios() {
    try {
        const res = await fetch('/api/admin/users', { credentials: "include" });
        if (!res.ok) throw new Error("Erro ao carregar usuários");
        const users = await res.json();

        usuariosLista = users; // salva globalmente

        const userList = document.getElementById("userList");
        userList.innerHTML = "";

        users.forEach(user => {
        const card = document.createElement("div");
        card.classList.add("card", "mb-2", "cursor-pointer"); // adicionei cursor-pointer para indicar clique
        const roleText = user.role === 2 ? 'Dono' : user.role === 1 ? 'Administrador' : 'Usuário';
        card.innerHTML = `
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <strong>${user.username}</strong><br>
                    <small>${roleText} | Último acesso: ${user.last_access || '-'}</small>
                </div>
            </div>
        `;

        // Adiciona o evento de clique no card
        card.addEventListener("click", () => abrirModalEdicao(user.id));

        userList.appendChild(card);
    });
    } catch(err) {
        console.error(err);
        alert("Erro ao carregar usuários");
    }
}

// ==================== Abrir modal de edição ====================
function abrirModalEdicao(userId) {
    const user = usuariosLista.find(u => u.id === userId);
    if (!user) {
        alert("Usuário não encontrado!");
        return;
    }

    // Impede editar a si mesmo (exceto Dono)
    if (currentLoggedUser && currentLoggedUser.id === user.id && currentLoggedUser.role < 2) {
        alert("Você não pode editar seu próprio usuário!");
        return;
    }

    // Impede editar usuários de nível igual ou superior (exceto se for o próprio Dono editando a si mesmo)
    if (currentLoggedUser && user.role >= currentLoggedUser.role && user.id !== currentLoggedUser.id) {
        alert("Você não pode editar usuários de nível igual ou superior ao seu!");
        return;
    }

    currentUser = user;

    document.getElementById("editUsername").value = user.username;
    document.getElementById("editRole").value = user.role;
    document.getElementById("editBio").value = user.bio || '';
    document.getElementById("editUserProfile").src = user.profile_image || "/images/placeholder.png";

    // Desabilita opções de role iguais ou superiores ao usuário logado
    const roleSelect = document.getElementById("editRole");
    Array.from(roleSelect.options).forEach(option => {
        const optionRole = parseInt(option.value);
        if (currentLoggedUser && optionRole >= currentLoggedUser.role) {
            option.disabled = true;
        } else {
            option.disabled = false;
        }
    });

    const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
    editModal.show();
}

// ==================== Salvar alterações ====================
document.getElementById("saveUserBtn").addEventListener("click", async () => {
    if (!currentUser) return;

    const username = document.getElementById("editUsername").value.trim();
    const role = parseInt(document.getElementById("editRole").value);
    const bio = document.getElementById("editBio").value.trim();

    try {
        const res = await fetch(`/api/admin/users/${currentUser.id}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({ username, role, bio })
        });

        const data = await res.json();
        if(res.ok){
            alert("Usuário atualizado com sucesso!");
            await carregarUsuarios(); // atualiza lista
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
        } else {
            alert("Erro: " + data.message);
        }
    } catch(err) {
        console.error(err);
        alert("Erro ao atualizar usuário");
    }
});

// ==================== Excluir usuário ====================
document.getElementById("deleteUserBtn").addEventListener("click", async () => {
    if (!currentUser) return;
    if (!confirm("Tem certeza que deseja excluir este usuário?")) return;

    try {
        const res = await fetch(`/api/admin/users/${currentUser.id}`, {
            method: "DELETE",
            credentials: "include"
        });

        if (res.ok) {
            alert("Usuário excluído!");
            await carregarUsuarios(); // atualiza lista
            const modal = bootstrap.Modal.getInstance(document.getElementById('editUserModal'));
            modal.hide();
        } else {
            const data = await res.json();
            alert("Erro: " + data.message);
        }
    } catch(err) {
        console.error(err);
        alert("Erro ao excluir usuário");
    }
});

// ==================== Inicialização ====================
window.addEventListener("DOMContentLoaded", async () => {
    await buscarUsuarioLogado();
    carregarUsuarios();
});
</script>
