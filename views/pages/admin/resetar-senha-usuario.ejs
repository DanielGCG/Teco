<div class="container mt-5">
    <h2 class="mb-4">Resetar Senha de Usuário</h2>

    <div class="mb-3">
        <label for="selectUser" class="form-label">Selecione o usuário</label>
        <select id="selectUser" class="form-select"></select>
    </div>

    <button id="resetBtn" class="btn btn-warning w-100">Resetar senha para 12345</button>
</div>

<script>
let usuariosLista = [];
let currentLoggedUser = null;

// ==================== Buscar usuário logado ====================
async function buscarUsuarioLogado() {
    try {
        const res = await fetch('/api/users/me', { credentials: "include" });
        if (res.ok) {
            currentLoggedUser = await res.json();
        }
    } catch(err) {
        console.error("Erro ao buscar usuário logado:", err);
    }
}

// ==================== Carregar usuários ====================
async function carregarUsuarios() {
    try {
        const res = await fetch('/api/admin/users', { credentials: "include" });
        if (!res.ok) throw new Error("Erro ao carregar usuários");

        usuariosLista = await res.json();

        const select = document.getElementById("selectUser");
        select.innerHTML = "";

        usuariosLista.forEach(u => {
            // Filtrar usuários: se não for Dono, não mostrar usuários de nível igual ou superior
            if (currentLoggedUser && currentLoggedUser.roleId > 1 && u.roleId <= currentLoggedUser.roleId) {
                return; // Pula este usuário
            }

            const option = document.createElement("option");
            option.value = u.id;
            const roleNames = { 1: 'Dono', 5: 'Admin', 10: 'Mod', 11: 'Botecor', 20: 'Usuário' };
            const roleText = roleNames[u.roleId] || 'Usuário';
            option.textContent = `${u.username} (${roleText})`;
            select.appendChild(option);
        });
    } catch(err) {
        console.error(err);
        mostrarAviso("Erro ao carregar usuários");
    }
}

// ==================== Resetar senha ====================
document.getElementById("resetBtn").addEventListener("click", async () => {
    const select = document.getElementById("selectUser");
    const userId = select.value;
    if(!userId) return mostrarAviso("Selecione um usuário");

    if(!await mostrarConfirmacao("Tem certeza que deseja resetar a senha para 12345?")) return;

    try {
        const res = await fetch(`/api/admin/users/${userId}/reset-password`, {
            method: "PUT",
            credentials: "include"
        });

        const data = await res.json();
        if(res.ok){
            mostrarAviso("Senha resetada com sucesso!");
        } else {
            mostrarAviso("Erro: " + data.message);
        }
    } catch(err) {
        console.error(err);
        mostrarAviso("Erro ao resetar senha");
    }
});

// ==================== Inicialização ====================
window.addEventListener("DOMContentLoaded", async () => {
    await buscarUsuarioLogado();
    carregarUsuarios();
});
</script>

<!-- Modais necessários -->
<%- include('../../utils/modal-aviso') %>
<%- include('../../utils/modal-confirmacao') %>
