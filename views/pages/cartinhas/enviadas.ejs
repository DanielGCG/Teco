<link rel="stylesheet" href="/styles/global/cartinhas-common.css">
<link rel="stylesheet" href="/styles/cartinhas/enviadas.css">
<script src="/js/commons/cartinhas-common.js"></script>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">  
            <!-- Loading -->
            <div id="loading" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando cartas...</span>
                </div>
            </div>

            <!-- Container para as cartinhas -->
            <div id="cartinhas-container" style="display: none;">    
                <!-- Container das pilhas empilhadas -->
                <div class="container-pilhas">
                    <!-- As pilhas ser√£o inseridas aqui -->
                </div>
            </div>
            
            <!-- Mensagem quando n√£o h√° cartinhas -->
            <div id="sem-cartinhas" class="sem-cartinhas" style="display: none;">
                <div class="envelope-vazio">üì¨</div>
                <h4>Nenhuma cartinha enviada</h4>
                <p>Voc√™ ainda n√£o enviou nenhuma cartinha.<br>Quando enviar uma carta para algu√©m, ela aparecer√° aqui.</p>
                <a href="/cartinhas/escrever" class="btn btn-primary mt-3">‚úèÔ∏è Escrever Cartinha</a>
            </div>
        </div>
    </div>
</div>

<!-- Modal para visualizar cartinha completa -->
<div class="modal fade modal-carta" id="cartinhaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üì§ Cartinha Enviada</h5>
                <div class="ms-auto me-2">
                    <small class="text-muted">Atalhos: <kbd>E</kbd> Editar | <kbd>D</kbd> Excluir</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="modal-content">
                    <!-- Conte√∫do da cartinha ser√° inserido aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">üì™ Fechar</button>
                <button type="button" class="btn btn-outline-danger" id="excluir-btn">üóëÔ∏è Excluir</button>
                <button type="button" class="btn btn-outline-primary" id="editar-btn">‚úèÔ∏è Editar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar cartinha -->
<div class="modal fade" id="editarModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, var(--marrom) 0%, #7D8D86 100%); color: white;">
                <h5 class="modal-title">‚úèÔ∏è Editar Cartinha</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <form id="form-editar">
                    <input type="hidden" id="edit-cartinha-id">
                    
                    <!-- Para quem -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">üì® Para:</label>
                        <div id="edit-destinatario" class="d-flex align-items-center p-2" style="background: #f8f9fa; border-radius: 8px;">
                            <img id="edit-destinatario-profile_image" src="" alt="Avatar" style="width: 30px; height: 30px; border-radius: 50%; margin-right: 10px;">
                            <span id="edit-destinatario-nome" style="font-weight: 600; color: #3E3F29;"></span>
                        </div>
                    </div>

                    <!-- Assunto -->
                    <div class="mb-3">
                        <label for="edit-titulo" class="form-label fw-bold">üìã Assunto:</label>
                        <input type="text" class="form-control" id="edit-titulo" maxlength="40" required>
                        <div class="form-text">M√°ximo 40 caracteres. <span id="edit-contador-titulo">0/40</span></div>
                    </div>

                    <!-- Mensagem -->
                    <div class="mb-3">
                        <label for="edit-conteudo" class="form-label fw-bold">üíå Mensagem:</label>
                        <textarea class="form-control" id="edit-conteudo" rows="10" maxlength="560" required style="resize: vertical;"></textarea>
                        <div class="form-text">M√°ximo 560 caracteres. <span id="edit-contador-conteudo">0/560</span></div>
                    </div>

                    <!-- Mensagens de erro/sucesso -->
                    <div id="edit-mensagem" style="display: none;"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="salvar-edicao-btn">üíæ Salvar Altera√ß√µes</button>
            </div>
        </div>
    </div>
</div>

<script>
    async function carregarCartinhas() {
        try {
            const response = await fetch('/api/cartinhas/enviadas', {
                credentials: 'include'
            });

            if (!response.ok) {
                throw new Error(`Erro: ${response.status}`);
            }

            window.usuariosProcessados = await response.json();

            if (!Array.isArray(window.usuariosProcessados)) {
                console.error('Formato de resposta inesperado:', window.usuariosProcessados);
                window.usuariosProcessados = [];
            }

            renderizarCartinhas();
            
        } catch (error) {
            console.error('Erro ao carregar cartinhas:', error);
            window.usuariosProcessados = [];
            renderizarCartinhas();
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    }

    // ==================== Renderizar cartinhas ====================
    function renderizarCartinhas() {
        const container = document.getElementById('cartinhas-container');
        const semCartinhas = document.getElementById('sem-cartinhas');    

        if (!window.usuariosProcessados || window.usuariosProcessados.length === 0) {
            container.style.display = 'none';
            semCartinhas.style.display = 'block';
            return;
        }

        const usuariosComCartinhas = window.usuariosProcessados;

        // Ordenar por n√£o lidas e data
        usuariosComCartinhas.forEach(u => {
            u.naoLidas = u.cartinhas.filter(c => !c.lida).length;
        });

        usuariosComCartinhas.sort((a, b) => {
            if (a.naoLidas !== b.naoLidas) return b.naoLidas - a.naoLidas;
            const dataA = new Date(a.cartinhas[0]?.dataEnvio || 0);
            const dataB = new Date(b.cartinhas[0]?.dataEnvio || 0);
            return dataB - dataA;
        });

        // Usar fun√ß√£o comum para renderizar pilhas
        renderizarPilhasCartinhas(usuariosComCartinhas);
        
        container.style.display = 'block';
        semCartinhas.style.display = 'none';
    }

    // ==================== Callback para ciclar cartas (usa fun√ß√£o comum) ====================
    window.ciclarCartasCallback = function() {
        const pilhaAtiva = document.querySelector('.pilha-cartas.ativa');
        if (!pilhaAtiva) return;

        const cartas = Array.from(pilhaAtiva.querySelectorAll('.carta-empilhada'));
        if (cartas.length <= 1) return;

        const usuarioIndex = parseInt(pilhaAtiva.dataset.usuarioIndex);
        const usuario = window.usuariosProcessados[usuarioIndex];
        if (!usuario) return;

        if (!usuario.indiceCiclo) usuario.indiceCiclo = 0;
        usuario.indiceCiclo = (usuario.indiceCiclo + 1) % usuario.cartinhas.length;

        usuario.cartinhas.push(usuario.cartinhas.shift());
        cartas.forEach(carta => carta.remove());

        // Recarregar cartas da pilha
        window.carregarCartasCallback(pilhaAtiva, usuarioIndex);
    };

    // ==================== Callback para carregar cartas (espec√≠fico de enviadas) ====================
    window.carregarCartasCallback = function(pilhaElement, usuarioIndex) {
        const usuario = window.usuariosProcessados[usuarioIndex];
        if (!usuario) return;
        
        if (!usuario.indiceCiclo) usuario.indiceCiclo = 0;
        
        const totalCartas = usuario.cartinhas.length;
        const cartasParaRenderizar = usuario.cartinhas.slice(0, Math.min(3, totalCartas));
        let html = '';
        
        cartasParaRenderizar.forEach((cartinha, index) => {
            html += construirHtmlCartinha(cartinha, usuario, index, totalCartas, 'enviadas');
        });
        
        pilhaElement.insertAdjacentHTML('beforeend', html);
        pilhaElement.dataset.carregada = 'true';
        
        // Event listener para carta do topo
        const cartaTopo = pilhaElement.querySelector('.carta-empilhada.topo');
        if (cartaTopo && usuarioIndex === window.pilhaAtivaIndex) {
            cartaTopo.addEventListener('click', (e) => {
                if (!e.target.closest('.btn-acao')) {
                    const cartinhaId = parseInt(cartaTopo.dataset.cartinhaId);
                    abrirCartinha(cartinhaId);
                }
            });
        }
    };

    // ==================== Callback para abrir cartinha (espec√≠fico de enviadas) ====================
    window.abrirCartinhaCallback = function(cartinhaId) {
        abrirCartinha(cartinhaId);
    };

    function abrirCartinha(cartinhaId) {
        if (cartinhaId === null || cartinhaId === undefined || isNaN(cartinhaId)) {
            console.warn('abrirCartinha chamado com id inv√°lido:', cartinhaId);
            return;
        }
        const cartinha = encontrarCartinha(cartinhaId);
        if (!cartinha) {
            console.warn('Cartinha n√£o encontrada para id:', cartinhaId);
            return;
        }

        const usuario = encontrarUsuarioPorCartinha(cartinhaId);
        if (!usuario) {
            console.warn('Usu√°rio n√£o encontrado para cartinha id:', cartinhaId);
            return;
        }

        // Usar o modal compartilhado
        window.modalCartinha.abrir({
            tipo: 'enviadas',
            cartinha: cartinha,
            usuario: usuario,
            badges: [
                cartinha.lida ? 
                    { icone: '‚úì', texto: 'Lida pelo destinat√°rio', cor: '#27ae60', corTexto: 'white' } : 
                    { icone: '‚óã', texto: 'Ainda n√£o lida', cor: '#f39c12', corTexto: '#2d3436' }
            ],
            acoes: [
                {
                    id: 'excluir',
                    icone: 'üóëÔ∏è',
                    texto: 'Excluir',
                    classe: 'btn-outline-danger',
                    desabilitado: cartinha.lida,
                    titulo: cartinha.lida ? "N√£o √© poss√≠vel excluir cartas que j√° foram lidas" : "Excluir esta cartinha",
                    callback: (carta, user) => {
                        window.modalCartinha.fechar();
                        setTimeout(() => confirmarExclusao(carta.id), 300);
                    }
                },
                {
                    id: 'editar',
                    icone: '‚úèÔ∏è',
                    texto: 'Editar',
                    classe: 'btn-outline-primary',
                    desabilitado: cartinha.lida,
                    titulo: cartinha.lida ? "N√£o √© poss√≠vel editar cartas que j√° foram lidas" : "Editar esta cartinha",
                    callback: (carta, user) => {
                        window.modalCartinha.fechar();
                        setTimeout(() => abrirModalEdicao(carta.id), 300);
                    }
                }
            ],
            atalhosTeclado: {
                'e': {
                    callback: (carta, user) => {
                        if (!carta.lida) {
                            window.modalCartinha.fechar();
                            setTimeout(() => abrirModalEdicao(carta.id), 300);
                        }
                    }
                },
                'd': {
                    callback: (carta, user) => {
                        if (!carta.lida) {
                            window.modalCartinha.fechar();
                            setTimeout(() => confirmarExclusao(carta.id), 300);
                        }
                    }
                }
            }
        });
    }

    // ==================== Fun√ß√µes de edi√ß√£o ====================
    function abrirModalEdicao(cartinhaId) {
        const cartinha = encontrarCartinha(cartinhaId);
        const usuario = encontrarUsuarioPorCartinha(cartinhaId);
        
        if (!cartinha || !usuario) return;
        
        document.getElementById('edit-cartinha-id').value = cartinhaId;
        document.getElementById('edit-destinatario-avatar').src = usuario.profile_image;
        document.getElementById('edit-destinatario-nome').textContent = usuario.username;
        document.getElementById('edit-titulo').value = cartinha.titulo;
        document.getElementById('edit-conteudo').value = cartinha.conteudo;
        
        atualizarContadores();
        
        const editarModal = new bootstrap.Modal(document.getElementById('editarModal'));
        editarModal.show();
    }

    function atualizarContadores() {
        const titulo = document.getElementById('edit-titulo');
        const conteudo = document.getElementById('edit-conteudo');
        
        document.getElementById('edit-contador-titulo').textContent = `${titulo.value.length}/40`;
        document.getElementById('edit-contador-conteudo').textContent = `${conteudo.value.length}/560`;
    }

    async function salvarEdicao() {
        const cartinhaId = document.getElementById('edit-cartinha-id').value;
        const titulo = document.getElementById('edit-titulo').value.trim();
        const conteudo = document.getElementById('edit-conteudo').value.trim();
        
        if (!titulo || !conteudo) {
            mostrarMensagem('T√≠tulo e conte√∫do s√£o obrigat√≥rios', 'danger');
            return;
        }
        
        const salvarBtn = document.getElementById('salvar-edicao-btn');
        const originalText = salvarBtn.innerHTML;
        salvarBtn.disabled = true;
        salvarBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Salvando...';
        
        try {
            const response = await fetch(`/api/cartinhas/${cartinhaId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({ titulo, conteudo })
            });
            
            const result = await response.json();
            
            if (response.ok) {
                const cartinha = encontrarCartinha(parseInt(cartinhaId));
                if (cartinha) {
                    cartinha.titulo = titulo;
                    cartinha.conteudo = conteudo;
                }
                
                const cartaElement = document.getElementById(`carta-${cartinhaId}`);
                if (cartaElement) {
                    const tituloElement = cartaElement.querySelector('.titulo-carta');
                    const conteudoElement = cartaElement.querySelector('.conteudo-carta');
                    if (tituloElement) tituloElement.textContent = titulo;
                    if (conteudoElement) conteudoElement.textContent = cortarTexto(conteudo, 120);
                }
                
                const editarModal = bootstrap.Modal.getInstance(document.getElementById('editarModal'));
                editarModal.hide();
                
                mostrarFeedback(result.message, 'success');
            } else {
                mostrarMensagem(result.message, 'danger');
                salvarBtn.disabled = false;
                salvarBtn.innerHTML = originalText;
            }
        } catch (error) {
            console.error('Erro ao editar cartinha:', error);
            mostrarMensagem('Erro ao salvar altera√ß√µes', 'danger');
            salvarBtn.disabled = false;
            salvarBtn.innerHTML = originalText;
        }
    }

    function mostrarMensagem(texto, tipo) {
        const mensagem = document.getElementById('edit-mensagem');
        mensagem.className = `alert alert-${tipo}`;
        mensagem.textContent = texto;
        mensagem.style.display = 'block';
        
        setTimeout(() => {
            mensagem.style.display = 'none';
        }, 5000);
    }

    // ==================== Fun√ß√£o de exclus√£o ====================
    function confirmarExclusao(cartinhaId) {
        let confirmationModal = document.getElementById('confirmDeleteModal');
        
        if (!confirmationModal) {
            const modalHtml = `
                <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-danger text-white">
                                <h5 class="modal-title">‚ö†Ô∏è Confirmar exclus√£o</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                            </div>
                            <div class="modal-body">
                                <p>Tem certeza que deseja <strong>excluir permanentemente</strong> esta cartinha?</p>
                                <div class="alert alert-warning" role="alert">
                                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                    Esta a√ß√£o n√£o pode ser desfeita!
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                                    Excluir permanentemente
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            confirmationModal = document.getElementById('confirmDeleteModal');
        }
        
        const confirmBtn = confirmationModal.querySelector('#confirmDeleteBtn');
        confirmBtn.onclick = () => excluirCartinha(cartinhaId);
        
        const modal = new bootstrap.Modal(confirmationModal);
        modal.show();
    }

    async function excluirCartinha(cartinhaId) {
        try {
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            const originalText = confirmBtn.innerHTML;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2"></span>Excluindo...`;
            
            const response = await fetch(`/api/cartinhas/${cartinhaId}`, {
                method: 'DELETE',
                credentials: 'include'
            });

            if (response.ok) {
                const result = await response.json();
                
                const confirmationModal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
                confirmationModal.hide();
                
                const cartinha = encontrarCartinha(cartinhaId);
                const usuario = encontrarUsuarioPorCartinha(cartinhaId);
                
                if (usuario && cartinha) {
                    const index = usuario.cartinhas.findIndex(c => c.id === cartinhaId);
                    if (index !== -1) {
                        usuario.cartinhas.splice(index, 1);
                    }
                    
                    const cartaElement = document.getElementById(`carta-${cartinhaId}`);
                    if (cartaElement) {
                        cartaElement.remove();
                    }
                    
                    if (usuario.cartinhas.length === 0) {
                        const userIndex = window.usuariosProcessados.findIndex(u => u.userId === usuario.userId);
                        if (userIndex !== -1) {
                            window.usuariosProcessados.splice(userIndex, 1);
                        }
                        
                        const pilha = document.getElementById(`pilha-${usuario.userId}`);
                        if (pilha) {
                            pilha.remove();
                        }
                        
                        if (window.usuariosProcessados.length === 0) {
                            const container = document.getElementById('cartinhas-container');
                            const semCartinhas = document.getElementById('sem-cartinhas');
                            container.style.display = 'none';
                            semCartinhas.style.display = 'block';
                        }
                    }
                    
                    mostrarFeedback(result.message || "Cartinha exclu√≠da com sucesso!", "success");
                }
            } else {
                const result = await response.json();
                mostrarFeedback(result.message || "Erro ao excluir cartinha", "danger");
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = originalText;
            }
        } catch (error) {
            console.error('Erro ao excluir cartinha:', error);
            mostrarFeedback("Erro ao excluir cartinha. Por favor, tente novamente.", "danger");
            
            const confirmBtn = document.getElementById('confirmDeleteBtn');
            if (confirmBtn) {
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = "Excluir permanentemente";
            }
        }
    }

    // ==================== Inicializa√ß√£o ====================
    document.addEventListener('DOMContentLoaded', () => {
        carregarCartinhas();
        
        // Usar fun√ß√£o comum de navega√ß√£o por teclado
        inicializarNavegacaoTeclado({
            modal: (e, modalAberto) => {
                if (modalAberto.id === 'cartinhaModal') {
                    if (e.key === 'e' || e.key === 'E') {
                        e.preventDefault();
                        const editarBtn = document.getElementById('editar-btn');
                        if (editarBtn && !editarBtn.disabled) editarBtn.click();
                    }
                    if (e.key === 'd' || e.key === 'D') {
                        e.preventDefault();
                        const excluirBtn = document.getElementById('excluir-btn');
                        if (excluirBtn && !excluirBtn.disabled) excluirBtn.click();
                    }
                }
            }
        });
        
        // Eventos do modal de edi√ß√£o
        document.getElementById('edit-titulo').addEventListener('input', atualizarContadores);
        document.getElementById('edit-conteudo').addEventListener('input', atualizarContadores);
        document.getElementById('salvar-edicao-btn').addEventListener('click', salvarEdicao);
    });
</script>


