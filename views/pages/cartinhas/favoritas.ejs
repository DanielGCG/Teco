<link rel="stylesheet" href="/styles/cartinhas/cartinhas-modals.css">
<script src="/js/commons/cartinhas-common.js"></script>

<div class="container mt-4">
    <div class="mb-3">
        <a href="/cartinhas" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar ao Menu
        </a>
    </div>
    <div class="row">
        <div class="col-12">  
            <div id="loading" class="loading-spinner">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">Carregando favoritas...</span>
                </div>
            </div>

            <div id="cartinhas-container" style="display: none;">
                <div class="container-pilhas"></div>
            </div>

            <div id="sem-cartinhas" class="sem-cartinhas" style="display: none;">
                <div class="envelope-vazio">‚≠ê</div>
                <h4>Nenhuma cartinha favoritada</h4>
                <p>Voc√™ ainda n√£o tem cartinhas favoritas. Quando receber cartinhas especiais, favorite-as para guard√°-las aqui!</p>
            </div>
        </div>
    </div>
</div>

<script>
// Configura√ß√£o do tipo de cartinhas
window.tipoCartinhas = 'favoritas';

// Dados locais da p√°gina
let usuariosProcessados = [];

// ==================== CARREGAR CARTINHAS FAVORITAS ====================
async function carregarCartinhasFavoritas() {
    try {
        const response = await fetch('/api/cartinhas/favoritas', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Erro ao carregar cartinhas favoritas');

        const cartinhasFavoritas = await response.json();
        
        // Processar dados para o formato esperado
        const usuariosAgrupados = {};
        
        cartinhasFavoritas.forEach(cartinha => {
            const remetenteId = cartinha.remetente ? cartinha.remetente.id : (cartinha.senderUserId || 'desconhecido');
            const username = cartinha.remetente ? cartinha.remetente.username : 'Desconhecido';
            const profileimage = cartinha.remetente ? cartinha.remetente.profileimage : '/images/default-avatar.png';
            
            if (!usuariosAgrupados[remetenteId]) {
                usuariosAgrupados[remetenteId] = {
                    userId: remetenteId,
                    username: username,
                    profileimage: profileimage,
                    cartinhas: []
                };
            }
            
            usuariosAgrupados[remetenteId].cartinhas.push(cartinha);
        });
        
        usuariosProcessados = Object.values(usuariosAgrupados);

        if (!Array.isArray(usuariosProcessados)) {
            throw new Error('Resposta inv√°lida da API');
        }

        // Hooks para integra√ß√£o com o common
        const hooks = {
            abrirCartinha: (cartinhaId) => {
                const cartinha = encontrarCartinha(cartinhaId, usuariosProcessados);
                if (!cartinha) return;

                const usuario = encontrarUsuarioPorCartinha(cartinhaId, usuariosProcessados);
                if (!usuario) return;

                window.modalCartinha.abrir({
                    cartinha: cartinha,
                    usuario: usuario,
                    tipo: 'favoritas',
                    titulo: '‚≠ê Cartinha Favorita',
                    badges: [
                        { icone: '‚≠ê', texto: 'Favorita', cor: '#fbbf24' }
                    ],
                    acoes: [
                        {
                            id: 'responder',
                            label: 'üíå Responder',
                            classe: 'btn-primary',
                            atalho: 'R',
                            callback: () => responderCartinha(usuario.userId, usuario.username)
                        },
                        {
                            id: 'desfavoritar',
                            label: '‚≠ê Desfavoritar',
                            classe: 'btn-warning',
                            atalho: 'D',
                            callback: () => confirmarDesfavoritar(cartinhaId)
                        },
                        {
                            id: 'excluir',
                            label: 'üóëÔ∏è Excluir',
                            classe: 'btn-danger',
                            atalho: 'X',
                            callback: () => confirmarExclusao(cartinhaId)
                        }
                    ]
                });
            }
        };

        // Usa fun√ß√µes gen√©ricas do common
        renderizarCartinhas(usuariosProcessados, hooks);
        inicializarNavegacaoCartinhas(usuariosProcessados, hooks);
        
    } catch (error) {
        console.error('Erro ao carregar cartinhas favoritas:', error);
        usuariosProcessados = [];
        renderizarCartinhas([]);
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

// ==================== RESPONDER ====================
function responderCartinha(userId, username) {
    window.modalCartinha.fechar();
    window.location.href = `/cartinhas/escrever?para=${userId}&nome=${encodeURIComponent(username)}`;
}

// ==================== DESFAVORITAR ====================
async function confirmarDesfavoritar(cartinhaId) {
    window.modalCartinha.fechar();

    const cartinha = encontrarCartinha(cartinhaId, usuariosProcessados);
    const dataEnvio = cartinha ? new Date(cartinha.createdat) : null;
    const agora = new Date();
    const diffMs = agora - dataEnvio;
    const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const riscoExclusao = diffDias >= 30;

    const mensagem = riscoExclusao
        ? '‚ö†Ô∏è Esta cartinha tem mais de 30 dias e pode ser exclu√≠da automaticamente se desfavoritada.\n\nTem certeza que deseja desfavoritar?'
        : 'Tem certeza que deseja remover esta cartinha dos favoritos?';

    try {
        const confirmado = await mostrarConfirmacao(mensagem, 'Confirmar Desfavoritar');
        if (!confirmado) return;

        await desfavoritarCartinha(cartinhaId);
    } catch (err) {
        console.error('Erro na confirma√ß√£o de desfavoritar:', err);
    }
}

async function desfavoritarCartinha(cartinhaId) {
    try {
        await toggleFavoritoCommon(cartinhaId, usuariosProcessados);
        
        // Remover da lista local ap√≥s desfavoritar
        for (let usuario of usuariosProcessados) {
            const index = usuario.cartinhas.findIndex(c => c.id == cartinhaId);
            if (index !== -1) {
                usuario.cartinhas.splice(index, 1);
                if (usuario.cartinhas.length === 0) {
                    const usuarioIndex = usuariosProcessados.indexOf(usuario);
                    usuariosProcessados.splice(usuarioIndex, 1);
                }
                break;
            }
        }
        
        // Re-renderizar
        renderizarCartinhas(usuariosProcessados);
    } catch (error) {
        console.error('Erro ao desfavoritar:', error);
    }
}

// ==================== EXCLUIR ====================
function confirmarExclusao(cartinhaId) {
    window.modalCartinha.fechar();
    
    if (confirm('‚ö†Ô∏è Tem certeza que deseja excluir permanentemente esta cartinha?\n\nEsta a√ß√£o n√£o pode ser desfeita!')) {
        excluirCartinha(cartinhaId);
    }
}

async function excluirCartinha(cartinhaId) {
    try {
        const response = await fetch(`/api/cartinhas/${cartinhaId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Erro ao excluir');

        // Remover da lista local
        for (let usuario of usuariosProcessados) {
            const index = usuario.cartinhas.findIndex(c => c.id == cartinhaId);
            if (index !== -1) {
                usuario.cartinhas.splice(index, 1);
                if (usuario.cartinhas.length === 0) {
                    const usuarioIndex = usuariosProcessados.indexOf(usuario);
                    usuariosProcessados.splice(usuarioIndex, 1);
                }
                break;
            }
        }

        // Re-renderizar
        renderizarCartinhas(usuariosProcessados);
        mostrarFeedback('üóëÔ∏è Cartinha exclu√≠da com sucesso!', 'success');
        
    } catch (error) {
        console.error('Erro ao excluir cartinha:', error);
        mostrarFeedback('Erro ao excluir cartinha. Tente novamente.', 'danger');
    }
}

// ==================== INICIALIZA√á√ÉO ====================
document.addEventListener('DOMContentLoaded', () => {
    carregarCartinhasFavoritas();
    
    // Focar na primeira pilha
    setTimeout(() => {
        const primeiraPilha = document.querySelector('.pilha-cartas.ativa');
        if (primeiraPilha) primeiraPilha.focus();
    }, 500);
});
</script>

<%- include('../../utils/modal-confirmacao') %>