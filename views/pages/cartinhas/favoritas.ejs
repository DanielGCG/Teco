<link rel="stylesheet" href="/styles/cartinhas/cartinhas-modals.css">
<script src="/js/commons/cartinhas-common.js"></script>

<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 fw-bold mb-0">Mensagens Favoritas</h2>
        <a href="/cartinhas" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar ao Menu
        </a>
    </div>

    <div class="row">
        <div class="col-12">  
            <div id="loading" class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
            </div>

            <div id="cartinhas-container" style="display: none;">
                <div id="cartas-grid"></div>
            </div>

            <div id="sem-cartinhas" class="text-center py-5" style="display: none;">
                <div class="display-1 text-muted mb-3"><i class="bi bi-star"></i></div>
                <h4>Nenhuma cartinha favoritada</h4>
                <p class="text-muted">Você ainda não tem mensagens guardadas como favoritas.</p>
            </div>
        </div>
    </div>
</div>

<script>
// Configuração do tipo de cartinhas
window.tipoCartinhas = 'favoritas';

// Dados locais da página
let usuariosProcessados = [];

// ==================== CARREGAR CARTINHAS FAVORITAS ====================
async function carregarCartinhas() {
    const loading = document.getElementById('loading');
    const container = document.getElementById('cartinhas-container');

    try {
        const response = await fetch('/api/cartinhas/favoritas', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Erro ao carregar cartinhas favoritas');

        const cartinhasFavoritas = await response.json();
        
        // Processar dados para o formato esperado
        const usuariosAgrupados = {};
        
        cartinhasFavoritas.forEach(cartinha => {
            const remetenteId = cartinha.remetente ? cartinha.remetente.publicid : (cartinha.senderPublicId || 'desconhecido');
            const username = cartinha.remetente ? cartinha.remetente.username : 'Desconhecido';
            const profileimage = cartinha.remetente ? cartinha.remetente.profileimage : '/images/default-avatar.png';
            
            if (!usuariosAgrupados[remetenteId]) {
                usuariosAgrupados[remetenteId] = {
                    userId: remetenteId,
                    username: username,
                    profileimage: profileimage,
                    cartinhas: []
                };
            }
            
            usuariosAgrupados[remetenteId].cartinhas.push(cartinha);
        });
        
        usuariosProcessados = Object.values(usuariosAgrupados);
        loading.style.display = 'none';

        // Hooks para integração com o common
        const hooks = {
            abrirCartinha: (cartinhaId) => {
                const cartinha = encontrarCartinha(cartinhaId, usuariosProcessados);
                if (!cartinha) return;

                const usuario = encontrarUsuarioPorCartinha(cartinhaId, usuariosProcessados);
                if (!usuario) return;

                window.modalCartinha.abrir({
                    cartinha: cartinha,
                    usuario: usuario,
                    tipo: 'favoritas',
                    titulo: 'Cartinha Favorita',
                    badges: [
                        { texto: 'Favorita', cor: '#ffc107', corTexto: '#000' }
                    ],
                    acoes: [
                        {
                            id: 'responder',
                            label: 'Responder',
                            classe: 'btn-primary',
                            callback: () => responderCartinha(usuario.userId, usuario.username)
                        },
                        {
                            id: 'desfavoritar',
                            label: 'Desfavoritar',
                            classe: 'btn-warning',
                            callback: () => confirmarDesfavoritar(cartinhaId)
                        },
                        {
                            id: 'excluir',
                            label: 'Excluir',
                            classe: 'btn-danger',
                            callback: () => confirmarExclusao(cartinhaId)
                        }
                    ]
                });
            }
        };

        renderizarGridCartinhas(usuariosProcessados, '#cartas-grid', hooks);
        
    } catch (error) {
        console.error('Erro ao carregar cartinhas:', error);
        loading.innerHTML = '<div class="alert alert-danger">Erro ao carregar favoritas.</div>';
    }
}

// ==================== RESPONDER ====================
function responderCartinha(userId, username) {
    window.modalCartinha.fechar();
    window.location.href = `/cartinhas/escrever?para=${userId}&nome=${encodeURIComponent(username)}`;
}

// ==================== DESFAVORITAR ====================
async function confirmarDesfavoritar(cartinhaId) {
    window.modalCartinha.fechar();

    const cartinha = encontrarCartinha(cartinhaId, usuariosProcessados);
    const dataEnvio = cartinha ? new Date(cartinha.createdat) : null;
    const agora = new Date();
    const diffMs = agora - dataEnvio;
    const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const riscoExclusao = diffDias >= 30;

    const mensagem = riscoExclusao
        ? 'Esta cartinha tem mais de 30 dias e pode ser excluída automaticamente se desfavoritada.\n\nTem certeza que deseja desfavoritar?'
        : 'Tem certeza que deseja remover esta cartinha dos favoritos?';

    try {
        const confirmado = await mostrarConfirmacao(mensagem, 'Confirmar Desfavoritar');
        if (!confirmado) return;

        await desfavoritarCartinha(cartinhaId);
    } catch (err) {
        console.error('Erro na confirmação de desfavoritar:', err);
    }
}

async function desfavoritarCartinha(cartinhaId) {
    try {
        await toggleFavoritoCommon(cartinhaId, usuariosProcessados);
        
        // Remover da lista local após desfavoritar
        for (let usuario of usuariosProcessados) {
            const index = usuario.cartinhas.findIndex(c => c.publicid == cartinhaId);
            if (index !== -1) {
                usuario.cartinhas.splice(index, 1);
                if (usuario.cartinhas.length === 0) {
                    const usuarioIndex = usuariosProcessados.indexOf(usuario);
                    usuariosProcessados.splice(usuarioIndex, 1);
                }
                break;
            }
        }
        
        // Re-renderizar
        carregarCartinhas();
    } catch (error) {
        console.error('Erro ao desfavoritar:', error);
    }
}

// ==================== EXCLUIR ====================
async function confirmarExclusao(cartinhaId) {
    window.modalCartinha.fechar();
    
    const confirmado = await mostrarConfirmacao(
        'Tem certeza que deseja excluir permanentemente esta cartinha?\n\nEsta ação não pode ser desfeita!',
        'Confirmar Exclusão'
    );

    if (confirmado) {
        excluirCartinha(cartinhaId);
    }
}

async function excluirCartinha(cartinhaId) {
    try {
        const response = await fetch(`/api/cartinhas/${cartinhaId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Erro ao excluir');

        // Re-renderizar
        carregarCartinhas();
        mostrarFeedback('Cartinha excluída com sucesso!', 'success');
        
    } catch (error) {
        console.error('Erro ao excluir cartinha:', error);
        mostrarFeedback('Erro ao excluir cartinha. Tente novamente.', 'danger');
    }
}

// ==================== INICIALIZAÇÃO ====================
document.addEventListener('DOMContentLoaded', () => {
    carregarCartinhas();
});
</script>

<%- include('../../utils/modal-confirmacao') %>