<link rel="stylesheet" href="/styles/cartinhas-common.css">
<link rel="stylesheet" href="/styles/favoritas.css">
<script src="/js/cartinhas-common.js"></script>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Loading -->
            <div id="loading" class="loading-spinner">
                <div class="spinner-border text-warning" role="status">
                    <span class="visually-hidden">Carregando favoritas...</span>
                </div>
            </div>

            <!-- Container para as cartinhas favoritas -->
            <div id="cartinhas-container" style="display: none;">    
                <!-- Container das pilhas empilhadas -->
                <div class="container-pilhas">
                    <!-- As pilhas ser√£o inseridas aqui -->
                </div>
            </div>
            
            <!-- Mensagem quando n√£o h√° cartinhas favoritas -->
            <div id="sem-cartinhas" class="sem-cartinhas" style="display: none;">
                <div class="envelope-vazio">‚≠ê</div>
                <h4>Nenhuma cartinha favoritada</h4>
                <p>Voc√™ ainda n√£o tem cartinhas favoritas.<br>Quando receber cartinhas especiais, favorite-as para guard√°-las aqui!</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal para visualizar cartinha favorita completa -->
<div class="modal fade modal-carta" id="cartinhaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚≠ê Cartinha Favorita</h5>
                <div class="ms-auto me-2">
                    <small class="text-muted">Atalhos: <kbd>D</kbd> Desfavoritar | <kbd>R</kbd> Responder | <kbd>X</kbd> Excluir</small>
                </div>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
            </div>
            <div class="modal-body">
                <div id="modal-content">
                    <!-- Conte√∫do da cartinha ser√° inserido aqui -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-danger" id="excluir-btn">üóëÔ∏è Excluir</button>
                <button type="button" class="btn btn-outline-warning" id="desfavoritar-btn">üíî Desfavoritar</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">üì™ Fechar</button>
                <button type="button" class="btn btn-primary" id="responder-btn">‚úâÔ∏è Responder</button>
            </div>
        </div>
    </div>
</div>

<script>
// Vari√°veis globais
let cartinhasFavoritasData = [];

// Vari√°veis de controle de estado para modais
window.cartinhaDesfavoritada = false;
window.cartinhaExcluida = false;

// ==================== Carregar cartinhas favoritas ====================
async function carregarCartinhasFavoritas() {
    try {
        const response = await fetch('/api/cartinhas/favoritas', {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`Erro: ${response.status}`);
        }

        // Obter as cartinhas favoritas da API
        const cartinhasFavoritas = await response.json();
        
        // Processar dados para o formato esperado pela interface
        // A API retorna um formato diferente do que nosso frontend espera
        const usuariosAgrupados = {};
        
        // Agrupar cartinhas por usu√°rio/remetente
        cartinhasFavoritas.forEach(cartinha => {
            const userId = cartinha.remetente_id;
            const username = cartinha.remetente_username;
            const avatar = cartinha.remetente_avatar;
            
            // Se ainda n√£o temos este usu√°rio no objeto agrupado, criar entrada
            if (!usuariosAgrupados[userId]) {
                usuariosAgrupados[userId] = {
                    userId: userId,
                    username: username,
                    avatar: avatar,
                    cartinhas: []
                };
            }
            
            // Adicionar cartinha √† lista do usu√°rio correspondente
            usuariosAgrupados[userId].cartinhas.push({
                id: cartinha.id,
                titulo: cartinha.titulo,
                conteudo: cartinha.conteudo,
                dataEnvio: cartinha.data_envio,
                dataFavoritada: cartinha.data_favoritada,
                lida: cartinha.lida || true // Assumimos que uma cartinha favoritada foi lida
            });
        });
        
        // Converter o objeto em array para uso na interface
        cartinhasFavoritasData = Object.values(usuariosAgrupados);
        renderizarCartinhasFavoritas();
        
    } catch (error) {
        console.error('Erro ao carregar cartinhas favoritas:', error);
        
        // Dados simulados para demonstra√ß√£o em caso de erro
        // Em produ√ß√£o, voc√™ pode querer mostrar uma mensagem de erro em vez disso
        cartinhasFavoritasData = [
            {
                userId: 1,
                username: '@joao123',
                avatar: '/images/placeholder.png',
                cartinhas: [
                    {
                        id: 1,
                        titulo: 'Parab√©ns pelo anivers√°rio! üéâ',
                        conteudo: 'Oi querido amigo! Espero que seu dia especial seja repleto de alegria, sorrisos e momentos inesquec√≠veis. Voc√™ merece todas as coisas boas da vida!',
                        dataEnvio: '2025-09-15T09:30:00Z',
                        dataFavoritada: '2025-09-15T10:00:00Z',
                        lida: true
                    }
                ]
            }
        ];
        
        mostrarFeedback('Erro ao carregar cartinhas favoritas. Usando dados de demonstra√ß√£o.', 'danger');
        renderizarCartinhasFavoritas();
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

// ==================== Renderizar cartinhas favoritas ====================
function renderizarCartinhasFavoritas() {
    const container = document.getElementById('cartinhas-container');
    const semCartinhas = document.getElementById('sem-cartinhas');    

    // Verificar se h√° cartinhas para exibir
    if (!Array.isArray(cartinhasFavoritasData) || cartinhasFavoritasData.length === 0) {
        container.style.display = 'none';
        semCartinhas.style.display = 'block';
        return;
    }

    // Filtrar usu√°rios que t√™m pelo menos uma cartinha
    const usuariosComCartinhasValidas = cartinhasFavoritasData.filter(
        usuario => Array.isArray(usuario.cartinhas) && usuario.cartinhas.length > 0
    );
    
    if (usuariosComCartinhasValidas.length === 0) {
        container.style.display = 'none';
        semCartinhas.style.display = 'block';
        return;
    }

    // Agrupar cartinhas por usu√°rio
    const usuariosComCartinhas = usuariosComCartinhasValidas.map(usuario => {
        return {
            ...usuario,
            cartinhas: usuario.cartinhas.sort((a, b) => {
                // Ordenar por data de favoritada (mais recente primeiro)
                return new Date(b.dataFavoritada || 0) - new Date(a.dataFavoritada || 0);
            })
        };
    });

    // Ordenar usu√°rios por data da cartinha favoritada mais recente
    usuariosComCartinhas.sort((a, b) => {
        const dataA = new Date(a.cartinhas[0]?.dataFavoritada || 0);
        const dataB = new Date(b.cartinhas[0]?.dataFavoritada || 0);
        return dataB - dataA;
    });

    // Armazenar dados processados globalmente para uso posterior
    window.usuariosProcessados = usuariosComCartinhas;
    
    // Renderizar apenas estrutura b√°sica das pilhas (lazy loading)
    const containerPilhas = container.querySelector('.container-pilhas');
    let html = '';

    usuariosComCartinhas.forEach((usuario, usuarioIndex) => {
        const totalCartinhas = usuario.cartinhas.length;
        const cartinhaMaisRecente = usuario.cartinhas[0];
        
        html += `
            <div class="pilha-cartas" 
                 data-usuario-index="${usuarioIndex}" 
                 data-carregada="false">
                
                <!-- Contador de cartinhas favoritas na pilha -->
                <div class="contador-pilha">
                    ${totalCartinhas}
                </div>
                
                <!-- Instru√ß√µes para a pilha ativa -->
                <div class="instrucoes-pilha">
                    <span>üëÜ Clique para ler ‚Ä¢ ‚Üê‚Üí Ciclar cartas ‚Ä¢ ‚¨ÜÔ∏è‚¨áÔ∏è Trocar usu√°rio</span>
                </div>
                
                <!-- As cartas ser√£o carregadas aqui sob demanda -->
            </div>
        `;
    });

    containerPilhas.innerHTML = html;
    container.style.display = 'block';
    semCartinhas.style.display = 'none';
    
    // Definir pilha ativa global
    window.pilhaAtivaIndex = 0;
    window.totalPilhas = usuariosComCartinhas.length;
    
    // Aplicar classes de posicionamento √†s pilhas
    const pilhas = Array.from(document.querySelectorAll('.pilha-cartas'));
    pilhas.forEach((pilha, index) => {
        if (index === 0) {
            pilha.classList.add('ativa');
        } else if (index === 1) {
            pilha.classList.add('segunda');
        } else if (index === 2) {
            pilha.classList.add('terceira');
        } else if (index === 3) {
            pilha.classList.add('quarta');
        } else {
            pilha.classList.add('fundo');
        }
    });
    
    // Renderizar apenas as pilhas vis√≠veis inicialmente
    renderizarPilhasVisiveis();
}

// ==================== Callbacks espec√≠ficos de FAVORITAS ====================
window.ciclarCartasCallback = function() {
    const pilhaAtiva = document.querySelector('.pilha-cartas.ativa');
    if (!pilhaAtiva) return;

    const cartas = Array.from(pilhaAtiva.querySelectorAll('.carta-empilhada'));
    if (cartas.length <= 1) return;

    // Obter dados do usu√°rio e da pilha
    const usuarioIndex = parseInt(pilhaAtiva.dataset.usuarioIndex);
    const usuario = window.usuariosProcessados[usuarioIndex];
    if (!usuario) return;

    // Inicializar ou incrementar o √≠ndice de ciclo para este usu√°rio
    if (!usuario.indiceCiclo) usuario.indiceCiclo = 0;
    usuario.indiceCiclo = (usuario.indiceCiclo + 1) % usuario.cartinhas.length;

    // Ciclar array de cartas: mover a primeira para o final
    usuario.cartinhas.push(usuario.cartinhas.shift());

    // Remover todas as cartas do DOM
    cartas.forEach(carta => carta.remove());

    // Renderizar as 3 cartas corretas
    for (let i = 0; i < Math.min(3, usuario.cartinhas.length); i++) {
        const cartinha = usuario.cartinhas[i];
        let posicaoClasse = '';
        let zIndex = 10;
        
        if (i === 0) {
            posicaoClasse = 'topo';
            zIndex = 10;
        } else if (i === 1) {
            posicaoClasse = 'meio';
            zIndex = 5;
        } else {
            posicaoClasse = 'fundo';
            zIndex = 1;
        }
        
        const novaCartaHTML = `
            <div class="carta-empilhada ${posicaoClasse}" 
                 id="carta-${cartinha.id}" 
                 style="z-index: ${zIndex};"
                 onclick="abrirCartinhaFavorita(${cartinha.id})">
                
                <div class="carta-envelope">
                    <div class="envelope-flap"></div>
                    <div class="selo favorita">‚≠ê</div>
                    
                    <div class="envelope-header">
                        <div class="remetente-info">
                            <img src="${usuario.avatar}" alt="${usuario.username}" class="avatar-carta">
                            <div>
                                <h6 class="mb-1">${usuario.username}</h6>
                                <small class="text-muted">Favoritada ${formatarData(cartinha.dataFavoritada)}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cartinha-papel">
                        <div class="papel-linhas">
                            <h5 class="titulo-carta">${cartinha.titulo}</h5>
                            <p class="conteudo-carta">${cortarTexto(cartinha.conteudo, 120)}</p>
                            <div class="data-carta">${formatarData(cartinha.dataEnvio)}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Bot√µes de a√ß√£o -->
                <div class="acoes-carta">
                    <button class="btn-acao btn-ler" onclick="event.stopPropagation(); abrirCartinhaFavorita(${cartinha.id})" title="Ver carta">
                        üëÅÔ∏è
                    </button>
                </div>
            </div>
        `;
        
        pilhaAtiva.insertAdjacentHTML('beforeend', novaCartaHTML);
    }
};

// ==================== lerCartaAtiva (usa comum) ====================
function lerCartaAtiva() {
    const pilhaAtiva = document.querySelector('.pilha-cartas.ativa');
    if (!pilhaAtiva) return;
    
    const cartaTopo = pilhaAtiva.querySelector('.carta-empilhada.topo');
    if (cartaTopo) {
        const cartinhaId = cartaTopo.id.replace('carta-', '');
        abrirCartinhaFavorita(parseInt(cartinhaId));
    }
}

// ==================== Abrir cartinha favorita no modal ====================
function abrirCartinhaFavorita(cartinhaId) {
    try {
        const cartinha = encontrarCartinhaFavorita(cartinhaId);
        if (!cartinha) {
            mostrarFeedback(`Cartinha com ID ${cartinhaId} n√£o encontrada.`, 'danger');
            return;
        }
    
        const usuario = encontrarUsuarioPorCartinhaFavorita(cartinhaId);
        if (!usuario) {
            mostrarFeedback('N√£o foi poss√≠vel encontrar informa√ß√µes do remetente.', 'danger');
            return;
        }
        
        // Verificar se a carta est√° no DOM e carreg√°-la se necess√°rio
        const cartaElement = document.getElementById(`carta-${cartinhaId}`);
        if (!cartaElement) {
            carregarCartaEspecifica(usuario.userId, cartinhaId);
        }
        
        const modalContent = document.getElementById('modal-content');
        modalContent.innerHTML = `
        <div class="mb-3">
            <!-- Cabe√ßalho da carta -->
            <div class="d-flex align-items-center mb-3 p-2" style="background: #f8f9fa; border-radius: 8px; border-left: 4px solid #f1c40f;">
                <img src="${usuario.avatar}" alt="Avatar" class="avatar-carta me-2" style="width: 35px; height: 35px;">
                <div>
                    <strong style="font-size: 1rem; color: #2d3436;">${usuario.username}</strong>
                    <div>
                        <small class="text-muted">
                            üìÖ ${formatarData(cartinha.dataEnvio)} ‚Ä¢ 
                            ‚≠ê Favoritada em ${formatarData(cartinha.dataFavoritada)}
                        </small>
                    </div>
                </div>
                <div class="ms-auto">
                    <span class="badge" style="background: #f1c40f; color: #2d3436; font-size: 0.75rem;">‚≠ê Favorita</span>
                </div>
            </div>
        </div>
        
        <!-- Papel da carta com linhas -->
        <div style="background: #fefefe; padding: 1.5rem; border-radius: 8px; box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05); position: relative; background-image: repeating-linear-gradient(transparent, transparent 1.4rem, rgba(0,0,0,0.03) 1.4rem, rgba(0,0,0,0.03) 1.5rem);">
            <!-- Linha lateral do papel -->
            <div style="position: absolute; left: 1.5rem; top: 0; bottom: 0; width: 2px; background: linear-gradient(to bottom, #e9ecef 0%, #f1c40f 50%, #e9ecef 100%);"></div>
            
            <!-- T√≠tulo da carta -->
            <h3 style="font-family: 'Montserrat', sans-serif; color: #2d3436; margin-bottom: 1rem; padding-left: 1rem; font-weight: 600; font-size: 1.1rem;">
                ${cartinha.titulo}
            </h3>
            
            <!-- Conte√∫do da carta -->
            <div style="font-family: 'Montserrat', sans-serif; font-size: 0.95rem; line-height: 1.6; color: #636e72; padding-left: 1rem; white-space: pre-wrap;">
                ${cartinha.conteudo}
            </div>
            
            <!-- Assinatura -->
            <div style="text-align: right; margin-top: 1.5rem; padding-right: 1rem; font-style: italic; color: #74b9ff; font-size: 0.9rem;">
                Com carinho,<br>
                <strong>${usuario.username}</strong>
            </div>
        </div>
        `;
    
        // Configurar bot√£o de responder
        const responderBtn = document.getElementById('responder-btn');
        responderBtn.onclick = () => responderCartinha(usuario.userId, usuario.username);
        
        // Configurar bot√£o de excluir
        const excluirBtn = document.getElementById('excluir-btn');
        excluirBtn.onclick = () => confirmarExclusaoCartinha(cartinhaId);
    
        // Configurar bot√£o de desfavoritar
        const desfavoritarBtn = document.getElementById('desfavoritar-btn');
        desfavoritarBtn.onclick = () => confirmarDesfavoritarCartinha(cartinhaId);
    
        // Abrir modal
        const modal = new bootstrap.Modal(document.getElementById('cartinhaModal'));
        modal.show();
        
        // Adicionar event listener para atalhos de teclado no modal
        document.addEventListener('keydown', handleModalKeydown);
        
        // Adicionar event listener para limpeza quando o modal for fechado
        const modalElement = document.getElementById('cartinhaModal');
        modalElement.addEventListener('hidden.bs.modal', function limpezaModal() {
            // Garantir limpeza completa
            setTimeout(() => {
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => backdrop.remove());
                
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
            }, 100);
            
            // Remover os listeners para evitar ac√∫mulo
            document.removeEventListener('keydown', handleModalKeydown);
            modalElement.removeEventListener('hidden.bs.modal', limpezaModal);
        });
    } catch (error) {
        console.error('Erro ao abrir cartinha favorita:', error);
        mostrarFeedback('Ocorreu um erro ao abrir a cartinha.', 'danger');
    }
}

// Fun√ß√£o para tratar atalhos de teclado no modal
function handleModalKeydown(e) {
    // Verificar se h√° um modal aberto
    const modalAberto = document.querySelector('.modal.show');
    if (!modalAberto) return;
    
    // Tecla 'D' para desfavoritar
    if (e.key === 'd' || e.key === 'D') {
        e.preventDefault();
        const desfavoritarBtn = document.getElementById('desfavoritar-btn');
        if (desfavoritarBtn) desfavoritarBtn.click();
    }
    
    // Tecla 'R' para responder
    if (e.key === 'r' || e.key === 'R') {
        e.preventDefault();
        const responderBtn = document.getElementById('responder-btn');
        if (responderBtn) responderBtn.click();
    }
    
    // Tecla 'X' ou 'Delete' para excluir
    if (e.key === 'x' || e.key === 'X' || e.key === 'Delete') {
        e.preventDefault();
        const excluirBtn = document.getElementById('excluir-btn');
        if (excluirBtn) excluirBtn.click();
    }
}

// ==================== Fun√ß√µes auxiliares ====================
function encontrarCartinhaFavorita(cartinhaId) {
    if (!Array.isArray(cartinhasFavoritasData)) {
        console.warn('cartinhasFavoritasData n√£o √© um array v√°lido');
        return null;
    }
    
    for (const usuario of cartinhasFavoritasData) {
        if (!Array.isArray(usuario.cartinhas)) {
            console.warn(`Usu√°rio ${usuario.username} n√£o tem um array v√°lido de cartinhas`);
            continue;
        }
        
        const cartinha = usuario.cartinhas.find(c => c && c.id == cartinhaId);
        if (cartinha) return cartinha;
    }
    
    console.warn(`Cartinha com ID ${cartinhaId} n√£o encontrada`);
    return null;
}

function encontrarUsuarioPorCartinhaFavorita(cartinhaId) {
    if (!Array.isArray(cartinhasFavoritasData)) {
        console.warn('cartinhasFavoritasData n√£o √© um array v√°lido');
        return null;
    }
    
    const usuario = cartinhasFavoritasData.find(usuario => 
        Array.isArray(usuario.cartinhas) && 
        usuario.cartinhas.some(cartinha => cartinha && cartinha.id == cartinhaId)
    );
    
    if (!usuario) {
        console.warn(`Usu√°rio para cartinha com ID ${cartinhaId} n√£o encontrado`);
    }
    
    return usuario;
}

async function desfavoritarCartinha(cartinhaId) {
    try {
        window.cartinhaDesfavoritada = false;
        
        // Desabilitar o bot√£o de confirma√ß√£o se existir
        const confirmBtn = document.getElementById('confirmDesfavoritarBtn');
        let originalText = "";
        if (confirmBtn) {
            originalText = confirmBtn.innerHTML;
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Removendo...`;
        }
        
        // Usar o endpoint toggle-favorito conforme a documenta√ß√£o da API
        const response = await fetch(`/api/cartinhas/${cartinhaId}/toggle-favorito`, {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`Erro: ${response.status}`);
        }

        const result = await response.json();
        
        if (result.favoritada === false) {
            // Cartinha foi desfavoritada com sucesso
            window.cartinhaDesfavoritada = true;
            
            // Fechar modal de confirma√ß√£o se existir
            const confirmationModal = document.getElementById('confirmDesfavoritarModal');
            if (confirmationModal) {
                const bsModal = bootstrap.Modal.getInstance(confirmationModal);
                if (bsModal) bsModal.hide();
            }
            
            // Fechar modal da cartinha com limpeza for√ßada
            fecharModalCartinha();
    
            // Remover cartinha da interface
            const cartaElement = document.getElementById(`carta-${cartinhaId}`);
            if (cartaElement) {
                cartaElement.remove();
            }
    
            // Atualizar dados locais
            cartinhasFavoritasData.forEach(usuario => {
                usuario.cartinhas = usuario.cartinhas.filter(c => c.id != cartinhaId);
            });
            
            // Remover usu√°rios que n√£o t√™m mais cartinhas
            cartinhasFavoritasData = cartinhasFavoritasData.filter(usuario => usuario.cartinhas.length > 0);
    
            // Re-renderizar se necess√°rio
            if (cartinhasFavoritasData.length === 0) {
                const container = document.getElementById('cartinhas-container');
                const semCartinhas = document.getElementById('sem-cartinhas');
                container.style.display = 'none';
                semCartinhas.style.display = 'block';
            } else {
                // Recarregar a p√°gina para atualizar as pilhas
                renderizarCartinhasFavoritas();
            }
    
            // Mostrar feedback
            mostrarFeedback(result.message || 'üíî Cartinha removida das favoritas', 'warning');
        } else {
            // Isso n√£o deveria acontecer aqui, mas apenas por seguran√ßa
            mostrarFeedback('Estado inesperado: a cartinha ainda est√° favoritada', 'warning');
            fecharModalCartinha();
        }
        
    } catch (error) {
        console.error('Erro ao desfavoritar cartinha:', error);
        mostrarFeedback('‚ùå Erro ao desfavoritar cartinha', 'danger');
    }
}

function responderCartinha(userId, username) {
    // Fechar modal com limpeza for√ßada
    fecharModalCartinha();
    
    // Redirecionar para a tela de escrever cartinha com par√¢metros
    window.location.href = `/cartinhas/escrever?para=${userId}&nome=${encodeURIComponent(username)}`;
}

// ==================== Fun√ß√µes de confirma√ß√£o e exclus√£o ====================

// Confirmar desfavoritar uma cartinha (com aviso de poss√≠vel exclus√£o)
function confirmarDesfavoritarCartinha(cartinhaId) {
    // Fechar o modal da carta
    const cartinhaModal = bootstrap.Modal.getInstance(document.getElementById('cartinhaModal'));
    cartinhaModal.hide();
    
    // Verificar a idade da cartinha para mostrar aviso adequado
    const cartinha = encontrarCartinhaFavorita(cartinhaId);
    const dataEnvio = cartinha ? new Date(cartinha.dataEnvio) : null;
    const agora = new Date();
    const diffMs = agora - dataEnvio;
    const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
    const riscoExclusao = diffDias >= 3; // Cartinhas com mais de 3 dias podem ser exclu√≠das
    
    // Criar modal de confirma√ß√£o
    let confirmationModal = document.getElementById('confirmDesfavoritarModal');
    
    // Se o modal ainda n√£o existe, cri√°-lo
    if (!confirmationModal) {
        const modalHtml = `
            <div class="modal fade" id="confirmDesfavoritarModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header ${riscoExclusao ? 'bg-danger' : 'bg-warning'} text-white">
                            <h5 class="modal-title">${riscoExclusao ? '‚ö†Ô∏è Aten√ß√£o: Risco de exclus√£o' : 'üíî Confirmar a√ß√£o'}</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">
                            <p>Tem certeza que deseja <strong>remover esta cartinha dos favoritos</strong>?</p>
                            
                            ${riscoExclusao ? `
                            <div class="alert alert-danger" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <strong>Esta cartinha tem mais de 3 dias!</strong><br>
                                Se n√£o estiver marcada como favorita, ela poder√° ser exclu√≠da 
                                automaticamente do sistema durante a pr√≥xima limpeza.
                            </div>
                            ` : ''}
                            
                            <p class="mb-0 text-muted fst-italic">
                                <small>Se essa cartinha tiver mais que 30 dias de vida ela pode ser exclu√≠da se desfavoritada.</small>
                            </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn ${riscoExclusao ? 'btn-danger' : 'btn-warning'}" id="confirmDesfavoritarBtn">
                                ${riscoExclusao ? 'Remover dos favoritos (risco de exclus√£o)' : 'Remover dos favoritos'}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        confirmationModal = document.getElementById('confirmDesfavoritarModal');
    }
    
    // Configurar o bot√£o de confirmar desfavoritar
    const confirmBtn = confirmationModal.querySelector('#confirmDesfavoritarBtn');
    confirmBtn.onclick = () => {
        // Fechar modal de confirma√ß√£o
        const confirmModal = bootstrap.Modal.getInstance(confirmationModal);
        confirmModal.hide();
        
        // Executar a desfavorita√ß√£o
        desfavoritarCartinha(cartinhaId);
    };
    
    // Mostrar o modal de confirma√ß√£o
    const modal = new bootstrap.Modal(confirmationModal);
    modal.show();
    
    // Quando o modal de confirma√ß√£o for fechado sem confirma√ß√£o, reabrir o modal da cartinha
    confirmationModal.addEventListener('hidden.bs.modal', function reopen() {
        confirmationModal.removeEventListener('hidden.bs.modal', reopen);
        if (!window.cartinhaDesfavoritada) {
            // Reabrir o modal da cartinha apenas se n√£o foi desfavoritada
            setTimeout(() => {
                const cartinha = encontrarCartinhaFavorita(cartinhaId);
                if (cartinha) abrirCartinhaFavorita(cartinhaId);
            }, 100);
        }
    });
}

// Confirmar exclus√£o permanente de uma cartinha
function confirmarExclusaoCartinha(cartinhaId) {
    // Fechar o modal da carta
    const cartinhaModal = bootstrap.Modal.getInstance(document.getElementById('cartinhaModal'));
    cartinhaModal.hide();
    
    // Criar modal de confirma√ß√£o
    let confirmationModal = document.getElementById('confirmExclusaoModal');
    
    // Se o modal ainda n√£o existe, cri√°-lo
    if (!confirmationModal) {
        const modalHtml = `
            <div class="modal fade" id="confirmExclusaoModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">‚ö†Ô∏è Confirmar exclus√£o permanente</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">
                            <p>Tem certeza que deseja <strong>excluir permanentemente</strong> esta cartinha?</p>
                            <div class="alert alert-danger" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                <strong>Esta a√ß√£o n√£o pode ser desfeita!</strong><br>
                                A cartinha ser√° permanentemente removida e n√£o poder√° ser recuperada.
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-danger" id="confirmExcluirBtn">
                                Excluir permanentemente
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        confirmationModal = document.getElementById('confirmExclusaoModal');
    }
    
    // Configurar o bot√£o de confirmar exclus√£o
    const confirmBtn = confirmationModal.querySelector('#confirmExcluirBtn');
    confirmBtn.onclick = () => excluirCartinha(cartinhaId);
    
    // Mostrar o modal de confirma√ß√£o
    const modal = new bootstrap.Modal(confirmationModal);
    modal.show();
    
    // Quando o modal de confirma√ß√£o for fechado sem confirma√ß√£o, reabrir o modal da cartinha
    confirmationModal.addEventListener('hidden.bs.modal', function reopen() {
        confirmationModal.removeEventListener('hidden.bs.modal', reopen);
        if (!window.cartinhaExcluida) {
            // Reabrir o modal da cartinha apenas se n√£o foi exclu√≠da
            setTimeout(() => {
                const cartinha = encontrarCartinhaFavorita(cartinhaId);
                if (cartinha) abrirCartinhaFavorita(cartinhaId);
            }, 100);
        }
    });
}

// Fun√ß√£o para excluir a cartinha via API
async function excluirCartinha(cartinhaId) {
    try {
        window.cartinhaExcluida = false;
        
        // Desabilitar o bot√£o de confirma√ß√£o e mostrar indicador de carregamento
        const confirmBtn = document.getElementById('confirmExcluirBtn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Excluindo...`;
        
        // Chamada √† API para excluir a cartinha
        const response = await fetch(`/api/cartinhas/${cartinhaId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        // Processar resposta
        if (response.ok) {
            const result = await response.json();
            
            // Marcar como exclu√≠da para evitar reabrir o modal
            window.cartinhaExcluida = true;
            
            // Fechar o modal de confirma√ß√£o
            const confirmationModal = bootstrap.Modal.getInstance(document.getElementById('confirmExclusaoModal'));
            confirmationModal.hide();
            
            // Remover a cartinha dos dados locais
            cartinhasFavoritasData.forEach(usuario => {
                usuario.cartinhas = usuario.cartinhas.filter(c => c.id != cartinhaId);
            });
            
            // Remover usu√°rios que n√£o t√™m mais cartinhas
            cartinhasFavoritasData = cartinhasFavoritasData.filter(usuario => usuario.cartinhas.length > 0);
            
            // Remover o elemento da cartinha no DOM
            const cartaElement = document.getElementById(`carta-${cartinhaId}`);
            if (cartaElement) {
                cartaElement.remove();
            }
            
            // Re-renderizar se necess√°rio
            if (cartinhasFavoritasData.length === 0) {
                const container = document.getElementById('cartinhas-container');
                const semCartinhas = document.getElementById('sem-cartinhas');
                container.style.display = 'none';
                semCartinhas.style.display = 'block';
            } else {
                // Recarregar a p√°gina para atualizar as pilhas
                renderizarCartinhasFavoritas();
            }
            
            // Mostrar feedback
            mostrarFeedback(result.message || "Cartinha exclu√≠da com sucesso", "success");
        } else {
            // Processar erro
            let errorMessage = "Erro ao excluir cartinha";
            try {
                const errorData = await response.json();
                errorMessage = errorData.message || errorMessage;
            } catch (e) {
                console.error("Erro ao processar resposta de erro:", e);
            }
            
            // Reabilitar o bot√£o
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalText;
            
            // Mostrar mensagem de erro
            mostrarFeedback(errorMessage, "danger");
        }
    } catch (error) {
        console.error('Erro ao excluir cartinha:', error);
        
        // Reabilitar bot√£o de confirma√ß√£o
        const confirmBtn = document.getElementById('confirmExcluirBtn');
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = "Excluir permanentemente";
        }
        
        // Mostrar erro
        mostrarFeedback("Erro ao excluir cartinha. Tente novamente.", "danger");
    }
}

// ==================== Fun√ß√£o para fechar modal com limpeza completa ====================
function fecharModalCartinha() {
    const modalElement = document.getElementById('cartinhaModal');
    const modal = bootstrap.Modal.getInstance(modalElement);
    
    if (modal) {
        modal.hide();
    }
    
    // For√ßar limpeza do backdrop ap√≥s um pequeno delay
    setTimeout(() => {
        // Remover qualquer backdrop que possa ter ficado
        const backdrops = document.querySelectorAll('.modal-backdrop');
        backdrops.forEach(backdrop => backdrop.remove());
        
        // Limpar classes do body
        document.body.classList.remove('modal-open');
        document.body.style.overflow = '';
        document.body.style.paddingRight = '';
        
        // Garantir que o modal est√° fechado
        modalElement.classList.remove('show');
        modalElement.style.display = 'none';
        modalElement.setAttribute('aria-hidden', 'true');
        modalElement.removeAttribute('aria-modal');
    }, 300);
}

// ==================== Callback para carregar cartas (espec√≠fico de FAVORITAS) ====================
window.carregarCartasCallback = function(pilhaElement, usuarioIndex) {
    const usuario = window.usuariosProcessados[usuarioIndex];
    if (!usuario) {
        return;
    }
    
    // Inicializar o √≠ndice de ciclo se n√£o existir
    if (!usuario.indiceCiclo) usuario.indiceCiclo = 0;
    
    const cartasDoUsuario = usuario.cartinhas;
    const totalCartas = cartasDoUsuario.length;
    let html = '';
    
    // Renderizar apenas as primeiras 3 cartas (topo, meio, fundo)
    const cartasParaRenderizar = cartasDoUsuario.slice(0, Math.min(3, totalCartas));
    
    cartasParaRenderizar.forEach((cartinha, index) => {
        let posicaoClasse = '';
        let zIndex = 10;
        
        if (index === 0) {
            posicaoClasse = 'topo';
            zIndex = 10;
        } else if (index === 1) {
            posicaoClasse = 'meio';
            zIndex = 5;
        } else {
            posicaoClasse = 'fundo';
            zIndex = 1;
        }
        
        html += `
            <div class="carta-empilhada ${posicaoClasse}" 
                 id="carta-${cartinha.id}" 
                 style="z-index: ${zIndex};"
                 onclick="abrirCartinhaFavorita(${cartinha.id})">
                
                <div class="carta-envelope">
                    <div class="envelope-flap"></div>
                    <div class="selo favorita">‚≠ê</div>
                    
                    <div class="envelope-header">
                        <div class="remetente-info">
                            <img src="${usuario.avatar}" alt="${usuario.username}" class="avatar-carta">
                            <div>
                                <h6 class="mb-1">${usuario.username}</h6>
                                <small class="text-muted">Favoritada ${formatarData(cartinha.dataFavoritada)}</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cartinha-papel">
                        <div class="papel-linhas">
                            <h5 class="titulo-carta">${cartinha.titulo}</h5>
                            <p class="conteudo-carta">${cortarTexto(cartinha.conteudo, 120)}</p>
                            <div class="data-carta">${formatarData(cartinha.dataEnvio)}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Bot√µes de a√ß√£o -->
                <div class="acoes-carta">
                    <button class="btn-acao btn-ler" onclick="event.stopPropagation(); abrirCartinhaFavorita(${cartinha.id})" title="Ver carta">
                        üëÅÔ∏è
                    </button>
                </div>
            </div>
        `;
    });
    
    pilhaElement.insertAdjacentHTML('beforeend', html);
    
    // Marcar pilha como carregada
    pilhaElement.dataset.carregada = 'true';
    
    // Adicionar evento de clique na carta do topo para abrir
    const cartaTopo = pilhaElement.querySelector('.carta-empilhada.topo');
    if (cartaTopo) {
        cartaTopo.addEventListener('click', (e) => {
            e.stopPropagation();
            const cartinhaId = cartaTopo.id.replace('carta-', '');
            abrirCartinhaFavorita(parseInt(cartinhaId));
        });
    }
};

// ==================== Inicializa√ß√£o ====================
document.addEventListener('DOMContentLoaded', () => {
    // Carregar cartinhas favoritas
    carregarCartinhasFavoritas();
    
    // Eventos de teclado para navega√ß√£o
    document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
        
        // Verificar se h√° um modal aberto
        const modalAberto = document.querySelector('.modal.show');
        if (modalAberto) {
            // Teclas de atalho para o modal
            if (e.key === 'r' || e.key === 'R') {
                e.preventDefault();
                const responderBtn = document.getElementById('responder-btn');
                if (responderBtn) responderBtn.click();
            } else if (e.key === 'd' || e.key === 'D') {
                e.preventDefault();
                const desfavoritarBtn = document.getElementById('desfavoritar-btn');
                if (desfavoritarBtn) desfavoritarBtn.click();
            }
            return;
        }
        
        // Verificar se temos pilhas antes de processar teclas
        if (!window.usuariosProcessados || window.usuariosProcessados.length === 0) return;
        
        switch(e.key) {
            case 'ArrowLeft':
                e.preventDefault();
                ciclarCartasPilhaAtiva(); // Mudar mensagem (carta anterior)
                break;
            case 'ArrowRight':
                e.preventDefault();
                ciclarCartasPilhaAtiva(); // Mudar mensagem (pr√≥xima carta)
                break;
            case 'ArrowUp':
                e.preventDefault();
                trocarPilhaAnterior(); // Mudar usu√°rio (pilha anterior)
                break;
            case 'ArrowDown':
                e.preventDefault();
                trocarProximaPilha(); // Mudar usu√°rio (pr√≥xima pilha)
                break;
            case ' ':
            case 'Enter':
                e.preventDefault();
                lerCartaAtiva();
                break;
        }
    });

    // Eventos de mouse para navega√ß√£o na pilha ativa
    document.addEventListener('click', (e) => {
        const pilhaAtiva = document.querySelector('.pilha-cartas.ativa');
        if (!pilhaAtiva) return;
        
        const rect = pilhaAtiva.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const clickY = e.clientY - rect.top;
        
        // √Årea da pilha ativa (excluindo cartas)
        if (e.target === pilhaAtiva) {
            if (clickY < rect.height / 3) {
                // Clique na parte superior - usu√°rio anterior
                trocarPilhaAnterior();
            } else if (clickY > rect.height * 2/3) {
                // Clique na parte inferior - pr√≥ximo usu√°rio
                trocarProximaPilha();
            } else if (clickX < rect.width / 2) {
                // Clique na parte esquerda - carta anterior
                ciclarCartasPilhaAtiva();
            } else {
                // Clique na parte direita - pr√≥xima carta
                ciclarCartasPilhaAtiva();
            }
        }
    });
});

// ==================== Navega√ß√£o entre pilhas ====================
function atualizarBotoesNavegacao() {
    const btnAnterior = document.getElementById('btn-pilha-anterior');
    const btnProximo = document.getElementById('btn-pilha-proximo');
    
    if (btnAnterior) {
        btnAnterior.disabled = window.totalPilhas <= 1;
    }
    
    if (btnProximo) {
        btnProximo.disabled = window.totalPilhas <= 1;
    }
}
</script>
