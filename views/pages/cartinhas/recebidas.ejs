<link rel="stylesheet" href="/styles/cartinhas/cartinhas-modals.css">
<script src="/js/commons/cartinhas-common.js"></script>

<div class="container mt-4">
    <div class="mb-3">
        <a href="/cartinhas" class="btn btn-sm btn-outline-secondary">
            <i class="bi bi-arrow-left"></i> Voltar ao Menu
        </a>
    </div>
    <div class="row">
        <div class="col-12">  
            <div id="loading" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando...</span>
                </div>
            </div>

            <div id="cartinhas-container" style="display: none;">
                <div class="container-pilhas"></div>
            </div>

            <div id="sem-cartinhas" class="sem-cartinhas" style="display: none;">
                <div class="envelope-vazio">ğŸ“­</div>
                <h4>Nenhuma cartinha recebida</h4>
                <p>VocÃª ainda nÃ£o recebeu nenhuma cartinha. Quando alguÃ©m enviar uma para vocÃª, ela aparecerÃ¡ aqui!</p>
            </div>
        </div>
    </div>
</div>

<script>
// ConfiguraÃ§Ã£o do tipo de cartinhas
window.tipoCartinhas = 'recebidas';

// Dados locais da pÃ¡gina (nÃ£o expor como global)
let usuariosProcessados = [];

// ==================== CARREGAR CARTINHAS ====================
async function carregarCartinhasRecebidas() {
    try {
        const response = await fetch('/api/cartinhas/recebidas', {
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Erro ao carregar cartinhas');

        usuariosProcessados = await response.json();

        if (!Array.isArray(usuariosProcessados)) {
            throw new Error('Resposta invÃ¡lida da API');
        }

        // Hooks para integraÃ§Ã£o com o common (abrir modal com comportamento desta pÃ¡gina)
        const hooks = {
            abrirCartinha: async (cartinhaId) => {
                const cartinha = encontrarCartinha(cartinhaId, usuariosProcessados);
                if (!cartinha) return;

                const usuario = encontrarUsuarioPorCartinha(cartinhaId, usuariosProcessados);
                if (!usuario) return;

                // Marcar como lida antes de abrir (aguardar para estado consistente)
                if (!cartinha.lida) {
                    try { await marcarComoLida(cartinhaId); } catch (e) { /* continue */ }
                }

                window.modalCartinha.abrir({
                    cartinha: cartinha,
                    usuario: usuario,
                    tipo: 'recebidas',
                    titulo: 'ğŸ“¬ Lendo Cartinha',
                    badges: [
                        { icone: cartinha.lida ? 'âœ“' : 'â—‹', texto: cartinha.lida ? 'Lida' : 'NÃ£o lida', cor: cartinha.lida ? '#10b981' : '#6b7280' }
                    ],
                    acoes: [
                        {
                            id: 'responder',
                            label: 'ğŸ’Œ Responder',
                            classe: 'btn-primary',
                            atalho: 'R',
                            callback: () => responderCartinha(usuario.userId, usuario.username)
                        },
                        {
                            id: 'favoritar',
                            label: cartinha.favoritada ? 'â­ Favoritada' : 'â­ Favoritar',
                            classe: cartinha.favoritada ? 'btn-warning' : 'btn-outline-warning',
                            atalho: 'F',
                            callback: () => toggleFavoritoCommon(cartinhaId, usuariosProcessados)
                        },
                        {
                            id: 'excluir',
                            label: 'ğŸ—‘ï¸ Excluir',
                            classe: 'btn-danger',
                            atalho: 'D',
                            callback: () => confirmarExclusao(cartinhaId)
                        }
                    ]
                });
            }
        };

        // Usa funÃ§Ã£o genÃ©rica do common
        renderizarCartinhas(usuariosProcessados, hooks);
        // Inicializar navegaÃ§Ã£o com a lista local (evita uso de globals)
        inicializarNavegacaoCartinhas(usuariosProcessados, hooks);
        
    } catch (error) {
        console.error('Erro ao carregar cartinhas:', error);
        window.usuariosProcessados = [];
        renderizarCartinhas([]);
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

// ==================== MARCAR COMO LIDA ====================
async function marcarComoLida(cartinhaId) {
    try {
        const response = await fetch(`/api/cartinhas/${cartinhaId}/lida`, {
            method: 'PUT',
            credentials: 'include'
        });

        if (!response.ok) return false;

        const cartinha = encontrarCartinha(cartinhaId, usuariosProcessados);
        if (cartinha) {
            cartinha.lida = true;
            
            // Atualizar UI
            const cartaElement = document.getElementById(`carta-${cartinhaId}`);
            if (cartaElement) {
                const selo = cartaElement.querySelector('.selo');
                if (selo) selo.textContent = 'LIDA';
                
                const indicador = cartaElement.querySelector('.indicador-nao-lida');
                if (indicador) {
                    indicador.className = 'indicador-lida';
                    indicador.textContent = 'âœ“ Lida';
                }
            }
            
            // Atualizar contador de nÃ£o lidas
            const usuario = encontrarUsuarioPorCartinha(cartinhaId, usuariosProcessados);
            if (usuario) {
                const pilha = document.getElementById(`pilha-${usuario.userId}`);
                if (pilha) {
                    const naoLidas = usuario.cartinhas.filter(c => !c.lida).length;
                    const contador = pilha.querySelector('.contador-pilha');
                    if (contador) {
                        if (naoLidas > 0) {
                            contador.textContent = naoLidas;
                        } else {
                            contador.remove();
                        }
                    }
                }
            }
        }

        return true;
    } catch (error) {
        console.error('Erro ao marcar cartinha como lida:', error);
        return false;
    }
}

// ==================== RESPONDER ====================
function responderCartinha(userId, username) {
    window.modalCartinha.fechar();
    window.location.href = `/cartinhas/escrever?para=${userId}&nome=${encodeURIComponent(username)}`;
}

// ==================== EXCLUIR ====================
async function confirmarExclusao(cartinhaId) {
    window.modalCartinha.fechar();
    
    const confirmado = await mostrarConfirmacao(
        'âš ï¸ Tem certeza que deseja excluir permanentemente esta cartinha?\n\nEsta aÃ§Ã£o nÃ£o pode ser desfeita!',
        'Confirmar ExclusÃ£o'
    );
    
    if (confirmado) {
        excluirCartinha(cartinhaId);
    }
}

async function excluirCartinha(cartinhaId) {
    try {
        const response = await fetch(`/api/cartinhas/${cartinhaId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        if (!response.ok) throw new Error('Erro ao excluir');

        // Remover cartinha do array local
        for (let usuario of usuariosProcessados) {
            const index = usuario.cartinhas.findIndex(c => c.id === cartinhaId);
            if (index !== -1) {
                usuario.cartinhas.splice(index, 1);
                
                // Se nÃ£o hÃ¡ mais cartas deste usuÃ¡rio, remover usuÃ¡rio
                if (usuario.cartinhas.length === 0) {
                    const usuarioIndex = usuariosProcessados.indexOf(usuario);
                    usuariosProcessados.splice(usuarioIndex, 1);
                }
                break;
            }
        }

        // Re-renderizar
        renderizarCartinhas(usuariosProcessados);
        mostrarFeedback('ğŸ—‘ï¸ Cartinha excluÃ­da com sucesso!', 'success');
        
    } catch (error) {
        console.error('Erro ao excluir cartinha:', error);
        mostrarFeedback('Erro ao excluir cartinha. Tente novamente.', 'danger');
    }
}

// ==================== INICIALIZAÃ‡ÃƒO ====================
document.addEventListener('DOMContentLoaded', () => {
    carregarCartinhasRecebidas();
    
    // Focar na primeira pilha
    setTimeout(() => {
        const primeiraPilha = document.querySelector('.pilha-cartas.ativa');
        if (primeiraPilha) primeiraPilha.focus();
    }, 500);
});
</script>

<%- include('../../utils/modal-confirmacao') %>
