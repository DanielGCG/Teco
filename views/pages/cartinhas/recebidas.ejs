<link rel="stylesheet" href="/styles/recebidas.css">
<script src="/js/modal-cartinha.js"></script>

<style>
    /* Estilo para o selo de favorita */
    .selo-favorita {
        position: absolute;
        top: 10px;
        right: 15px;
        z-index: 5;
        color: #f1c40f;
        font-size: 1.2rem;
        filter: drop-shadow(0 0 3px rgba(0,0,0,0.4));
        transition: all 0.3s ease;
        transform-origin: center;
        background: rgba(255, 255, 255, 0.9);
        width: 28px;
        height: 28px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    
    /* Anima√ß√£o de destaque para o selo favorito quando adicionado */
    @keyframes destacarEstrela {
        0% { transform: scale(0.5) rotate(-15deg); opacity: 0; }
        25% { transform: scale(1.6) rotate(15deg); opacity: 1; }
        50% { transform: scale(0.9) rotate(-5deg); opacity: 1; }
        75% { transform: scale(1.1) rotate(5deg); opacity: 1; }
        100% { transform: scale(1) rotate(0deg); opacity: 1; }
    }
    
    .selo-favorita.adicionado {
        animation: destacarEstrela 0.7s ease-out;
    }
    
    /* Efeito hover para o selo de favorita */
    .carta-envelope:hover .selo-favorita {
        transform: scale(1.3) rotate(10deg);
        filter: drop-shadow(0 0 6px rgba(241, 196, 15, 0.7));
        color: #f39c12;
    }
</style>

<div class="container mt-4">
    <div class="row">
        <div class="col-12">  
            <!-- Loading -->
            <div id="loading" class="loading-spinner">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Carregando cartas...</span>
                </div>
            </div>

            <!-- Container para as cartinhas -->
            <div id="cartinhas-container" style="display: none;">    
                <!-- Container das pilhas empilhadas -->
                <div class="container-pilhas">
                    <!-- As pilhas ser√£o inseridas aqui -->
                </div>
            </div>
            
            <!-- Mensagem quando n√£o h√° cartinhas -->
            <div id="sem-cartinhas" class="sem-cartinhas" style="display: none;">
                <div class="envelope-vazio">üì≠</div>
                <h4>Caixa de entrada vazia</h4>
                <p>Voc√™ ainda n√£o recebeu nenhuma cartinha.<br>Quando algu√©m enviar uma carta para voc√™, ela aparecer√° aqui.</p>
            </div>
        </div>
    </div>
</div>

<script>
let cartinhasData = [];

// ==================== Carregar cartinhas ====================
async function carregarCartinhas() {
    try {
        const response = await fetch('/api/cartinhas/recebidas', {
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`Erro: ${response.status}`);
        }

        // Preencher window.usuariosProcessados diretamente com os dados da API
        window.usuariosProcessados = await response.json();

        // Validar se o resultado √© um array conforme esperado
        if (!Array.isArray(window.usuariosProcessados)) {
            console.error('Formato de resposta inesperado:', window.usuariosProcessados);
            window.usuariosProcessados = [];
        }

        // Chama a fun√ß√£o de renderiza√ß√£o
        renderizarCartinhas();
        
    } catch (error) {
        console.error('Erro ao carregar cartinhas:', error);
        window.usuariosProcessados = [];
        renderizarCartinhas();
    } finally {
        document.getElementById('loading').style.display = 'none';
    }
}

// ==================== Renderizar cartinhas ====================
function renderizarCartinhas() {
    const container = document.getElementById('cartinhas-container');
    const semCartinhas = document.getElementById('sem-cartinhas');    

    if (!window.usuariosProcessados || window.usuariosProcessados.length === 0) {
        container.style.display = 'none';
        semCartinhas.style.display = 'block';
        return;
    }

    const usuariosComCartinhas = window.usuariosProcessados;

    // Ordenar usu√°rios por quantidade de cartas n√£o lidas e depois pela carta mais recente
    usuariosComCartinhas.forEach(u => {
        u.naoLidas = u.cartinhas.filter(c => !c.lida).length;
    });

    usuariosComCartinhas.sort((a, b) => {
        if (a.naoLidas !== b.naoLidas) return b.naoLidas - a.naoLidas;
        const dataA = new Date(a.cartinhas[0]?.dataEnvio || 0);
        const dataB = new Date(b.cartinhas[0]?.dataEnvio || 0);
        return dataB - dataA;
    });

    const containerPilhas = container.querySelector('.container-pilhas');
    let html = '';

    usuariosComCartinhas.forEach((usuario, usuarioIndex) => {
        const cartasNaoLidas = usuario.naoLidas;

        let classPosicao = '';
        if (usuarioIndex === 0) classPosicao = 'ativa';
        else if (usuarioIndex === 1) classPosicao = 'segunda';
        else if (usuarioIndex === 2) classPosicao = 'terceira';
        else if (usuarioIndex === 3) classPosicao = 'quarta';
        else classPosicao = 'fundo';

        html += `
            <div class="pilha-cartas ${classPosicao}" id="pilha-${usuario.userId}" data-usuario-index="${usuarioIndex}" data-carregada="false">
                ${usuarioIndex === 0 ? `
                    <div class="instrucoes-pilha">
                        üéØ Pilha ativa ‚Ä¢ ‚Üê‚Üí: ciclar cartas ‚Ä¢ Enter: ler carta
                    </div>
                ` : ''}
                ${cartasNaoLidas > 0 ? `<div class="contador-pilha">${cartasNaoLidas}</div>` : ''}
            </div>
        `;
    });

    containerPilhas.innerHTML = html;
    container.style.display = 'block';
    semCartinhas.style.display = 'none';

    // Definir pilha ativa global
    window.pilhaAtivaIndex = 0;
    window.totalPilhas = usuariosComCartinhas.length;

    // Renderizar apenas as pilhas vis√≠veis inicialmente
    renderizarPilhasVisiveis();
}

// ==================== Fun√ß√µes de controle das pilhas ====================
function trocarPilhaAnterior() {
    if (window.totalPilhas <= 1) return;
    
    const novoIndex = window.pilhaAtivaIndex > 0 ? window.pilhaAtivaIndex - 1 : window.totalPilhas - 1;
    trocarPilhaAtiva(novoIndex);
}

function trocarProximaPilha() {
    if (window.totalPilhas <= 1) return;
    
    const novoIndex = window.pilhaAtivaIndex < window.totalPilhas - 1 ? window.pilhaAtivaIndex + 1 : 0;
    trocarPilhaAtiva(novoIndex);
}

function trocarPilhaAtiva(novoIndex) {
    if (novoIndex === window.pilhaAtivaIndex) return;
    
    const pilhas = Array.from(document.querySelectorAll('.pilha-cartas'));
    
    // Remover classes antigas
    pilhas.forEach(pilha => {
        pilha.classList.remove('ativa', 'segunda', 'terceira', 'quarta', 'fundo');
    });
    
    // Aplicar novas posi√ß√µes
    pilhas.forEach((pilha, index) => {
        const posicaoRelativa = (index - novoIndex + window.totalPilhas) % window.totalPilhas;
        
        if (posicaoRelativa === 0) {
            pilha.classList.add('ativa');
            // Adicionar instru√ß√µes apenas na pilha ativa
            const instrucoes = pilha.querySelector('.instrucoes-pilha');
            if (!instrucoes) {
                pilha.insertAdjacentHTML('afterbegin', `
                    <div class="instrucoes-pilha">
                        üéØ Pilha ativa ‚Ä¢ ‚Üê‚Üí: ciclar cartas ‚Ä¢ Enter: ler carta
                    </div>
                `);
            }
        } else if (posicaoRelativa === 1) {
            pilha.classList.add('segunda');
        } else if (posicaoRelativa === 2) {
            pilha.classList.add('terceira');
        } else if (posicaoRelativa === 3) {
            pilha.classList.add('quarta');
        } else {
            pilha.classList.add('fundo');
        }
        
        // Remover instru√ß√µes das pilhas n√£o ativas
        if (posicaoRelativa !== 0) {
            const instrucoes = pilha.querySelector('.instrucoes-pilha');
            if (instrucoes) instrucoes.remove();
        }
    });
    
    window.pilhaAtivaIndex = novoIndex;
    
    // Renderizar pilhas vis√≠veis ap√≥s a troca
    renderizarPilhasVisiveis();
    
    // Descarregar pilhas que n√£o est√£o mais vis√≠veis para economizar mem√≥ria
    setTimeout(descarregarPilhasInvisiveis, 500);
}

function ciclarCartasPilhaAtiva() {

    const pilhaAtiva = document.querySelector('.pilha-cartas.ativa');
    if (!pilhaAtiva) return;

    const cartas = Array.from(pilhaAtiva.querySelectorAll('.carta-empilhada'));
    if (cartas.length <= 1) return;

    // Obter dados do usu√°rio e da pilha
    const usuarioIndex = parseInt(pilhaAtiva.dataset.usuarioIndex);
    const usuario = window.usuariosProcessados[usuarioIndex];
    if (!usuario) return;

    // Inicializar ou incrementar o √≠ndice de ciclo para este usu√°rio
    if (!usuario.indiceCiclo) usuario.indiceCiclo = 0;
    usuario.indiceCiclo = (usuario.indiceCiclo + 1) % usuario.cartinhas.length;

    // Ciclar array de cartas: mover a primeira para o final
    usuario.cartinhas.push(usuario.cartinhas.shift());

    // Remover todas as cartas do DOM
    cartas.forEach(carta => carta.remove());

    // Renderizar as 3 cartas corretas
    for (let i = 0; i < Math.min(3, usuario.cartinhas.length); i++) {
        const cartinha = usuario.cartinhas[i];
        const dataFormatada = formatarData(cartinha.dataEnvio);
        const isNaoLida = !cartinha.lida;
        let posicaoClasse = '';
        if (i === 0) posicaoClasse = 'topo';
        else if (i === 1) posicaoClasse = 'meio';
        else posicaoClasse = 'fundo';

        // Calcular a posi√ß√£o real da carta considerando o ciclo
        const posicaoReal = (usuario.indiceCiclo + i) % usuario.cartinhas.length + 1;

        const cartaHtml = document.createElement('div');
        cartaHtml.className = `carta-empilhada carta-envelope ${posicaoClasse}`;
        cartaHtml.id = `carta-${cartinha.id}`;
        cartaHtml.dataset.cartinhaId = cartinha.id;
        cartaHtml.dataset.usuarioId = usuario.userId;
        cartaHtml.dataset.posicao = i;
        cartaHtml.style.zIndex = 10 - i;
        cartaHtml.innerHTML = `
            <div style="position: absolute; top: 5px; left: 15px; z-index: 4; background: rgba(108, 92, 231, 0.9); color: white; padding: 0.4rem 1rem; border-radius: 0 0 12px 0; font-weight: 600; font-size: 0.95rem; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
                ${usuario.username}
            </div>
            <div class="envelope-flap"></div>
            <div class="selo ${isNaoLida ? 'nova' : ''}">${isNaoLida ? 'NOVA' : '‚úì'}</div>
            ${cartinha.favoritada ? `
                <div class="selo-favorita" style="position: absolute; top: 10px; right: 15px; z-index: 4; color: #f1c40f; font-size: 1.2rem; filter: drop-shadow(0 0 2px rgba(0,0,0,0.3));">‚≠ê</div>
            ` : ''}
            <div class="envelope-header">
                <div class="remetente-info">
                    <img src="${usuario.avatar}" alt="Avatar" class="avatar-carta">
                    <div>
                        <div style="display: flex; align-items: center; gap: 1rem;">
                            <span class="contador-cartas">
                                Carta ${posicaoReal} de ${usuario.cartinhas.length}
                            </span>
                            <small style="color: #74b9ff; font-weight: 500;">${dataFormatada}</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="cartinha-papel papel-linhas">
                <h3 class="titulo-carta ${isNaoLida ? 'text-primary' : ''}">${cartinha.titulo || ''}</h3>
                <div class="conteudo-carta">${cortarTexto(cartinha.conteudo || '', 120)}</div>
                <div class="data-carta">Recebida em ${dataFormatada}</div>
            </div>
            ${i === 0 ? `
                <div class="acoes-carta">
                    <button class="btn-acao btn-ler" onclick="abrirCartinha(${cartinha.id})" title="Ler carta">üìñ</button>
                </div>
            ` : ''}
        `;
        pilhaAtiva.appendChild(cartaHtml);
    }
}

function lerCartaAtiva() {
    const pilhaAtiva = document.querySelector('.pilha-cartas.ativa');
    if (!pilhaAtiva) return;
    
    const cartaTopo = pilhaAtiva.querySelector('.carta-empilhada.topo');
    if (cartaTopo) {
        const cartinhaId = parseInt(cartaTopo.dataset.cartinhaId);
        abrirCartinha(cartinhaId);
    }
}

// ==================== Fun√ß√µes de manipula√ß√£o de cartas ====================
function jogarCartaDireita(cartinhaId) {
    const carta = document.getElementById(`carta-${cartinhaId}`);
    const pilha = carta.closest('.pilha-cartas');
    
    // Aplicar anima√ß√£o de jogar para direita
    carta.classList.add('jogada-direita');
    
    // Ap√≥s a anima√ß√£o, reorganizar a pilha
    setTimeout(() => {
        reorganizarPilha(pilha, cartinhaId);
    }, 400);
}

function jogarCartaEsquerda(cartinhaId) {
    const carta = document.getElementById(`carta-${cartinhaId}`);
    const pilha = carta.closest('.pilha-cartas');
    
    // Aplicar anima√ß√£o de jogar para esquerda
    carta.classList.add('jogada-esquerda');
    
    // Ap√≥s a anima√ß√£o, reorganizar a pilha
    setTimeout(() => {
        reorganizarPilha(pilha, cartinhaId);
    }, 400);
}

function reorganizarPilha(pilha, cartinhaJogada) {
    const todasCartas = Array.from(pilha.querySelectorAll('.carta-empilhada'));
    const cartaJogadaElement = document.getElementById(`carta-${cartinhaJogada}`);
    const cartasRestantes = todasCartas.filter(carta => carta.id !== `carta-${cartinhaJogada}`);
    
    // Reorganizar posi√ß√µes das cartas restantes
    cartasRestantes.forEach((carta, index) => {
        // Remover classes antigas
        carta.classList.remove('topo', 'meio', 'fundo');
        
        // Aplicar nova posi√ß√£o
        if (index === 0) {
            carta.classList.add('topo');
            // Reativar bot√µes de a√ß√£o na nova carta do topo
            const acoesCarta = carta.querySelector('.acoes-carta');
            if (acoesCarta) {
                acoesCarta.style.display = 'flex';
                // Atualizar IDs dos bot√µes
                const cartinhaId = carta.dataset.cartinhaId;
                acoesCarta.innerHTML = `
                    <button class="btn-acao btn-jogar-esquerda" onclick="jogarCartaEsquerda(${cartinhaId})" title="Jogar para esquerda">
                        ‚Üê
                    </button>
                    <button class="btn-acao btn-ler" onclick="abrirCartinha(${cartinhaId})" title="Ler carta">
                        üìñ
                    </button>
                    <button class="btn-acao btn-jogar-direita" onclick="jogarCartaDireita(${cartinhaId})" title="Jogar para direita">
                        ‚Üí
                    </button>
                `;
            } else {
                // Criar bot√µes se n√£o existirem
                const novosAcoes = document.createElement('div');
                novosAcoes.className = 'acoes-carta';
                const cartinhaId = carta.dataset.cartinhaId;
                novosAcoes.innerHTML = `
                    <button class="btn-acao btn-jogar-esquerda" onclick="jogarCartaEsquerda(${cartinhaId})" title="Jogar para esquerda">
                        ‚Üê
                    </button>
                    <button class="btn-acao btn-ler" onclick="abrirCartinha(${cartinhaId})" title="Ler carta">
                        üìñ
                    </button>
                    <button class="btn-acao btn-jogar-direita" onclick="jogarCartaDireita(${cartinhaId})" title="Jogar para direita">
                        ‚Üí
                    </button>
                `;
                carta.appendChild(novosAcoes);
            }
        } else if (index === 1) {
            carta.classList.add('meio');
            // Ocultar bot√µes de a√ß√£o
            const acoesCarta = carta.querySelector('.acoes-carta');
            if (acoesCarta) acoesCarta.style.display = 'none';
        } else {
            carta.classList.add('fundo');
            // Ocultar bot√µes de a√ß√£o
            const acoesCarta = carta.querySelector('.acoes-carta');
            if (acoesCarta) acoesCarta.style.display = 'none';
        }
        
        carta.style.zIndex = 10 - index;
    });
    
    // Ap√≥s 1 segundo, mover a carta jogada para o final da pilha
    setTimeout(() => {
        if (cartaJogadaElement) {
            // Remover classes de jogada
            cartaJogadaElement.classList.remove('jogada-direita', 'jogada-esquerda');
            
            // Remover bot√µes de a√ß√£o se existirem
            const acoesCarta = cartaJogadaElement.querySelector('.acoes-carta');
            if (acoesCarta) acoesCarta.remove();
            
            // Posicionar no final da pilha
            const totalCartas = todasCartas.length;
            const posicaoFinal = totalCartas - 1;
            
            // Aplicar posi√ß√£o de final da pilha
            cartaJogadaElement.classList.remove('topo', 'meio', 'fundo');
            
            if (posicaoFinal === 0) {
                // Se s√≥ h√° uma carta, ela volta para o topo
                cartaJogadaElement.classList.add('topo');
                cartaJogadaElement.style.zIndex = '10';
                
                // Recriar bot√µes de a√ß√£o
                const novosAcoes = document.createElement('div');
                novosAcoes.className = 'acoes-carta';
                const cartinhaId = cartaJogadaElement.dataset.cartinhaId;
                novosAcoes.innerHTML = `
                    <button class="btn-acao btn-jogar-esquerda" onclick="jogarCartaEsquerda(${cartinhaId})" title="Jogar para esquerda">
                        ‚Üê
                    </button>
                    <button class="btn-acao btn-ler" onclick="abrirCartinha(${cartinhaId})" title="Ler carta">
                        üìñ
                    </button>
                    <button class="btn-acao btn-jogar-direita" onclick="jogarCartaDireita(${cartinhaId})" title="Jogar para direita">
                        ‚Üí
                    </button>
                `;
                cartaJogadaElement.appendChild(novosAcoes);
            } else if (posicaoFinal === 1) {
                cartaJogadaElement.classList.add('meio');
                cartaJogadaElement.style.zIndex = '5';
            } else {
                cartaJogadaElement.classList.add('fundo');
                cartaJogadaElement.style.zIndex = '1';
            }
            
            // Atualizar contador da carta para mostrar nova posi√ß√£o
            const infoContainer = cartaJogadaElement.querySelector('.contador-cartas');
            if (infoContainer) {
                infoContainer.textContent = `Carta ${posicaoFinal + 1} de ${totalCartas}`;
            }
            
            // Animar volta para posi√ß√£o com efeito suave
            cartaJogadaElement.style.transition = 'all 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
            cartaJogadaElement.style.opacity = '1';
            cartaJogadaElement.style.pointerEvents = 'auto';
        }
    }, 1000);
}

// ==================== Utilit√°rios ====================
function formatarData(dataISO) {
    const data = new Date(dataISO);
    const agora = new Date();
    const diffMs = agora - data;
    const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));

    if (diffDias === 0) {
        return `Hoje √†s ${data.getHours().toString().padStart(2, '0')}:${data.getMinutes().toString().padStart(2, '0')}`;
    } else if (diffDias === 1) {
        return `Ontem √†s ${data.getHours().toString().padStart(2, '0')}:${data.getMinutes().toString().padStart(2, '0')}`;
    } else if (diffDias < 7) {
        return `${diffDias} dias atr√°s`;
    } else {
        return data.toLocaleDateString('pt-BR');
    }
}

function cortarTexto(texto, limite) {
    if (texto.length <= limite) return texto;
    return texto.substring(0, limite) + '...';
}

// ==================== Abrir cartinha no modal ====================
function abrirCartinha(cartinhaId) {
    if (cartinhaId === null || cartinhaId === undefined || isNaN(cartinhaId)) {
        console.warn('abrirCartinha chamado com id inv√°lido:', cartinhaId);
        return;
    }
    const cartinha = encontrarCartinha(cartinhaId);
    if (!cartinha) {
        console.warn('Cartinha n√£o encontrada para id:', cartinhaId);
        return;
    }

    const usuario = encontrarUsuarioPorCartinha(cartinhaId);
    if (!usuario) {
        console.warn('Usu√°rio n√£o encontrado para cartinha id:', cartinhaId);
        return;
    }

    // Verificar se a carta est√° no DOM e carreg√°-la se necess√°rio
    const cartaElement = document.getElementById(`carta-${cartinhaId}`);
    if (!cartaElement) {
        carregarCartaEspecifica(usuario.userId, cartinhaId);
    }

    // Marcar como lida
    if (!cartinha.lida) {
        marcarComoLida(cartinhaId);
    }

    // Usar o modal compartilhado
    window.modalCartinha.abrir({
        tipo: 'recebidas',
        cartinha: cartinha,
        usuario: usuario,
        badges: [
            cartinha.favoritada ? 
                { icone: '‚≠ê', texto: 'Favoritada', cor: '#f39c12', corTexto: 'white' } : null
        ].filter(Boolean),
        acoes: [
            {
                id: 'excluir',
                icone: 'üóëÔ∏è',
                texto: 'Excluir',
                classe: 'btn-outline-danger',
                callback: (carta, user) => {
                    window.modalCartinha.fechar();
                    setTimeout(() => confirmarExclusao(carta.id), 300);
                }
            },
            {
                id: 'favoritar',
                icone: cartinha.favoritada ? 'üíî' : '‚≠ê',
                texto: cartinha.favoritada ? 'Desfavoritar' : 'Favoritar',
                classe: cartinha.favoritada ? 'btn-outline-warning' : 'btn-warning',
                callback: (carta, user) => {
                    toggleFavorito(carta.id);
                }
            },
            {
                id: 'responder',
                icone: '‚úâÔ∏è',
                texto: 'Responder',
                classe: 'btn-primary',
                callback: (carta, user) => {
                    window.modalCartinha.fechar();
                    setTimeout(() => responderCartinha(user.userId, user.username), 300);
                }
            }
        ],
        atalhosTeclado: {
            'f': {
                callback: (carta, user) => {
                    toggleFavorito(carta.id);
                }
            },
            'r': {
                callback: (carta, user) => {
                    window.modalCartinha.fechar();
                    setTimeout(() => responderCartinha(user.userId, user.username), 300);
                }
            },
            'd': {
                callback: (carta, user) => {
                    window.modalCartinha.fechar();
                    setTimeout(() => confirmarExclusao(carta.id), 300);
                }
            }
        }
    });
}

// Alterna o status de favorito da cartinha
async function toggleFavorito(cartinhaId) {
    try {
        const response = await fetch(`/api/cartinhas/${cartinhaId}/toggle-favorito`, {
            method: 'POST',
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`Erro: ${response.status}`);
        }

        const result = await response.json();
        
        // Atualizar estado local
        const cartinha = encontrarCartinha(cartinhaId);
        if (cartinha) {
            cartinha.favoritada = result.favoritada;
            
            // Fechar e reabrir modal para atualizar o visual
            window.modalCartinha.fechar();
            setTimeout(() => abrirCartinha(cartinhaId), 300);
            
            // Atualizar o indicador visual na carta
            const cartaElement = document.getElementById(`carta-${cartinhaId}`);
            if (cartaElement) {
                // Remover indicador existente se houver
                const seloExistente = cartaElement.querySelector('.selo-favorita');
                if (seloExistente) {
                    seloExistente.remove();
                }
                
                // Adicionar novo indicador se favoritada
                if (cartinha.favoritada) {
                    const seloFavorita = document.createElement('div');
                    seloFavorita.className = 'selo-favorita adicionado';
                    seloFavorita.textContent = '‚≠ê';
                    cartaElement.appendChild(seloFavorita);
                    
                    // Remover a classe adicionado ap√≥s a anima√ß√£o
                    setTimeout(() => {
                        seloFavorita.classList.remove('adicionado');
                    }, 800);
                }
            }
            
            // Mostrar feedback ao usu√°rio
            mostrarFeedback(result.message, 'success');
        }
    } catch (error) {
        console.error('Erro ao alterar status de favorito:', error);
        mostrarFeedback('N√£o foi poss√≠vel alterar o status de favorito.', 'danger');
    }
}

// ==================== Fun√ß√µes auxiliares ====================
function encontrarCartinha(cartinhaId) {
    if (!window.usuariosProcessados) return null;
    for (const usuario of window.usuariosProcessados) {
        const cartinha = usuario.cartinhas.find(c => c.id === cartinhaId);
        if (cartinha) return cartinha;
    }
    return null;
}

function encontrarUsuarioPorCartinha(cartinhaId) {
    if (!window.usuariosProcessados) return null;
    return window.usuariosProcessados.find(usuario => 
        usuario.cartinhas.some(c => c.id === cartinhaId)
    );
}

async function marcarComoLida(cartinhaId) {
    try {
        const response = await fetch(`/api/cartinhas/${cartinhaId}/lida`, {
            method: 'PUT', // Alterado para PUT conforme a documenta√ß√£o da API
            credentials: 'include'
        });

        if (!response.ok) {
            throw new Error(`Erro: ${response.status}`);
        }
        
        const result = await response.json();
        
        // Atualizar localmente
        const cartinha = encontrarCartinha(cartinhaId);
        if (cartinha) {
            cartinha.lida = true;
            
            // Encontrar o usu√°rio e atualizar contador de n√£o lidas
            const usuario = encontrarUsuarioPorCartinha(cartinhaId);
            if (usuario) {
                // Recalcular o n√∫mero de cartas n√£o lidas
                const cartasNaoLidas = usuario.cartinhas.filter(c => !c.lida).length;
                usuario.naoLidas = cartasNaoLidas;
                
                // Tamb√©m atualizar no array window.usuariosProcessados
                if (window.usuariosProcessados) {
                    const usuarioProcessado = window.usuariosProcessados.find(u => u.userId === usuario.userId);
                    if (usuarioProcessado) {
                        usuarioProcessado.naoLidas = cartasNaoLidas;
                    }
                }
                
                // Atualizar contador visual na pilha
                const pilha = document.getElementById(`pilha-${usuario.userId}`);
                if (pilha) {
                    const contadorPilha = pilha.querySelector('.contador-pilha');
                    if (contadorPilha) {
                        if (cartasNaoLidas > 0) {
                            contadorPilha.textContent = cartasNaoLidas;
                            contadorPilha.style.display = 'flex'; // Garantir que est√° vis√≠vel
                        } else {
                            contadorPilha.remove(); // Remove o contador se n√£o h√° cartas n√£o lidas
                        }
                    }
                }
            }
            
            // Atualizar visualmente o selo da carta
            const cartaElement = document.getElementById(`carta-${cartinhaId}`);
            if (cartaElement) {
                const selo = cartaElement.querySelector('.selo');
                if (selo) {
                    selo.classList.remove('nova');
                    selo.textContent = '‚úì';
                }
                
                // Atualizar t√≠tulo se n√£o estava lida
                const titulo = cartaElement.querySelector('.titulo-carta');
                if (titulo) {
                    titulo.classList.remove('text-primary');
                }
            }
        }
    } catch (error) {
        console.error('Erro ao marcar cartinha como lida:', error);
        mostrarFeedback('N√£o foi poss√≠vel marcar a cartinha como lida.', 'danger');
    }
}

function responderCartinha(userId, username) {
    // Fechar modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('cartinhaModal'));
    modal.hide();
    
    // Redirecionar para a tela de escrever cartinha com par√¢metros
    window.location.href = `/cartinhas/escrever?para=${userId}&nome=${encodeURIComponent(username)}`;
}

// ==================== Fun√ß√µes de carregamento sob demanda ====================
// Renderizar apenas as pilhas vis√≠veis
function renderizarPilhasVisiveis() {
    const pilhasVisiveis = document.querySelectorAll('.pilha-cartas.ativa, .pilha-cartas.segunda, .pilha-cartas.terceira');
    
    pilhasVisiveis.forEach(pilha => {
        const usuarioIndex = parseInt(pilha.dataset.usuarioIndex);
        const carregada = pilha.dataset.carregada === 'true';
        
        if (!carregada && window.usuariosProcessados && window.usuariosProcessados[usuarioIndex]) {
            carregarCartasParaPilha(pilha, usuarioIndex);
        }
    });
}

// Carregar cartas para uma pilha espec√≠fica
function carregarCartasParaPilha(pilhaElement, usuarioIndex) {
    const usuario = window.usuariosProcessados[usuarioIndex];
    if (!usuario) return;
    
    // Inicializar o √≠ndice de ciclo se n√£o existir
    if (!usuario.indiceCiclo) usuario.indiceCiclo = 0;
    
    const cartasDoUsuario = usuario.cartinhas;
    const totalCartas = cartasDoUsuario.length;
    let html = '';
    
    // Renderizar apenas as primeiras 3 cartas (topo, meio, fundo) para economizar recursos
    // O resto ser√° carregado somente quando necess√°rio
    const cartasParaRenderizar = cartasDoUsuario.slice(0, Math.min(3, totalCartas));
    
    cartasParaRenderizar.forEach((cartinha, index) => {
        const dataFormatada = formatarData(cartinha.dataEnvio);
        const isNaoLida = !cartinha.lida;
        
        // Determinar posi√ß√£o na pilha de cartas
        let posicaoClasse = '';
        if (index === 0) posicaoClasse = 'topo';
        else if (index === 1) posicaoClasse = 'meio';
        else posicaoClasse = 'fundo';
        
        // Calcular a posi√ß√£o real da carta considerando o ciclo
        const posicaoReal = (usuario.indiceCiclo + index) % totalCartas + 1;
        
        html += `
            <div class="carta-empilhada carta-envelope ${posicaoClasse}" 
                id="carta-${cartinha.id}" 
                data-cartinha-id="${cartinha.id}"
                data-usuario-id="${usuario.userId}"
                data-posicao="${index}"
                style="z-index: ${10 - index}">
                
                <!-- Nome do usu√°rio no topo -->
                <div style="position: absolute; top: 5px; left: 15px; z-index: 4; background: rgba(108, 92, 231, 0.9); color: white; padding: 0.4rem 1rem; border-radius: 0 0 12px 0; font-weight: 600; font-size: 0.95rem; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
                    ${usuario.username}
                </div>
                
                <!-- Aba do envelope -->
                <div class="envelope-flap"></div>
                
                <!-- Selo -->
                <div class="selo ${isNaoLida ? 'nova' : ''}">
                    ${isNaoLida ? 'NOVA' : '‚úì'}
                </div>
                
                <!-- Indicador de favorito -->
                ${cartinha.favoritada ? `
                <div class="selo-favorita">‚≠ê</div>
                ` : ''}
                
                <!-- Cabe√ßalho com informa√ß√µes do remetente -->
                <div class="envelope-header">
                    <div class="remetente-info">
                        <img src="${usuario.avatar}" alt="Avatar" class="avatar-carta">
                        <div>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span class="contador-cartas">
                                    Carta ${posicaoReal} de ${totalCartas}
                                </span>
                                <small style="color: #74b9ff; font-weight: 500;">${dataFormatada}</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Papel da cartinha -->
                <div class="cartinha-papel papel-linhas">
                    <h3 class="titulo-carta ${isNaoLida ? 'text-primary' : ''}">${cartinha.titulo || ''}</h3>
                    <div class="conteudo-carta">${cortarTexto(cartinha.conteudo || '', 120)}</div>
                    <div class="data-carta">Recebida em ${dataFormatada}</div>
                </div>

                <!-- Bot√µes de a√ß√£o apenas na carta do topo da pilha ativa -->
                ${usuarioIndex === window.pilhaAtivaIndex && index === 0 ? `
                    <div class="acoes-carta">
                        <button class="btn-acao btn-ler" onclick="abrirCartinha(${cartinha.id})" title="Ler carta">
                            üìñ
                        </button>
                    </div>
                ` : ''}
            </div>
        `;
    });
    
    // Adicionar o HTML gerado √† pilha
    pilhaElement.insertAdjacentHTML('beforeend', html);
    
    // Marcar pilha como carregada
    pilhaElement.dataset.carregada = 'true';
    
    // Adicionar evento de clique na carta do topo para abrir
    const cartaTopo = pilhaElement.querySelector('.carta-empilhada.topo');
    if (cartaTopo) {
        cartaTopo.addEventListener('click', (e) => {
            if (!e.target.closest('.btn-acao')) {  // Evitar conflito com cliques nos bot√µes de a√ß√£o
                const cartinhaId = parseInt(cartaTopo.dataset.cartinhaId);
                abrirCartinha(cartinhaId);
            }
        });
    }
}

// Descarregar pilhas n√£o vis√≠veis para economizar mem√≥ria
function descarregarPilhasInvisiveis() {
    const pilhasNaoVisiveis = document.querySelectorAll('.pilha-cartas:not(.ativa):not(.segunda):not(.terceira):not(.quarta)');
    
    pilhasNaoVisiveis.forEach(pilha => {
        // Se a pilha j√° foi carregada
        if (pilha.dataset.carregada === 'true') {
            // Remove todas as cartas, mas mant√©m a estrutura da pilha e o contador
            const cartasParaRemover = pilha.querySelectorAll('.carta-empilhada');
            cartasParaRemover.forEach(carta => carta.remove());
            
            // Marcar como n√£o carregada
            pilha.dataset.carregada = 'false';
        }
    });
}

// Carregar carta espec√≠fica sob demanda (quando necess√°rio)
function carregarCartaEspecifica(usuarioId, cartinhaId) {
    const usuario = window.usuariosProcessados.find(u => u.userId === usuarioId);
    if (!usuario) return null;
    
    const cartinha = usuario.cartinhas.find(c => c.id === cartinhaId);
    if (!cartinha) return null;
    
    // J√° existe esta carta no DOM?
    const cartaExistente = document.getElementById(`carta-${cartinhaId}`);
    if (cartaExistente) return cartaExistente;
    
    // Encontrar pilha correspondente
    const pilha = document.getElementById(`pilha-${usuarioId}`);
    if (!pilha) return null;
    
    // Encontrar √≠ndice da cartinha
    const index = usuario.cartinhas.findIndex(c => c.id === cartinhaId);
    
    // Inicializar o √≠ndice de ciclo se n√£o existir
    if (!usuario.indiceCiclo) usuario.indiceCiclo = 0;
    
    // Calcular a posi√ß√£o real da carta considerando o ciclo
    const posicaoReal = (usuario.indiceCiclo + index) % usuario.cartinhas.length + 1;
    
    const dataFormatada = formatarData(cartinha.dataEnvio);
    const isNaoLida = !cartinha.lida;
    
    // Criar elemento da carta
    const cartaElement = document.createElement('div');
    cartaElement.className = `carta-empilhada carta-envelope`;
    cartaElement.id = `carta-${cartinha.id}`;
    cartaElement.dataset.cartinhaId = cartinha.id;
    cartaElement.dataset.usuarioId = usuario.userId;
    cartaElement.dataset.posicao = index;
    cartaElement.style.zIndex = 10 - index;
    
    cartaElement.innerHTML = `
        <!-- Nome do usu√°rio no topo -->
        <div style="position: absolute; top: 5px; left: 15px; z-index: 4; background: rgba(108, 92, 231, 0.9); color: white; padding: 0.4rem 1rem; border-radius: 0 0 12px 0; font-weight: 600; font-size: 0.95rem; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">
            ${usuario.username}
        </div>
        
        <!-- Aba do envelope -->
        <div class="envelope-flap"></div>
        
        <!-- Selo -->
        <div class="selo ${isNaoLida ? 'nova' : ''}">
            ${isNaoLida ? 'NOVA' : '‚úì'}
        </div>
        
        <!-- Indicador de favorito -->
        ${cartinha.favoritada ? `
        <div class="selo-favorita">‚≠ê</div>
        ` : ''}
        
        <!-- Cabe√ßalho com informa√ß√µes do remetente -->
        <div class="envelope-header">
            <div class="remetente-info">
                <img src="${usuario.avatar}" alt="Avatar" class="avatar-carta">
                <div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span class="contador-cartas">
                            Carta ${posicaoReal} de ${usuario.cartinhas.length}
                        </span>
                        <small style="color: #74b9ff; font-weight: 500;">${dataFormatada}</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Papel da cartinha -->
        <div class="cartinha-papel papel-linhas">
            <h3 class="titulo-carta ${isNaoLida ? 'text-primary' : ''}">${cartinha.titulo || ''}</h3>
            <div class="conteudo-carta">${cortarTexto(cartinha.conteudo || '', 120)}</div>
            <div class="data-carta">Recebida em ${dataFormatada}</div>
        </div>
    `;
    
    pilha.appendChild(cartaElement);
    return cartaElement;
}

// ==================== Inicializa√ß√£o ====================
document.addEventListener('DOMContentLoaded', () => {
    carregarCartinhas();
    
    // Adicionar eventos de teclado para navega√ß√£o
    document.addEventListener('keydown', (e) => {
        // Verificar se h√° pilhas carregadas
        if (window.totalPilhas === undefined || window.totalPilhas === 0) return;
        
        // Ignorar eventos de teclado quando um modal estiver aberto
        const modalAberto = document.querySelector('.modal.show');
        if (modalAberto) return;
        
        switch(e.key) {
            case 'ArrowUp':
                e.preventDefault();
                trocarPilhaAnterior();
                break;
            case 'ArrowDown':
                e.preventDefault();
                trocarProximaPilha();
                break;
            case 'ArrowLeft':
            case 'ArrowRight':
                e.preventDefault();
                ciclarCartasPilhaAtiva();
                break;
            case 'Enter':
            case ' ':
                e.preventDefault();
                lerCartaAtiva();
                break;
        }
    });
    
    // Adicionar teclas de atalho para o modal da carta
    document.addEventListener('keydown', (e) => {
        const modalAberto = document.querySelector('.modal.show');
        if (!modalAberto) return;
        
        // Tecla 'F' para favoritar
        if (e.key === 'f' || e.key === 'F') {
            e.preventDefault();
            const favoritarBtn = document.getElementById('favoritar-btn');
            if (favoritarBtn) favoritarBtn.click();
        }
        
        // Tecla 'R' para responder
        if (e.key === 'r' || e.key === 'R') {
            e.preventDefault();
            const responderBtn = document.getElementById('responder-btn');
            if (responderBtn) responderBtn.click();
        }
        
        // Tecla 'D' para excluir
        if (e.key === 'd' || e.key === 'D') {
            e.preventDefault();
            const excluirBtn = document.getElementById('excluir-btn');
            if (excluirBtn) excluirBtn.click();
        }
    });
    
    // Focar na primeira pilha ao carregar
    setTimeout(() => {
        const primeiraPilha = document.querySelector('.pilha-cartas');
        if (primeiraPilha) {
            primeiraPilha.classList.add('focada');
            atualizarBotoesNavegacao();
        }
    }, 500);
    
    // Adicionar listener para rolagem da p√°gina para otimizar desempenho
    window.addEventListener('scroll', () => {
        if (window.scrollTimeout) {
            clearTimeout(window.scrollTimeout);
        }
        window.scrollTimeout = setTimeout(() => {
            descarregarPilhasInvisiveis();
        }, 300);
    });
});

// ==================== Feedback e notifica√ß√µes ====================
function mostrarFeedback(mensagem, tipo = 'success') {
    // Verificar se o elemento j√° existe
    let container = document.querySelector('.feedback-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'feedback-container';
        container.style.cssText = 'position: fixed; bottom: 2rem; right: 2rem; z-index: 9999;';
        document.body.appendChild(container);
    }

    // Criar elemento de toast
    const toast = document.createElement('div');
    toast.className = `toast align-items-center text-white bg-${tipo} border-0 mb-2`;
    toast.setAttribute('role', 'alert');
    toast.setAttribute('aria-live', 'assertive');
    toast.setAttribute('aria-atomic', 'true');
    
    toast.innerHTML = `
        <div class="d-flex">
            <div class="toast-body">
                ${mensagem}
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Fechar"></button>
        </div>
    `;
    
    container.appendChild(toast);
    
    // Inicializar toast
    const bsToast = new bootstrap.Toast(toast, {
        autohide: true,
        delay: 3000
    });
    bsToast.show();
    
    // Remover o toast depois de fechado
    toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
    });
}

// ==================== Navega√ß√£o entre pilhas ====================
function atualizarBotoesNavegacao() {
    const pilhas = Array.from(document.querySelectorAll('.pilha-cartas'));
    const pilhaFocada = document.querySelector('.pilha-cartas.focada');
    
    if (!pilhaFocada || pilhas.length <= 1) {
        // Desabilitar todos os bot√µes se n√£o h√° pilha focada ou s√≥ h√° uma pilha
        document.querySelectorAll('.btn-pilha-anterior, .btn-proxima-pilha').forEach(btn => {
            btn.disabled = true;
        });
        return;
    }
    
    const indiceAtual = pilhas.indexOf(pilhaFocada);
    
    // Atualizar bot√µes na pilha focada
    const btnAnterior = pilhaFocada.querySelector('.btn-pilha-anterior');
    const btnProximo = pilhaFocada.querySelector('.btn-proxima-pilha');
    
    if (btnAnterior) btnAnterior.disabled = false;
    if (btnProximo) btnProximo.disabled = false;
    
    // Desabilitar bot√µes em outras pilhas
    pilhas.forEach((pilha, index) => {
        if (index !== indiceAtual) {
            const btnAnt = pilha.querySelector('.btn-pilha-anterior');
            const btnProx = pilha.querySelector('.btn-proxima-pilha');
            if (btnAnt) btnAnt.disabled = true;
            if (btnProx) btnProx.disabled = true;
        }
    });
}

// ==================== Fun√ß√£o de exclus√£o de cartinha ====================
function confirmarExclusao(cartinhaId) {
    // Fechar o modal da carta
    const cartinhaModal = bootstrap.Modal.getInstance(document.getElementById('cartinhaModal'));
    cartinhaModal.hide();
    
    // Criar modal de confirma√ß√£o
    let confirmationModal = document.getElementById('confirmDeleteModal');
    
    // Se o modal ainda n√£o existe, cri√°-lo
    if (!confirmationModal) {
        const modalHtml = `
            <div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">‚ö†Ô∏è Confirmar exclus√£o</h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                        </div>
                        <div class="modal-body">
                            <p>Tem certeza que deseja <strong>excluir permanentemente</strong> esta cartinha?</p>
                            <div class="alert alert-warning" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                                Esta a√ß√£o n√£o pode ser desfeita!
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                                Excluir permanentemente
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        confirmationModal = document.getElementById('confirmDeleteModal');
    }
    
    // Configurar o bot√£o de confirmar exclus√£o
    const confirmBtn = confirmationModal.querySelector('#confirmDeleteBtn');
    confirmBtn.onclick = () => excluirCartinha(cartinhaId);
    
    // Mostrar o modal de confirma√ß√£o
    const modal = new bootstrap.Modal(confirmationModal);
    modal.show();
    
    // Quando o modal de confirma√ß√£o for fechado sem confirma√ß√£o, reabrir o modal da cartinha
    confirmationModal.addEventListener('hidden.bs.modal', function reopen() {
        confirmationModal.removeEventListener('hidden.bs.modal', reopen);
        if (!window.cartinhaExcluida) {
            // Reabrir o modal da cartinha apenas se n√£o foi exclu√≠da
            setTimeout(() => abrirCartinha(cartinhaId), 100);
        }
    });
}

// Fun√ß√£o para excluir a cartinha via API
async function excluirCartinha(cartinhaId) {
    try {
        window.cartinhaExcluida = false;
        
        // Desabilitar o bot√£o de confirma√ß√£o e mostrar indicador de carregamento
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        const originalText = confirmBtn.innerHTML;
        confirmBtn.disabled = true;
        confirmBtn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Excluindo...`;
        
        // Chamada √† API para excluir a cartinha
        const response = await fetch(`/api/cartinhas/${cartinhaId}`, {
            method: 'DELETE',
            credentials: 'include'
        });

        // Processar resposta
        if (response.ok) {
            const result = await response.json();
            
            // Marcar como exclu√≠da para evitar reabrir o modal
            window.cartinhaExcluida = true;
            
            // Fechar o modal de confirma√ß√£o
            const confirmationModal = bootstrap.Modal.getInstance(document.getElementById('confirmDeleteModal'));
            confirmationModal.hide();
            
            // Remover a cartinha do array local
            const cartinha = encontrarCartinha(cartinhaId);
            const usuario = encontrarUsuarioPorCartinha(cartinhaId);
            
            if (usuario && cartinha) {
                // Remover a cartinha do array do usu√°rio
                const index = usuario.cartinhas.findIndex(c => c.id === cartinhaId);
                if (index !== -1) {
                    usuario.cartinhas.splice(index, 1);
                }
                
                // Remover o elemento da cartinha no DOM
                const cartaElement = document.getElementById(`carta-${cartinhaId}`);
                if (cartaElement) {
                    cartaElement.remove();
                }
                
                // Se n√£o houver mais cartinhas para este usu√°rio, remover a pilha
                if (usuario.cartinhas.length === 0) {
                    // Remover o usu√°rio do array
                    const userIndex = window.usuariosProcessados.findIndex(u => u.userId === usuario.userId);
                    if (userIndex !== -1) {
                        window.usuariosProcessados.splice(userIndex, 1);
                    }
                    
                    // Remover a pilha
                    const pilha = document.getElementById(`pilha-${usuario.userId}`);
                    if (pilha) {
                        pilha.remove();
                    }
                    
                    // Renderizar novamente se n√£o houver mais cartinhas
                    if (window.usuariosProcessados.length === 0) {
                        const container = document.getElementById('cartinhas-container');
                        const semCartinhas = document.getElementById('sem-cartinhas');
                        container.style.display = 'none';
                        semCartinhas.style.display = 'block';
                    }
                }
                
                // Mostrar feedback de sucesso
                mostrarFeedback(result.message || "Cartinha exclu√≠da com sucesso!", "success");
            }
        } else {
            const result = await response.json();
            
            // Mostrar mensagem de erro
            mostrarFeedback(result.message || "Erro ao excluir cartinha", "danger");
            
            // Reabilitar bot√£o
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Erro ao excluir cartinha:', error);
        mostrarFeedback("Erro ao excluir cartinha. Por favor, tente novamente.", "danger");
        
        // Reabilitar bot√£o de confirma√ß√£o
        const confirmBtn = document.getElementById('confirmDeleteBtn');
        if (confirmBtn) {
            confirmBtn.disabled = false;
            confirmBtn.innerHTML = "Excluir permanentemente";
        }
    }
}
</script>