<link rel="stylesheet" href="/styles/global/chat-dm-common.css">

<style>
#chats-container { height: 100%; }
#sidebar { background-color: var(--verde); }
#info-area { background-color: var(--verde); }

.chat-card { cursor: pointer; margin-bottom: 0.5rem; }
.chat-card.card { border: none; background: transparent; }
.chat-card .card-body { padding: 0.75rem; border-radius: 0.6rem; transition: box-shadow .15s ease, transform .08s ease, background .15s ease; }
.chat-card:hover .card-body { background: #f9fafb; box-shadow: 0 6px 18px rgba(16,24,40,0.06); transform: translateY(-2px); }
.chat-card.active .card-body { background: #ede9fe; box-shadow: 0 8px 22px rgba(16,24,40,0.08); }

.unread-badge {
    background: #7c3aed;
    color: white;
    border-radius: 50%;
    padding: 0.2rem 0.5rem;
    font-size: 0.7rem;
}

.chat-icon-circle {
    width: 40px;
    height: 40px;
    background: var(--roxo);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
}

.chat-preview-info {
    text-align: center;
    padding: 2rem;
}

.chat-preview-icon {
    font-size: 4rem;
    color: var(--roxo);
    margin-bottom: 1rem;
}
</style>

<div id="chats-container" class="container-fluid" style="padding: 0px;">
    <div class="row h-100 g-3">
        <!-- Sidebar -->
        <div class="col-12 col-md-4 d-flex flex-column">
            <div class="card h-100 d-flex flex-column" id="sidebar">
                <div class="card-header">
                    <h5 class="mb-0">Salas Públicas</h5>
                </div>
                <div class="p-3">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="search-chat-input" placeholder="Filtrar salas...">
                        <span class="input-group-text"><i class="bi bi-filter"></i></span>
                    </div>
                </div>
                <div id="chat-list" class="flex-grow-1 overflow-auto px-2">
                    <div class="text-center p-3">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                        <p class="text-muted small mt-2">Carregando salas...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Área de Chat -->
        <div class="col-12 col-md-8">
            <div id="chat-area" class="card h-100 d-flex flex-column" style="display: none !important;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0" id="chat-title">Sala</h5>
                    <button class="btn btn-sm btn-outline-secondary d-md-none" onclick="voltarLista()">
                        <i class="bi bi-arrow-left"></i> Voltar
                    </button>
                </div>
                
                <div id="chat-messages" class="card-body position-relative" style="overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column;">
                    <!-- Mensagens aqui -->
                </div>

                <div class="card-footer">
                    <div class="input-group">
                        <textarea id="input-msg" class="form-control" placeholder="Digite sua mensagem..." rows="1" style="resize: none; overflow-y: auto; max-height: 120px;"></textarea>
                        <button id="send-btn" class="btn btn-primary">
                            <i class="bi bi-send"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Placeholder quando nada selecionado -->
            <div id="info-area" class="card h-100 d-flex flex-column">
                <div class="card-header">
                    <h5 class="mb-0">Detalhes da Sala</h5>
                </div>
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <div class="chat-preview-info">
                        <i class="bi bi-chat-quote chat-preview-icon"></i>
                        <h4>Selecione uma sala</h4>
                        <p class="text-muted">Escolha uma das salas ao lado para ver mais detalhes e entrar na conversa.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Módulos globais -->
<script src="/js/commons/ui-common.js"></script>
<script src="/js/commons/chat-dm-common.js"></script>

<script>
    const socket = window.appSocket;
    let allChats = [];
    let selectedChat = null;
    let currentUser = null;
    let allMessages = [];
    const bufferSize = 100;

    const chatArea = document.getElementById('chat-area');
    const infoArea = document.getElementById('info-area');
    const chatMessages = document.getElementById('chat-messages');
    const inputMsg = document.getElementById('input-msg');
    const sendBtn = document.getElementById('send-btn');
    const chatTitle = document.getElementById('chat-title');

    // Inicialização
    document.addEventListener('DOMContentLoaded', async () => {
        const resUser = await fetch('/api/users/me', { credentials: 'include' });
        currentUser = await resUser.json();
        
        await carregarChats();

        // Se houver um chatName na URL (passado pelo backend)
        const initialChatName = "<%= locals.chatName || '' %>";
        if (initialChatName) {
            const chat = allChats.find(c => c.nome === initialChatName || c.id.toString() === initialChatName);
            if (chat) selecionarChat(chat);
        }
    });

    async function carregarChats() {
        try {
            const res = await fetch('/api/chats', { credentials: 'include' });
            allChats = await res.json();
            renderizarLista(allChats);
        } catch (error) {
            console.error('[Chats] Erro ao carregar:', error);
            document.getElementById('chat-list').innerHTML = '<p class="text-danger text-center p-3">Erro ao carregar salas.</p>';
        }
    }

    function renderizarLista(chats) {
        const container = document.getElementById('chat-list');
        container.innerHTML = '';

        if (chats.length === 0) {
            container.innerHTML = '<p class="text-muted text-center p-3">Nenhuma sala encontrada.</p>';
            return;
        }

        chats.forEach(chat => {
            const card = document.createElement('div');
            card.dataset.id = chat.id;
            card.className = `chat-card card ${selectedChat?.id === chat.id ? 'active' : ''}`;
            card.innerHTML = `
                <div class="card-body d-flex gap-3 align-items-center">
                    <div class="chat-icon-circle">
                        <i class="bi bi-hash"></i>
                    </div>
                    <div style="flex:1; min-width:0;">
                        <div class="d-flex justify-content-between align-items-center">
                            <strong class="text-truncate">${chat.nome}</strong>
                            ${chat.unreadCount > 0 ? `<span class="unread-badge">${chat.unreadCount}</span>` : ''}
                        </div>
                        <small class="text-muted d-block">por ${chat.criado_por}</small>
                    </div>
                </div>
            `;
            card.onclick = () => selecionarChat(chat);
            container.appendChild(card);
        });
    }

    function selecionarChat(chat) {
        if (selectedChat?.id === chat.id) return;
        
        selectedChat = chat;
        chat.unreadCount = 0;
        renderizarLista(allChats);
        
        allMessages = [];
        chatMessages.innerHTML = '';
        
        // Atualiza URL sem recarregar
        window.history.pushState({}, '', `/chat/${chat.nome}`);

        // UI
        document.querySelectorAll('.chat-card').forEach(c => {
            c.classList.toggle('active', c.dataset.id == chat.id);
        });

        infoArea.style.setProperty('display', 'none', 'important');
        chatArea.style.setProperty('display', 'flex', 'important');
        chatTitle.innerText = `# ${chat.nome}`;

        // Mobile toggle
        if (window.innerWidth < 768) {
            document.getElementById('sidebar').parentElement.classList.add('d-none');
        }

        // Socket
        socket.emit('getMessages', { chatName: chat.nome, page: 1 });
    }

    function voltarLista() {
        document.getElementById('sidebar').parentElement.classList.remove('d-none');
        chatArea.style.setProperty('display', 'none', 'important');
        infoArea.style.setProperty('display', 'flex', 'important');
        selectedChat = null;
        window.history.pushState({}, '', '/chat');
    }

    // ==================== Socket.IO Events ====================
    socket.on('messagesLoaded', ({ chatId: loadedChatId, messages }) => {
        if (!selectedChat || (loadedChatId !== selectedChat.id && !selectedChat.id)) {
            // Se ainda não temos o ID do chat selecionado, mas o nome bate
            // (O backend retorna o ID no messagesLoaded)
            if (selectedChat) selectedChat.id = loadedChatId;
        }
        
        if (selectedChat?.id !== loadedChatId) return;

        allMessages = messages.map(msg => formatMessage(msg));
        chatMessages.innerHTML = '';
        allMessages.forEach(msg => renderMessage(msg));
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        socket.emit('joinChat', loadedChatId);
        socket.emit('markAsRead', { chatId: loadedChatId });
    });

    socket.on('newMessage', (data) => {
        const { chatId, message } = data;
        
        if (selectedChat?.id === chatId) {
            const formatted = formatMessage(message);
            allMessages.push(formatted);
            renderMessage(formatted);
            
            if (chatMessages.children.length > bufferSize) {
                chatMessages.removeChild(chatMessages.firstChild);
            }
            
            chatMessages.scrollTop = chatMessages.scrollHeight;

            if (formatted.username !== currentUser.username) {
                socket.emit('markAsRead', { chatId });
            }
        } else {
            // Incrementa contador se não for o chat atual
            const chat = allChats.find(c => c.id === chatId);
            if (chat && (message.User?.username || message.username) !== currentUser.username) {
                chat.unreadCount = (chat.unreadCount || 0) + 1;
                renderizarLista(allChats);
            }
        }
    });

    function formatMessage(msg) {
        return {
            id: msg.id,
            text: msg.mensagem,
            username: msg.User?.username || msg.username,
            tipo: (msg.User?.username || msg.username) === currentUser.username ? "usuario" : "outrousuario",
            createdAt: msg.created_at || new Date().toISOString()
        };
    }

    function renderMessage(msg) {
        ChatUtils.renderMessage(msg, chatMessages, {
            isMine: msg.tipo === 'usuario',
            showUsername: true,
            showTime: true
        });
    }

    // ==================== Envio ====================
    ChatUtils.setupMessageInput(inputMsg, sendBtn, (text) => {
        if (!selectedChat?.id) return;
        socket.emit('sendMessage', {
            chatId: selectedChat.id,
            mensagem: text
        });
    });

    // Filtro de busca
    document.getElementById('search-chat-input').addEventListener('input', (e) => {
        const term = e.target.value.toLowerCase();
        const filtered = allChats.filter(c => c.nome.toLowerCase().includes(term));
        renderizarLista(filtered);
    });
</script>
