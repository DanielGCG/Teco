<link rel="stylesheet" href="/styles/global/chat-dm-common.css">

<style>
#dms-container { height: 100%; }
</style>
<div id="dms-container" class="container-fluid" style="padding: 0px;">
    <div class="row h-100 g-3">
        <!-- Sidebar -->
        <div class="col-12 col-md-3 d-flex flex-column">
            <div class="card h-100 d-flex flex-column" id="sidebar">
                <div class="card-header">
                    <h5 class="mb-0">Conversas</h5>
                </div>
                <div class="p-3" style="position: relative; z-index: 5;">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="search-input" placeholder="Buscar usuários..." style="pointer-events: auto !important;">
                        <button class="btn btn-primary" id="search-btn"><i class="bi bi-search"></i></button>
                    </div>
                </div>
                <div id="search-results" class="px-2"></div>
                <hr>
                <div id="dm-list" class="flex-grow-1 overflow-auto px-2">
                    <p class="text-muted text-center p-3">Carregando...</p>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-9">
            <!-- Área de Chat -->
            <div id="chat-area" class="card h-100 d-flex flex-column">
                <div class="card-header d-flex align-items-center justify-content-between" id="chat-header">
                    <h5 class="mb-0 flex-grow-1" id="chat-title">Selecione uma conversa</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary d-md-none" onclick="voltarLista()">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </button>
                    </div>
                </div>
                
                <div class="card-body flex-grow-1 overflow-auto" id="chat-messages">
                </div>
                
                <div class="card-footer border-top" id="chat-input-footer">
                    <div class="input-group flex-nowrap" style="align-items: stretch;">
                        <textarea id="dm-input-msg" class="form-control" placeholder="Digite sua mensagem..." style="resize: none; max-height: 170px; min-height: 40px; line-height: 1.25; overflow-y: auto;"></textarea>
                        <button id="dm-send-btn" class="btn btn-primary">Enviar</button>
                    </div>
                </div>
            </div>

            <!-- Placeholder quando nada selecionado -->
            <div id="info-area" class="card h-100 d-flex flex-column">
                <div class="card-header">
                    <h5 class="mb-0">Detalhes da Conversa</h5>
                </div>
                <div class="card-body d-flex flex-column align-items-center justify-content-center">
                    <div class="chat-preview-info">
                        <i class="bi bi-chat-quote chat-preview-icon"></i>
                        <h4>Selecione uma conversa</h4>
                        <p class="text-muted">Escolha uma das conversas ao lado para iniciar um bate-papo.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- UI Utilities -->
<script src="/js/commons/chat-dm-common.js"></script>

<script>
    // Referência ao socket (será resolvida na inicialização)
    let socket = null;
    let selectedChatId = null;
    let allMessages = [];
    let todasConversas = []; // Cache local das conversas
    let currentUser = window.UserContext ? window.UserContext.get() : null;
    let currentChatOtherUser = null;

    // Elementos do DOM (Resolvidos após o carregamento)
    let chatMessages, chatInput, sendBtn, searchInput, searchBtn;

    function formatMessage(msg) {
        const user = currentUser || window.currentUser;
        const username = msg.Sender?.username || msg.username || 'Usuário';
        return {
            ...msg,
            username,
            isMine: user ? (username === user.username) : (msg.isMine || false),
            createdat: msg.createdat || new Date().toISOString()
        };
    }

    // Carrega lista de conversas
    async function carregarDMs() {
        try {
            console.log('[DMs] Carregando conversas...');
            const res = await fetch('/api/dms', { credentials: 'include' });
            if (!res.ok) throw new Error('Falha ao carregar DMs');
            
            todasConversas = await res.json();
            renderizarListaDMs();
        } catch (error) {
            console.error('[DMs] Erro ao carregar:', error);
            const dmList = document.getElementById('dm-list');
            if (dmList) dmList.innerHTML = '<p class="text-danger text-center p-3">Erro ao carregar conversas.</p>';
        }
    }

    // Renderiza a lista de cards na sidebar
    function renderizarListaDMs() {
        const dmList = document.getElementById('dm-list');
        if (!dmList) return;
        
        dmList.innerHTML = '';

        if (!todasConversas.length) {
            dmList.innerHTML = '<div class="text-center p-4 text-muted small"><p>Nenhuma conversa encontrada.</p></div>';
            return;
        }

        // Ordena por data da última mensagem (mais recente primeiro)
        const sortedConversas = [...todasConversas].sort((a, b) => 
            new Date(b.lastMessageAt || 0) - new Date(a.lastMessageAt || 0)
        );

        sortedConversas.forEach(conversa => {
            const card = UIUtils.createUserCard({
                ...conversa.otherUser,
                lastMessage: conversa.lastMessage,
                lastMessageAt: conversa.lastMessageAt,
                unreadCount: conversa.unreadCount
            }, { type: 'conversation', avatarSize: 40, showUnreadBadge: true });
            
            card.classList.add('conversation-card');
            card.dataset.chatId = conversa.publicid;
            card.setAttribute('data-user-id', conversa.otherUser?.publicid); // Para tracking de status
            if (selectedChatId === conversa.publicid) card.classList.add('active');
            card.addEventListener('click', () => abrirDM(conversa.publicid, conversa.otherUser?.username, conversa.otherUser));
            dmList.appendChild(card);
        });

        UIUtils.requestPageStatuses();
    }

    // Atualiza card de conversa específica sem dar fetch em tudo
    function atualizarCardDM(chatId, novaMensagem = null, isReadEvent = false) {
        const conversaIndex = todasConversas.findIndex(c => c.publicid === chatId);
        
        if (conversaIndex !== -1) {
            const conversa = todasConversas[conversaIndex];
            if (novaMensagem) {
                conversa.lastMessage = novaMensagem.message;
                conversa.lastMessageAt = novaMensagem.createdat;
                if (chatId !== selectedChatId && !isReadEvent) {
                    conversa.unreadCount = (conversa.unreadCount || 0) + 1;
                }
            }
            if (isReadEvent && chatId === selectedChatId) {
                conversa.unreadCount = 0;
            }
            renderizarListaDMs();
        } else {
            // Se a conversa não existe no cache, buscamos do servidor
            carregarDMs();
        }
    }

    // Busca usuários
    async function buscarUsuarios() {
        if (!searchInput) return;
        const query = searchInput.value.trim();
        const resultsContainer = document.getElementById('search-results');
        
        if (!query) return resultsContainer.innerHTML = '';

        resultsContainer.innerHTML = '<p class="text-muted small"><span class="spinner-border spinner-border-sm"></span> Buscando...</p>';
        try {
            const res = await fetch(`/api/dms/search?q=${encodeURIComponent(query)}`, { credentials: 'include' });
            const data = await res.json();

            if (!data.users || !data.users.length) {
                resultsContainer.innerHTML = '<p class="text-muted small p-2">Nenhum usuário encontrado</p>';
                return;
            }

            resultsContainer.innerHTML = '';
            data.users.forEach(user => {
                const btn = UIUtils.createActionButton({ icon: 'bi bi-chat', variant: 'primary', size: 'sm', onClick: () => {} });
                const card = UIUtils.createUserCard(user, { type: 'search', avatarSize: 40, actions: [btn] });
                card.setAttribute('data-user-id', user.publicid);
                card.querySelector('button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    iniciarDM(user.username);
                });
                resultsContainer.appendChild(card);
            });
        } catch (err) {
            console.error('[DMs] Erro na busca:', err);
            resultsContainer.innerHTML = '<p class="text-danger small p-2">Erro ao realizar busca</p>';
        }
    }

    // Inicia nova DM
    async function iniciarDM(username) {
        try {
            const res = await fetch('/api/dms', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include',
                body: JSON.stringify({ username })
            });
            const data = await res.json();
            
            // Limpa resultados de busca
            const resultsContainer = document.getElementById('search-results');
            if (resultsContainer) resultsContainer.innerHTML = '';
            if (searchInput) searchInput.value = '';

            if (res.status === 201 || res.status === 409) {
                await carregarDMs();
                const conversa = todasConversas.find(c => c.publicid === data.dmId);
                abrirDM(data.dmId, username, conversa?.otherUser);
            } else {
                if (window.mostrarAviso) window.mostrarAviso(data.message || 'Erro ao iniciar conversa');
                else alert(data.message || 'Erro ao iniciar conversa');
            }
        } catch (err) {
            console.error('[DMs] Erro ao iniciar conversa:', err);
        }
    }

    // Abre conversa
    function abrirDM(chatId, chatName, otherUserData = null) {
        currentChatOtherUser = otherUserData;
        selectedChatId = chatId;
        
        ChatLayout.showChat(chatName);

        if (chatInput) chatInput.disabled = false;
        if (sendBtn) sendBtn.disabled = false;
        
        document.querySelectorAll('.conversation-card').forEach(card => card.classList.remove('active'));
        const activeCard = document.querySelector(`[data-chat-id="${chatId}"]`);
        if (activeCard) {
            activeCard.classList.add('active');
            const badge = activeCard.querySelector('.unread-badge');
            if (badge) badge.remove();
        }
        
        if (chatMessages) chatMessages.innerHTML = '';
        allMessages = [];
        
        if (socket) {
            socket.emit('joinChat', chatId);
            socket.emit('getMessages', { chatId, page: 1, type: 'dm' });
        }
    }

    function voltarLista() {
        ChatLayout.hideChat();
        selectedChatId = null;
        document.querySelectorAll('.conversation-card').forEach(card => card.classList.remove('active'));
    }

    // Inicialização da página
    document.addEventListener('DOMContentLoaded', async () => {
        // Inicializa elementos
        chatMessages = document.getElementById('chat-messages');
        chatInput = document.getElementById('dm-input-msg');
        sendBtn = document.getElementById('dm-send-btn');
        searchInput = document.getElementById('search-input');
        searchBtn = document.getElementById('search-btn');

        // Resolve o socket global
        socket = window.appSocket || (window.SocketConnector ? window.SocketConnector.getSocket() : null);

        ChatLayout.init({});
        ChatLayout.hideChat(); 
        
        // Garante que o input de busca está ativo
        if (searchInput) {
            searchInput.disabled = false;
            searchInput.style.pointerEvents = 'auto';
            
            if (searchBtn) searchBtn.onclick = buscarUsuarios;
            searchInput.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    buscarUsuarios();
                }
            };
        }

        if (chatInput && sendBtn) {
            ChatUtils.setupMessageInput(chatInput, sendBtn, (mensagem) => {
                if (!selectedChatId || !socket) return;
                socket.emit('sendMessage', { 
                    chatId: selectedChatId, 
                    mensagem,
                    type: 'dm'
                });
            });
        }

        if (socket) {
            setupSocketListeners();
        } else {
            console.warn('[DMs] Socket não disponível imediatamente, aguardando...');
            // Tenta novamente em breve
            setTimeout(() => {
                socket = window.appSocket || (window.SocketConnector ? window.SocketConnector.getSocket() : null);
                if (socket) setupSocketListeners();
            }, 1000);
        }

        try {
            // Atualiza usuário se necessário
            if (!currentUser) {
                const resUser = await fetch('/api/users/me', { credentials: 'include' });
                if (resUser.ok) currentUser = await resUser.json();
            }
            
            await carregarDMs();
            
            // Suporte para abrir DM via query param ?user=username
            const urlParams = new URLSearchParams(window.location.search);
            const userParaAbrir = urlParams.get('user');
            if (userParaAbrir) iniciarDM(userParaAbrir);
            
        } catch (err) {
            console.error('[DMs] Erro na inicialização:', err);
        }
    });

    function setupSocketListeners() {
        if (!socket) return;

        socket.on('joinedChat', (data) => {
            if (data?.success) console.log('[Socket] Entrou no chat:', data.chatId);
        });

        socket.on('messagesLoaded', (data) => {
            if (!data || data.chatId !== selectedChatId) return;
            
            const { messages } = data;
            allMessages = messages.map(msg => formatMessage(msg));

            ChatUtils.renderMessages(allMessages, chatMessages, { 
                clearContainer: true, scrollToBottom: true, showUsername: false 
            });
            
            socket.emit('markAsRead', { chatId: selectedChatId });
            atualizarCardDM(selectedChatId, null, true);
        });

        socket.on('newMessage', (data) => {
            if (!data?.chatId || !data.message?.message) return;
            const { chatId, message } = data;
            
            if (chatId === selectedChatId) {
                const newMsg = formatMessage(message);
                allMessages.push(newMsg);
                ChatUtils.renderMessages([newMsg], chatMessages, { 
                    clearContainer: false, scrollToBottom: true, showUsername: false 
                });
                
                if (!newMsg.isMine) socket.emit('markAsRead', { chatId });
            }
            atualizarCardDM(chatId, message);
        });

        socket.on('messageRead', (data) => {
            if (!data) return;
            const { chatId, userId, lastReadMessageId } = data;
            
            const myUser = currentUser || window.currentUser;
            if (myUser && userId !== myUser.publicid && chatId === selectedChatId) {
                allMessages.forEach(msg => { if (msg.isMine) msg.isread = true; });
                ChatUtils.updateReadStatus(chatMessages, lastReadMessageId);
            }
            atualizarCardDM(chatId, null, true);
        });

        socket.on('error', (err) => console.error('[Socket] Erro:', err));
    }
</script>