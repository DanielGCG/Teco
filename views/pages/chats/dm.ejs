<link rel="stylesheet" href="/styles/global/chat-dm-common.css">

<style>
#dms-container { height: 100%; }
#sidebar { background-color: var(--verde); }
#chat-area { background-color: var(--verde); }

#chat-messages { height: 0; }

.dm-card { cursor: pointer; margin-bottom: 0.5rem; }
.dm-card.card { border: none; background: transparent; }
.dm-card .card-body { padding: 0.75rem; border-radius: 0.6rem; transition: box-shadow .15s ease, transform .08s ease, background .15s ease; }
.dm-card:hover .card-body { background: #f9fafb; box-shadow: 0 6px 18px rgba(16,24,40,0.06); transform: translateY(-2px); }
.dm-card.active .card-body { background: #ede9fe; box-shadow: 0 8px 22px rgba(16,24,40,0.08); }

.unread-badge {
    background: #7c3aed;
    color: white;
    border-radius: 50%;
    padding: 0.2rem 0.5rem;
    font-size: 0.7rem;
}

</style>
<div id="dms-container" class="container-fluid" style="padding: 0px;">
    <div class="row h-100 g-3">
        <!-- Sidebar -->
        <div class="col-12 col-md-3 d-flex flex-column">
            <div class="card h-100 d-flex flex-column" id="sidebar">
                <div class="card-header">
                    <h5 class="mb-0">Conversas</h5>
                </div>
                <div class="p-3">
                    <div class="input-group input-group-sm">
                        <input type="text" class="form-control" id="search-input" placeholder="Buscar usuários...">
                        <button class="btn btn-primary" id="search-btn"><i class="bi bi-search"></i></button>
                    </div>
                </div>
                <div id="search-results" class="px-2"></div>
                <hr>
                <div id="dm-list" class="flex-grow-1 overflow-auto px-2">
                    <p class="text-muted text-center p-3">Carregando...</p>
                </div>
            </div>
        </div>

        <div class="col-12 col-md-9">
            <!-- Área de Chat -->
            <div id="chat-area" class="card h-100 d-flex flex-column">
                <div class="card-header d-flex align-items-center justify-content-between" id="chat-header">
                    <h5 class="mb-0 flex-grow-1" id="chat-title">Selecione uma conversa</h5>
                    <button class="btn btn-sm btn-link" id="chat-user-info-btn" style="display: none; padding: 0px;">
                        <i class="bi bi-info-circle"></i>
                    </button>
                </div>
                
                <div class="card-body flex-grow-1 overflow-auto" id="chat-messages">
                    <div class="text-center text-muted mt-5">
                        <i class="bi bi-chat-dots" style="font-size: 3rem;"></i>
                        <p class="mt-3">Selecione uma conversa</p>
                    </div>
                </div>
                
                <div class="card-footer border-top" id="chat-input-footer" style="display: none;">
                    <div class="input-group flex-nowrap" style="align-items: stretch;">
                        <textarea id="dm-input-msg" class="form-control" placeholder="Digite sua mensagem..." disabled style="resize: none; max-height: 170px; min-height: 40px; line-height: 1.25; overflow-y: auto;"></textarea>
                        <button id="dm-send-btn" class="btn btn-primary" disabled>Enviar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- UI Utilities -->
<script src="/js/commons/ui-common.js"></script>
<script src="/js/commons/chat-dm-common.js"></script>

<script>
    const socket = window.appSocket;

    let selectedChatId = null;
    let allMessages = [];
    let currentUser = null;
    let currentChatOtherUser = null;

    // Elementos do DOM
    const chatMessages = document.getElementById('chat-messages');
    const chatInput = document.getElementById('dm-input-msg');
    const sendBtn = document.getElementById('dm-send-btn');
    const chatInputFooter = document.getElementById('chat-input-footer');
    const chatUserInfoBtn = document.getElementById('chat-user-info-btn');

    if (!socket) {
        console.error('[DMs] Socket.IO não disponível!');
    }

    // Função de reconexão
    function onSocketConnect() {
        if (selectedChatId) {
            socket.emit('joinChat', selectedChatId);
            socket.emit('getMessages', { chatId: selectedChatId, page: 1 });
        }
    }

    // Registra handler de reconexão
    if (window.SocketConnector) {
        SocketConnector.onReconnect(onSocketConnect);
    }

    chatUserInfoBtn.addEventListener('click', () => {
        if (currentChatOtherUser) {
            UserProfileModal.show(currentChatOtherUser, {
                onDmClick: () => console.log('[DM] Já estamos na conversa com', currentChatOtherUser.username)
            });
        }
    });

    // Carrega lista de conversas
    async function carregarDMs() {
        const res = await fetch('/api/dms', { credentials: 'include' });
        const conversas = await res.json();
        const dmList = document.getElementById('dm-list');
        dmList.innerHTML = '';

        if (!conversas.length) {
            dmList.innerHTML = '<p class="text-muted text-center p-3">Sem conversas</p>';
            return;
        }

        conversas.forEach(conversa => {
            const existingCard = dmList.querySelector(`[data-chat-id="${conversa.id}"]`);
            if (existingCard) existingCard.remove();

            const card = UIUtils.createUserCard({
                ...conversa.otherUser,
                lastMessage: conversa.lastMessage,
                lastMessageAt: conversa.lastMessageAt,
                unreadCount: conversa.unreadCount
            }, { type: 'conversation', avatarSize: 40, showUnreadBadge: true });
            
            if (selectedChatId === conversa.id) card.classList.add('active');
            card.setAttribute('data-chat-id', conversa.id);
            card.setAttribute('data-user-id', conversa.otherUser?.id);
            card.setAttribute('data-last-message-at', conversa.lastMessageAt || '0');
            card.addEventListener('click', () => abrirDM(conversa.id, conversa.otherUser?.username, conversa.otherUser));
            dmList.appendChild(card);
        });

        setTimeout(() => {
            const userIds = [...new Set([...document.querySelectorAll('[data-chat-id]')].map(c => c.getAttribute('data-user-id')).filter(Boolean).map(Number))];
            if (userIds.length) socket.emit('requestUserStatus', { userIds });
        }, 100);
    }

    // Atualiza card de conversa específica na sidebar
    async function atualizarCardDM(chatId) {
        try {
            const res = await fetch('/api/dms', { credentials: 'include' });
            const conversas = await res.json();
            const conversa = conversas.find(c => c.id === chatId);
            
            if (!conversa) return;
            
            const dmList = document.getElementById('dm-list');
            const existingCard = dmList.querySelector(`[data-chat-id="${chatId}"]`);
            
            // Cria novo card atualizado
            const newCard = UIUtils.createUserCard({
                ...conversa.otherUser,
                lastMessage: conversa.lastMessage,
                lastMessageAt: conversa.lastMessageAt,
                unreadCount: conversa.unreadCount
            }, { type: 'conversation', avatarSize: 40, showUnreadBadge: true });
            
            if (selectedChatId === conversa.id) newCard.classList.add('active');
            newCard.setAttribute('data-chat-id', conversa.id);
            newCard.setAttribute('data-user-id', conversa.otherUser?.id);
            newCard.setAttribute('data-last-message-at', conversa.lastMessageAt || '0');
            newCard.addEventListener('click', () => abrirDM(conversa.id, conversa.otherUser?.username, conversa.otherUser));
            
            // Remove card antigo
            if (existingCard) existingCard.remove();
            
            // Insere na posição correta baseado em lastMessageAt
            const allCards = [...dmList.querySelectorAll('[data-chat-id]')];
            const newTime = new Date(conversa.lastMessageAt || 0).getTime();
            let inserted = false;
            
            for (const card of allCards) {
                const cardTime = new Date(card.getAttribute('data-last-message-at') || 0).getTime();
                if (newTime > cardTime) {
                    dmList.insertBefore(newCard, card);
                    inserted = true;
                    break;
                }
            }
            
            if (!inserted) dmList.appendChild(newCard);
            
            // Atualiza status do usuário
            if (conversa.otherUser?.id) {
                socket.emit('requestUserStatus', { userIds: [conversa.otherUser.id] });
            }
        } catch (error) {
            console.error('[DMs] Erro ao atualizar card:', error);
        }
    }

    // Busca usuários
    async function buscarUsuarios() {
        const query = document.getElementById('search-input').value.trim();
        const resultsContainer = document.getElementById('search-results');
        
        if (!query) return resultsContainer.innerHTML = '';

        resultsContainer.innerHTML = '<p class="text-muted small"><span class="spinner-border spinner-border-sm"></span> Buscando...</p>';
        const res = await fetch(`/api/dms/search?q=${encodeURIComponent(query)}`, { credentials: 'include' });
        const data = await res.json();

        if (!data.users.length) return resultsContainer.innerHTML = '<p class="text-muted small">Nenhum usuário encontrado</p>';

        resultsContainer.innerHTML = '';
        data.users.forEach(user => {
            const btn = UIUtils.createActionButton({ icon: 'bi bi-chat', variant: 'primary', size: 'sm', onClick: () => {} });
            const card = UIUtils.createUserCard(user, { type: 'search', avatarSize: 40, actions: [btn] });
            card.setAttribute('data-user-id', user.id);
            card.querySelector('button').addEventListener('click', (e) => {
                e.stopPropagation();
                iniciarDM(user.username);
            });
            resultsContainer.appendChild(card);
        });
    }

    // Inicia nova DM
    async function iniciarDM(username) {
        const res = await fetch('/api/dms', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ username })
        });
        const data = await res.json();
        
        if (res.status === 201 || res.status === 409) {
            await carregarDMs();
            const conversasRes = await fetch('/api/dms', { credentials: 'include' });
            const conversas = await conversasRes.json();
            const conversa = conversas.find(c => c.id === data.dmId);
            abrirDM(data.dmId, username, conversa?.otherUser);
        }
    }

    // Abre conversa
    function abrirDM(chatId, chatName, otherUserData = null) {
        currentChatOtherUser = otherUserData;
        selectedChatId = chatId;
        document.getElementById('chat-title').textContent = chatName;
        chatInputFooter.style.display = '';
        chatInput.disabled = false;
        sendBtn.disabled = false;
        chatUserInfoBtn.style.display = currentChatOtherUser ? 'block' : 'none';
        
        document.querySelectorAll('.dm-card').forEach(card => card.classList.remove('active'));
        const activeCard = document.querySelector(`[data-chat-id="${chatId}"]`);
        if (activeCard) {
            activeCard.classList.add('active');
            const badge = activeCard.querySelector('.unread-badge');
            if (badge) badge.remove();
        }
        
        chatMessages.innerHTML = '';
        allMessages = [];
        
        socket.emit('joinChat', chatId);
        socket.emit('getMessages', { chatId, page: 1 });
    }

    ChatUtils.setupMessageInput(chatInput, sendBtn, (mensagem) => {
        if (!selectedChatId) return;
        socket.emit('sendMessage', { chatId: selectedChatId, mensagem });
    });

    // ---------------- Socket.IO Events ----------------
    socket.on('joinedChat', (data) => {
        if (data && data.success) {
            console.log('[Socket] Entrou no chat:', data.chatId);
        }
    });

    socket.on('messagesLoaded', (data) => {
        if (!data || data.chatId !== selectedChatId) return;
        
        const { chatId, messages } = data;
        const msgs = messages.map(msg => ({
            id: msg.id,
            username: msg.User?.username || 'Usuário',
            mensagem: msg.mensagem,
            isMine: msg.isMine,
            createdAt: msg.created_at,
            seen: msg.isRead || false
        }));

        // Sempre carregamento inicial simplificado
        allMessages = msgs;
        ChatUtils.renderMessages(allMessages, chatMessages, { 
            clearContainer: true, 
            scrollToBottom: true, 
            showUsername: false, 
            showTime: true 
        });
        
        socket.emit('markAsRead', { chatId });
        setTimeout(() => atualizarCardDM(chatId), 300);
    });

    socket.on('newMessage', (data) => {
        // Ignora eventos sem dados (usado apenas para atualizar contagem de notificações)
        if (!data || !data.chatId || !data.message?.mensagem) return;
        
        const { chatId, message } = data;
        
        if (chatId === selectedChatId) {
            // Adiciona mensagem ao chat atual
            const newMsg = {
                id: message.id,
                mensagem: message.mensagem,
                username: message.username,
                isMine: message.username === currentUser.username,
                createdAt: message.created_at || new Date().toISOString(),
                seen: false
            };
            
            allMessages.push(newMsg);
            ChatUtils.renderMessages(allMessages, chatMessages, { 
                clearContainer: true, 
                scrollToBottom: true, 
                showUsername: false, 
                showTime: true 
            });
            
            if (!newMsg.isMine) socket.emit('markAsRead', { chatId: selectedChatId });
        }
        
        // Sempre atualiza o card na sidebar (move para topo, atualiza preview, etc)
        atualizarCardDM(chatId);
    });

    socket.on('messageRead', (data) => {
        if (!data) return;
        
        const { chatId, userId, lastReadMessageId } = data;
        
        if (userId !== currentUser.id && chatId === selectedChatId) {
            // Atualiza status de leitura das mensagens no chat aberto
            allMessages.forEach(msg => {
                if (msg.isMine && msg.id <= lastReadMessageId) msg.seen = true;
            });
            ChatUtils.updateReadStatus(chatMessages, lastReadMessageId);
        }
        
        // Atualiza badge de não lidas na sidebar
        atualizarCardDM(chatId);
    });

    socket.on('userStatusChanged', (data) => {
        if (!data) return;
        
        const { userId, status } = data;
        
        document.querySelectorAll('[data-chat-id]').forEach(card => {
            if (card.getAttribute('data-user-id') == userId) {
                const indicator = card.querySelector('.position-absolute.rounded-circle');
                if (indicator) indicator.style.background = UIUtils.getStatusColor(status);
            }
        });
        
        if (currentChatOtherUser?.id === userId) {
            currentChatOtherUser.status = status;
            UserProfileModal.updateStatus(status);
        }
    });

    socket.on('userStatusBatch', (statusMap) => {
        Object.entries(statusMap).forEach(([userId, status]) => {
            document.querySelectorAll('[data-chat-id]').forEach(card => {
                if (card.getAttribute('data-user-id') == userId) {
                    const indicator = card.querySelector('.position-absolute.rounded-circle');
                    if (indicator) indicator.style.background = UIUtils.getStatusColor(status);
                }
            });
        });
    });

    socket.on('error', (error) => {
        console.error('[Socket] Erro:', error);
        alert('Erro: ' + error.message);
    });

    // Inicialização
    (async () => {
        const res = await fetch('/api/users/me', { credentials: 'include' });
        currentUser = await res.json();
        await carregarDMs();
        document.getElementById('search-btn').addEventListener('click', buscarUsuarios);
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') buscarUsuarios();
        });
    })();
</script>

<!-- Modal de perfil de usuário -->
<%- include('../../utils/modal-perfil-usuario') %>