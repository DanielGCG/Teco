<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Zilla+Slab:wght@400;700&family=Roboto:wght@400;700&family=Jersey+10&display=swap" rel="stylesheet">

<style>
    /* === Estilos Visuais Gerais === */
    body { transition: background-color 0.5s ease, background-image 0.5s ease; }

    main.container-glass {
        background: rgba(255, 255, 255, 0.25);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        border-radius: 16px;
        padding: 24px;
        margin: 20px auto;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.18);
        transition: all 0.5s ease;
    }

    /* === O CARD (Container do Item) === */
    .image-card {
        display: grid;
        grid-template-rows: 1fr auto; 
        width: 100%;
        height: 100%;
        
        /* Removemos qualquer padding/margin externo do card */
        padding: 0 !important; 
        margin: 0 !important;
        
        border: none !important;
        border-radius: 16px; 
        overflow: hidden; /* Garante que a imagem não vaze */
        background: var(--gallery-card-bg, rgba(255, 255, 255, 0.6));
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        position: relative;
    }

    .image-card.no-title {
        grid-template-rows: 1fr;
    }

    .image-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        z-index: 2;
    }

    /* === A IMAGEM / VÍDEO (Conteúdo) === */
    .media-preview-box {
        display: block;
        width: 100%;
        height: 100%;
        
        min-height: 0; /* Importante para grid */
        margin: 0;
        padding: 0;
        transition: object-fit 0.3s ease;
    }

    /* MODOS DE VISUALIZAÇÃO */
    .fit-cover { object-fit: cover; }
    .fit-contain { 
        object-fit: contain; 
        background-color: rgba(0,0,0,0.03);
    }

    /* === Placeholders === */
    .media-placeholder {
        width: 100%; height: 100%; display: flex;
        flex-direction: column; justify-content: center; align-items: center;
        color: white; margin: 0;
    }
    .placeholder-video { background-color: #212529; }
    .placeholder-audio { background: linear-gradient(135deg, #4a4e69 0%, #22223b 100%); }

    /* === Rodapé do Card (Título) === */
    .image-card .card-body {
        height: 32px !important;
        display: flex;
        align-items: center;
        background-color: var(--gallery-card-bg, #ffffff) !important;
        padding: 0 12px !important;
        border-top: 1px solid rgba(0,0,0,0.05);
        z-index: 10;
        overflow: hidden;
    }

    /* === GRID SYSTEM PRINCIPAL === */
    #lista-imagens {
        display: grid;
        grid-template-columns: repeat(var(--gallery-columns, 4), 1fr);
        grid-auto-rows: auto; 
        /* Gaps são os únicos espaçamentos aqui */
        gap: 15px; 
        
        /* Removemos qualquer margem/padding padrão do container grid */
        margin: 0 !important;
        padding: 0 !important;
        width: 100%;
    }

    .grid-item { 
        display: block;
        position: relative;
        aspect-ratio: var(--item-ratio, 1/1);
        min-width: 0;
        min-height: 0;
        padding: 0 !important;
        margin: 0 !important;
        height: 100%;
        width: 100%;
    }

    /* === Drag and Drop & UI === */
    .edit-overlay {
        position: absolute;
        top: 6px; 
        right: 6px;
        display: flex; 
        gap: 3px;
        z-index: 20;
        flex-wrap: wrap; 
        justify-content: flex-end;
        max-width: 100%;
        transform-origin: top right;
        transition: transform 0.2s ease;
    }

    .edit-overlay:hover {
        transform: scale(1.5);
        z-index: 30;
    }
    
    .btn-xs { 
        padding: 2px 5px;
        font-size: 1rem;
        line-height: 1;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        height: 32px;
    }

    .btn-xs i {
        font-size: 0.8rem;
    }

    /* Ajuste para os grupos de botões verticais (setas) */
    .edit-overlay .btn-group-vertical .btn-xs {
        height: 12px; /* Metade da altura para botões duplos */
        padding: 0 4px;
    }
    .edit-overlay .btn-group-vertical .btn-xs i {
        font-size: 0.65rem; /* Ícone menor para as setinhas */
    }

    .grid-item.dragging .image-card { opacity: 0.4; border: 2px dashed #007bff !important; }
    .grid-item.drag-over .image-card { transform: scale(1.02); box-shadow: 0 0 0 3px #28a745; }
    .grid-item[draggable="true"] { cursor: grab; }
    .grid-item[draggable="true"]:active { cursor: grabbing; }

    @media (max-width: 576px) {
        #lista-imagens { 
            gap: 8px; 
            grid-template-columns: repeat(2, 1fr) !important; /* Força 2 colunas no mobile */
        }
    }
</style>

<main class="container container-glass pt-4 pb-2" id="conteudo-principal">
    <div class="d-flex justify-content-between align-items-start mb-3 pb-2">
        <div>
            <h2 id="galeria-titulo" class="fw-bold mb-1">Carregando...</h2>
            <p id="galeria-descricao" class="text-muted mb-1"></p>
            <small class="text-muted">Criado por <strong id="galeria-autor">...</strong></small>
        </div>
        <div class="d-flex gap-2" id="acoes-galeria"></div>
    </div>
</main>

<!-- Container principal da grade -->
<div class="container mt-3 mb-5" id="gallery-container">
    <!-- REMOVIDO classes 'row g-3' que causavam margens negativas e padding extra -->
    <div id="lista-imagens">
        <div class="col-12 text-center py-5 text-muted" style="grid-column: 1 / -1;">
            <div class="spinner-border spinner-border-sm" role="status"></div> Carregando biblioteca...
        </div>
    </div>
</div>

<!-- Modal Upload -->
<div class="modal fade" id="modalUpload" tabindex="-1" data-bs-backdrop="static">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Adicionar Mídia</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formUpload">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Arquivo</label>
                        <input type="file" class="form-control" name="fileInput" 
                               accept="image/*,video/*,audio/*,.mkv,.avi,.webp" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Nome/Legenda (Opcional)</label>
                        <input type="text" class="form-control" name="nome" placeholder="Ex: Aquele dia legal">
                    </div>
                    
                    <div class="mb-3 p-3 bg-light rounded border" id="upload-progress-wrapper" style="display:none;">
                        <div class="d-flex justify-content-between mb-1">
                            <span class="fw-bold text-primary" id="upload-status-label">Enviando...</span>
                            <span id="upload-percent-text">0%</span>
                        </div>
                        <div class="progress mb-2" style="height: 10px;">
                            <div id="upload-progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-end text-muted small">
                             <span id="upload-size-text">0.0 MB / 0.0 MB</span>
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary w-100" id="btn-submit-upload">
                        <i class="bi bi-cloud-upload"></i> Enviar
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Config -->
<div class="modal fade" id="modalConfig" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Configurações da Galeria</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="formConfig">
                    <input type="hidden" name="remove_cover" id="flag-remove-cover" value="false">
                    <input type="hidden" name="remove_background" id="flag-remove-bg" value="false">

                    <div class="row g-4">
                        <div class="col-md-6 border-end">
                            <h6 class="text-primary mb-3">Informações Gerais</h6>
                            <div class="mb-3"><label class="form-label">Nome</label><input type="text" class="form-control" name="nome" id="config-nome" required></div>
                            <div class="mb-3"><label class="form-label">Descrição</label><textarea class="form-control" name="descricao" id="config-descricao" rows="3"></textarea></div>
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" name="is_public" id="config-is-public">
                                <label class="form-check-label fw-bold ms-2" for="config-is-public">Pública</label>
                            </div>
                            <div id="colaboradores-section">
                                <label class="form-label fw-bold">Colaboradores</label>
                                <div class="input-group mb-2">
                                    <input type="text" id="search-user-input" class="form-control" placeholder="Username...">
                                    <button class="btn btn-outline-primary" type="button" onclick="GaleriaManager.buscarUsuarios()"><i class="bi bi-search"></i></button>
                                </div>
                                <div id="search-results" class="list-group mb-2 shadow-sm" style="max-height: 150px; overflow-y: auto;"></div>
                                <div id="colaboradores-selecionados" class="d-flex flex-wrap gap-2 mt-2"></div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6 class="text-primary mb-3">Visual</h6>
                            <div class="mb-3">
                                <label class="form-label small text-muted text-uppercase fw-bold">Capa</label>
                                <div class="input-group">
                                    <input type="file" class="form-control" name="cover_image" id="input-cover" accept="image/*">
                                    <button type="button" class="btn btn-outline-danger" onclick="GaleriaManager.toggleRemove('cover')"><i class="bi bi-trash"></i></button>
                                </div>
                                <small id="status-cover" class="text-danger d-none mt-1">Será removida ao salvar</small>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small text-muted text-uppercase fw-bold">Background</label>
                                <div class="input-group">
                                    <input type="file" class="form-control preview-trigger" name="background" id="input-bg" accept="image/*">
                                    <button type="button" class="btn btn-outline-danger" onclick="GaleriaManager.toggleRemove('background')"><i class="bi bi-trash"></i></button>
                                </div>
                                <small id="status-bg" class="text-danger d-none mt-1">Será removida ao salvar</small>
                            </div>
                            <div class="row g-2 mb-3">
                                <div class="col-4"><label class="form-label small">Fundo</label><input type="color" class="form-control form-control-color w-100 preview-trigger" name="background_color" id="config-bg-color"></div>
                                <div class="col-4"><label class="form-label small">Fonte</label><input type="color" class="form-control form-control-color w-100 preview-trigger" name="font_color" id="config-font-color"></div>
                                <div class="col-4"><label class="form-label small">Cards</label><input type="color" class="form-control form-control-color w-100 preview-trigger" name="card_color" id="config-card-color"></div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Colunas (Grid)</label>
                                <select class="form-select preview-trigger" name="grid_columns" id="config-grid-columns">
                                    <option value="6">6</option>
                                    <option value="8" selected>8 (Padrão)</option>
                                    <option value="10">10</option>
                                    <option value="12">12</option>
                                    <option value="14">14</option>
                                    <option value="16">16</option>
                                </select>
                            </div>
                            <div class="mb-3" id="group-bg-fill">
                                <label class="form-label small">Preenchimento Fundo</label>
                                <select class="form-select preview-trigger" name="background_fill" id="config-bg-fill">
                                    <option value="cover">Preencher</option><option value="repeat">Repetir</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label small">Fonte</label>
                                <input type="text" class="form-control preview-trigger" id="config-custom-font" placeholder="Ex: Dosis ExtraBold, Roboto Italic 700, Lobster">
                                <small class="text-muted">Digite o nome da fonte e estilo/peso (ex: <b>Dosis ExtraLight</b>, <b>Roboto Italic 700</b>, <b>Lobster</b>). O sistema converte automaticamente para o formato do Google Fonts.</small>
                            </div>
                        </div>
                    </div>

                    <div class="modal-footer px-0 pb-0 mt-3 border-top-0">
                        <button type="button" class="btn btn-outline-danger me-auto" onclick="GaleriaManager.excluirGaleria()"><i class="bi bi-trash"></i> Excluir</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success px-4">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal Media Lightbox -->
<div class="modal fade" id="modalMedia" tabindex="-1">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content bg-transparent border-0 shadow-none">
            <div class="modal-body p-0 text-center position-relative">
                <div id="media-container" class="d-flex justify-content-center align-items-center" style="min-height: 200px;"></div>
            </div>
            <div class="mt-3 text-center">
                <h5 id="media-caption" class="text-white text-shadow d-inline-block bg-dark bg-opacity-75 px-3 py-1 rounded"></h5>
            </div>
        </div>
    </div>
</div>

<script>
    const CONFIG = { galeriaId: '<%= galeriaId %>' };

    const Utils = {
        alert: (msg, title) => window.mostrarAviso ? window.mostrarAviso(msg, title) : alert(`${title || 'Aviso'}: ${msg}`),
        confirm: async (msg, title) => window.mostrarConfirmacao ? await window.mostrarConfirmacao(msg, title) : confirm(msg),
        escapeHtml: (str) => (!str ? '' : str.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;")),
        formatSize: (bytes) => (bytes / (1024 * 1024)).toFixed(2) + ' MB'
    };

    const GaleriaManager = {
        data: null,
        colaboradores: [],
        originalStyles: null,
        previewBgUrl: null,
        editMode: false,

        async init() {
            await this.carregarDados();
            this.setupEventListeners();
        },

        async carregarDados() {
            try {
                const res = await fetch(`/api/galeria/${CONFIG.galeriaId}`);
                const json = await res.json();
                if (!json.success) throw new Error(json.message);
                this.data = json.galeria;
                
                // Defaults
                this.data.background_fill = this.data.background_fill || 'cover';
                this.data.font_color = this.data.font_color || '#3E3F29';
                this.colaboradores = (this.data.colaboradores || []).map(c => ({ id: c.id, username: c.username }));
                
                this.renderizar();
            } catch (err) { console.error(err); Utils.alert('Erro ao carregar.', 'Erro'); }
        },

        renderizar() {
            if (!this.data) return;
            document.getElementById('galeria-titulo').textContent = this.data.nome;
            document.getElementById('galeria-descricao').textContent = this.data.descricao || '';
            document.getElementById('galeria-autor').textContent = this.data.owner?.username || 'Desconhecido';
            this.aplicarEstilos(this.data);
            this.renderizarBotoesAcao();
            this.renderizarGrid();
        },

        renderizarBotoesAcao() {
            const editLabel = this.editMode ? 'Sair Layout' : 'Editar Layout';
            const editClass = this.editMode ? 'btn-warning' : 'btn-outline-secondary';
            const htmlBotoes = `
                <button class="btn btn-primary shadow-sm" onclick="GaleriaManager.abrirModalUpload()"><i class="bi bi-plus-lg"></i> <span class="d-none d-sm-inline">Adicionar</span></button>
                <button id="btn-edit-layout" class="btn ${editClass} ms-2" onclick="GaleriaManager.toggleEditMode()"><i class="bi bi-grid-3x3-gap-fill"></i> <span class="d-none d-sm-inline">${editLabel}</span></button>
                ${this.editMode ? '<button id="btn-save-layout" class="btn btn-success ms-2" onclick="GaleriaManager.saveLayout()"><i class="bi bi-save"></i> Salvar Layout</button>' : ''}
                <button class="btn btn-light border shadow-sm" onclick="GaleriaManager.abrirModalConfig()"><i class="bi bi-gear-fill"></i></button>
            `;
            document.getElementById('acoes-galeria').innerHTML = htmlBotoes;
        },

        renderizarGrid() {
            const grid = document.getElementById('lista-imagens');
            if (!grid) return;
            if (!this.data.imagens || this.data.imagens.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center text-muted py-5" style="grid-column: 1/-1;">Esta galeria está vazia. Adicione fotos, vídeos ou músicas!</div>';
                return;
            }

            const imgs = [...this.data.imagens].sort((a, b) => (a.pos || 0) - (b.pos || 0));
            const totalCols = this.data.grid_columns || 4;
            grid.style.setProperty('--gallery-columns', totalCols);

            grid.innerHTML = imgs.map(img => {
                const safeNome = Utils.escapeHtml(img.nome || 'Sem nome');
                const safeUrl = img.url.replace(/'/g, "\\'");
                const mediaType = this.getMediaType(img.url);

                let spanW = img.grid_w || (totalCols >= 9 ? 3 : 1);
                let spanH = img.grid_h || (totalCols >= 9 ? 3 : 1);
                const ratio = `${spanW} / ${spanH}`;

                const showTitle = (img.show_title !== false);
                const fitMode = img.img_fit || 'cover';
                
                const cardModeClass = showTitle ? 'has-title' : 'no-title';
                const fitClass = fitMode === 'contain' ? 'fit-contain' : 'fit-cover';

                let mediaContent;
                if (mediaType === 'video') mediaContent = `<div class="media-placeholder placeholder-video"><i class="bi bi-play-circle-fill display-4 mb-2"></i></div>`;
                else if (mediaType === 'audio') mediaContent = `<div class="media-placeholder placeholder-audio"><i class="bi bi-music-note-beamed display-4 mb-2"></i></div>`;
                else mediaContent = `<img src="${img.url}" class="media-preview-box ${fitClass}" loading="lazy" alt="${safeNome}">`;

                const dragAttr = this.editMode ? 'draggable="true"' : '';
                
                let editOverlay = '';
                if (this.editMode) {
                    editOverlay = `
                    <div class="edit-overlay">
                        <button class="btn btn-xs ${fitMode === 'contain' ? 'btn-info text-white' : 'btn-light'} me-1 border shadow-sm" 
                                onclick="event.stopPropagation(); GaleriaManager.toggleFit(${img.id})" title="Alternar: Recortar / Mostrar Inteira">
                            <i class="bi bi-aspect-ratio"></i>
                        </button>
                        <button class="btn btn-xs ${showTitle ? 'btn-primary' : 'btn-light'} me-1 border shadow-sm" 
                                onclick="event.stopPropagation(); GaleriaManager.toggleTitle(${img.id})" title="Mostrar/Ocultar Título">
                            <i class="bi bi-card-heading"></i>
                        </button>
                        <div class="btn-group-vertical shadow-sm">
                            <button class="btn btn-xs btn-dark bg-opacity-75" onclick="event.stopPropagation(); GaleriaManager.changeSpan(${img.id}, ${spanW}, ${Math.max(1, spanH - 1)})"><i class="bi bi-arrow-up-short"></i></button>
                            <button class="btn btn-xs btn-dark bg-opacity-75" onclick="event.stopPropagation(); GaleriaManager.changeSpan(${img.id}, ${spanW}, ${Math.min(totalCols, spanH + 1)})"><i class="bi bi-arrow-down-short"></i></button>
                        </div>
                        <div class="btn-group-vertical ms-1 shadow-sm">
                            <button class="btn btn-xs btn-dark bg-opacity-75" onclick="event.stopPropagation(); GaleriaManager.changeSpan(${img.id}, ${Math.max(1, spanW - 1)}, ${spanH})"><i class="bi bi-arrow-left-short"></i></button>
                            <button class="btn btn-xs btn-dark bg-opacity-75" onclick="event.stopPropagation(); GaleriaManager.changeSpan(${img.id}, ${Math.min(totalCols, spanW + 1)}, ${spanH})"><i class="bi bi-arrow-right-short"></i></button>
                        </div>
                    </div>`;
                }

                return `
                <div class="grid-item" data-id="${img.id}" ${dragAttr} style="grid-column: span ${spanW}; grid-row: span ${spanH}; --item-ratio: ${ratio};">
                    <div class="image-card ${cardModeClass}" onclick="GaleriaManager.abrirMedia('${safeUrl}', '${mediaType}', '${safeNome}')">
                        ${mediaContent}
                        ${ showTitle ? `<div class="card-body"><small class="text-truncate fw-bold text-dark w-100 d-block" title="${safeNome}">${safeNome}</small></div>` : '' }
                        ${ (this.editMode) ? `<button class="position-absolute bottom-0 end-0 m-2 btn btn-xs btn-danger shadow-sm" style="z-index:30" onclick="event.stopPropagation(); GaleriaManager.excluirImagem(${img.id})"><i class="bi bi-trash"></i></button>` : '' }
                    </div>
                    ${editOverlay}
                </div>`;
            }).join('');
            if (this.editMode) this.enableDrag();
        },

        toggleEditMode() {
            this.editMode = !this.editMode;
            this.renderizarBotoesAcao();
            this.renderizarGrid();
        },

        toggleFit(id) {
            const idx = this.data.imagens.findIndex(i => i.id === id);
            if (idx === -1) return;
            const current = this.data.imagens[idx].img_fit || 'cover';
            this.data.imagens[idx].img_fit = (current === 'cover') ? 'contain' : 'cover';
            this.renderizarGrid();
        },

        toggleTitle(id) {
            const idx = this.data.imagens.findIndex(i => i.id === id);
            if (idx === -1) return;
            const current = this.data.imagens[idx].show_title !== false;
            this.data.imagens[idx].show_title = !current;
            this.renderizarGrid();
        },

        changeSpan(id, w, h) {
            const idx = this.data.imagens.findIndex(i => i.id === id);
            if (idx === -1) return;
            this.data.imagens[idx].grid_w = w;
            this.data.imagens[idx].grid_h = h;
            this.renderizarGrid();
        },

        async saveLayout() {
            const layout = [...this.data.imagens].sort((a,b)=>(a.pos||0)-(b.pos||0)).map((it, idx) => ({ 
                id: it.id, 
                grid_w: it.grid_w || 1, 
                grid_h: it.grid_h || 1, 
                pos: idx+1,
                show_title: it.show_title, 
                img_fit: it.img_fit
            }));
            
            const formData = new FormData();
            formData.set('layout', JSON.stringify(layout));
            
            try {
                const res = await fetch(`/api/galeria/${CONFIG.galeriaId}`, { method: 'PATCH', body: formData });
                const json = await res.json();
                
                if (json.success) {
                    this.editMode = false;
                    await this.carregarDados();
                    this.renderizarBotoesAcao();
                    Utils.alert('Layout salvo!', 'Sucesso');
                } else throw new Error(json.message);
            } catch (err) { 
                Utils.alert(err.message || 'Erro ao salvar layout', 'Erro');
            }
        },

        // --- DEMAIS FUNÇÕES (Mantidas iguais) ---
        aplicarEstilos(settings) {
            const container = document.getElementById('conteudo-principal');
            if (!container) return;
            const bgUrl = settings.background_url || this.previewBgUrl;
            // Verifica fonte personalizada
            let fontFamily = settings.font_family || '';
            if (settings.custom_font && settings.custom_font.trim()) {
                // Permite nome + estilo/peso em texto livre (ex: Dosis ExtraBold 800)
                let fontSpec = settings.custom_font.trim();
                // Suporte especial para Comic Sans, Montserrat e Inter
                if (/^comic\s?sans(\s|$)/i.test(fontSpec)) {
                    fontFamily = `'Comic Sans MS', Comic Sans, cursive`;
                } else if (/^montserrat(\s|$)/i.test(fontSpec)) {
                    fontFamily = `'Montserrat', Arial, Helvetica, sans-serif`;
                } else if (/^inter(\s|$)/i.test(fontSpec)) {
                    fontFamily = `'Inter', Arial, Helvetica, sans-serif`;
                } else {
                    let fontParam = '';
                    let familyName = '';
                    // Se já está no formato Google Fonts, usa direto
                    if (fontSpec.includes(':') || fontSpec.includes('@') || fontSpec.includes(',')) {
                        fontParam = fontSpec.replace(/ /g, '+');
                        familyName = fontSpec.split(':')[0];
                    } else {
                        // Extrai nome, estilo e peso
                        const parts = fontSpec.split(/\s+/);
                        familyName = parts[0];
                        let style = '';
                        let weight = '';
                        // Junta nome da fonte (pode ser mais de uma palavra)
                        let i = 1;
                        while (i < parts.length && !/^(thin|extralight|light|regular|medium|semibold|bold|extrabold|black|italic|oblique|[1-9]00)$/i.test(parts[i].toLowerCase())) {
                            familyName += ' ' + parts[i];
                            i++;
                        }
                        // Mapeamento de estilos para pesos
                        const styleMap = {
                            thin: '100',
                            extralight: '200',
                            'extra-light': '200',
                            light: '300',
                            regular: '400',
                            medium: '500',
                            semibold: '600',
                            'semi-bold': '600',
                            bold: '700',
                            extrabold: '800',
                            'extra-bold': '800',
                            black: '900'
                        };
                        // Pega estilo/peso
                        for (; i < parts.length; i++) {
                            const p = parts[i].toLowerCase();
                            if (p === 'italic' || p === 'oblique') style = 'ital';
                            else if (styleMap[p]) weight = styleMap[p];
                            else if (/^[1-9]00$/.test(p)) weight = p;
                        }
                        // Se o usuário digitou só o nome do estilo (ex: ExtraLight), usa o peso mapeado
                        // Se digitou também o número, o número tem prioridade
                        let familyParam = familyName.replace(/ /g, '+');
                        if (style && weight) fontParam = `${familyParam}:${style},wght@1,${weight}`;
                        else if (style) fontParam = `${familyParam}:${style}@1`;
                        else if (weight) fontParam = `${familyParam}:wght@${weight}`;
                        else fontParam = familyParam;
                    }
                    fontFamily = `'${familyName}', sans-serif`;
                    const fontHref = `https://fonts.googleapis.com/css2?family=${fontParam}&display=swap`;
                    // Remove caracteres inválidos do seletor de atributo
                    const fontKey = fontParam.replace(/[^a-zA-Z0-9_:+@,.-]/g, '');
                    if (!document.querySelector(`link[data-custom-font='${fontKey}']`)) {
                        // Remove outros links custom-font para evitar duplicidade
                        document.querySelectorAll('link[data-custom-font]').forEach(l => l.remove());
                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = fontHref;
                        link.setAttribute('data-custom-font', fontKey);
                        document.head.appendChild(link);
                    }
                }
            }
            Object.assign(container.style, {
                backgroundColor: settings.background_color || '',
                fontFamily: fontFamily,
                backgroundImage: bgUrl ? `url('${bgUrl}')` : 'none',
                backgroundRepeat: settings.background_fill === 'repeat' ? 'repeat' : 'no-repeat',
                backgroundSize: settings.background_fill === 'repeat' ? 'auto' : 'cover',
                backgroundAttachment: 'fixed',
                backgroundPosition: 'center',
                color: settings.font_color || '#3E3F29'
            });
            try { container.style.setProperty('--gallery-card-bg', settings.card_color || '#ffffff'); } catch (e) { }
            if (settings.font_color) container.querySelectorAll('h2, p, small').forEach(el => el.style.color = settings.font_color);
        },
        abrirModalUpload() { new bootstrap.Modal(document.getElementById('modalUpload')).show(); },
        async handleUpload(e) { 
            e.preventDefault();
            const form = e.target;
            const fileInput = form.querySelector('input[name="fileInput"]');
            if (!fileInput.files[0]) return Utils.alert("Selecione um arquivo", "Atenção");
            
            const btn = document.getElementById('btn-submit-upload');
            const progressArea = document.getElementById('upload-progress-wrapper');
            btn.disabled = true; progressArea.style.display = 'block';

            try {
                const result = await this.uploadFile(fileInput.files[0], form);
                if (result && result.success) {
                    if (result.imagem) {
                        const totalCols = parseInt(this.data.grid_columns) || 4;
                        let defaultSize = (totalCols >= 9) ? 3 : (totalCols >= 6 ? 2 : 1);
                        result.imagem.grid_w = defaultSize; result.imagem.grid_h = defaultSize;
                        this.data.imagens.push(result.imagem);
                    }
                    this.renderizar();
                    bootstrap.Modal.getInstance(document.getElementById('modalUpload')).hide();
                    form.reset();
                    Utils.alert('Upload concluído!', 'Sucesso');
                }
            } catch (err) { console.error(err); Utils.alert(err.message, 'Erro'); } 
            finally { btn.disabled = false; progressArea.style.display = 'none'; this.resetProgress(); }
        },
        uploadFile(file, formElement) {
            return new Promise((resolve, reject) => {
                const xhr = new XMLHttpRequest();
                const formData = new FormData(formElement);
                formData.delete('fileInput'); formData.append('imagem', file);
                xhr.open('POST', `/api/galeria/${CONFIG.galeriaId}/upload`);
                xhr.upload.onprogress = (e) => {
                    if (e.lengthComputable) {
                        const pct = Math.round((e.loaded / e.total) * 100);
                        const bar = document.getElementById('upload-progress-bar');
                        if (bar) bar.style.width = pct + '%';
                        document.getElementById('upload-percent-text').textContent = pct + '%';
                        document.getElementById('upload-size-text').textContent = `${Utils.formatSize(e.loaded)} / ${Utils.formatSize(e.total)}`;
                    }
                };
                xhr.onload = () => {
                    try { const resp = JSON.parse(xhr.responseText); (xhr.status >= 200 && xhr.status < 300) ? resolve(resp) : reject(new Error(resp.message)); } 
                    catch (e) { reject(new Error('Resposta inválida.')); }
                };
                xhr.onerror = () => reject(new Error('Erro de conexão.'));
                xhr.send(formData);
            });
        },
        resetProgress() {
            const bar = document.getElementById('upload-progress-bar');
            if(bar) bar.style.width = '0%';
            document.getElementById('upload-percent-text').textContent = '0%';
        },
        abrirMedia(url, type, nome) {
            const container = document.getElementById('media-container');
            const caption = document.getElementById('media-caption');
            container.innerHTML = '';
            const txt = document.createElement("textarea"); txt.innerHTML = nome; caption.textContent = txt.value || '';
            const wrapper = document.createElement('div');
            wrapper.style.position = 'relative';
            wrapper.style.display = 'inline-block';
            const btnClose = document.createElement('button');
            btnClose.type = 'button';
            btnClose.className = 'btn-close bg-white position-absolute';
            btnClose.style.top = '10px'; btnClose.style.right = '10px'; btnClose.style.zIndex = '1050';
            btnClose.style.boxShadow = '0 2px 5px rgba(0,0,0,0.5)';
            btnClose.setAttribute('data-bs-dismiss', 'modal');
            let mediaElement;
            if (type === 'video') {
                mediaElement = document.createElement('video');
                mediaElement.src = url; mediaElement.controls = true; mediaElement.autoplay = true; 
                mediaElement.className = 'img-fluid rounded shadow'; mediaElement.style.maxHeight = '80vh';
            } else if (type === 'audio') {
                const audioWrapper = document.createElement('div');
                audioWrapper.className = "text-center p-4 bg-dark rounded shadow border border-secondary";
                audioWrapper.style.minWidth = "300px";
                audioWrapper.innerHTML = `<i class="bi bi-music-note-beamed display-1 text-info mb-4 d-block"></i><audio controls autoplay class="w-100"><source src="${url}" type="audio/mpeg"></audio>`;
                mediaElement = audioWrapper;
            } else {
                mediaElement = document.createElement('img');
                mediaElement.src = url; mediaElement.className = 'img-fluid rounded shadow'; mediaElement.style.maxHeight = '80vh';
            }
            wrapper.appendChild(mediaElement);
            wrapper.appendChild(btnClose);
            container.appendChild(wrapper);
            new bootstrap.Modal(document.getElementById('modalMedia')).show();
        },
        abrirModalConfig() {
            this.originalStyles = document.getElementById('conteudo-principal').getAttribute('style');
            const f = document.getElementById('formConfig'); f.reset();
            ['cover', 'bg'].forEach(type => { document.getElementById(`flag-remove-${type}`).value = 'false'; document.getElementById(`status-${type}`).classList.add('d-none'); });
            
            document.getElementById('config-nome').value = this.data.nome;
            document.getElementById('config-descricao').value = this.data.descricao || '';
            document.getElementById('config-is-public').checked = this.data.is_public;
            document.getElementById('config-bg-color').value = this.data.background_color;
            document.getElementById('config-bg-fill').value = this.data.background_fill;
            document.getElementById('config-card-color').value = this.data.card_color || '#ffffff';
            document.getElementById('config-grid-columns').value = this.data.grid_columns || 4;
            const bgFillGroup = document.getElementById('group-bg-fill');
            const hasBg = !!this.data.background_url || (document.getElementById('input-bg').files && document.getElementById('input-bg').files.length > 0);
            if (bgFillGroup) bgFillGroup.style.display = hasBg ? '' : 'none';
            document.getElementById('config-font-color').value = this.data.font_color;
            document.getElementById('config-custom-font').value = this.data.custom_font || '';
            
            this.togglePublicSection(); this.renderColaboradores();
            new bootstrap.Modal(document.getElementById('modalConfig'), { backdrop: true }).show();
        },
        toggleRemove(type) { const key = (type === 'background') ? 'bg' : type; document.getElementById(`flag-remove-${key}`).value = 'true'; document.getElementById(`status-${key}`).classList.remove('d-none'); if (key === 'bg') { this.previewBgUrl = null; this.applyPreview(); } },
        applyPreview() {
            const bgFillGroup = document.getElementById('group-bg-fill');
            const hasBg = !!this.data.background_url || (document.getElementById('input-bg').files && document.getElementById('input-bg').files.length > 0);
            if (bgFillGroup) bgFillGroup.style.display = hasBg ? '' : 'none';
            const settings = {
                background_color: document.getElementById('config-bg-color').value,
                background_fill: document.getElementById('config-bg-fill').value,
                custom_font: document.getElementById('config-custom-font').value,
                font_color: document.getElementById('config-font-color').value,
                card_color: document.getElementById('config-card-color').value,
                grid_columns: parseInt(document.getElementById('config-grid-columns').value) || 4,
                background_url: (document.getElementById('flag-remove-bg').value === 'true') ? null : (this.previewBgUrl || this.data.background_url)
            };
            this.aplicarEstilos(settings);
        },
        async buscarUsuarios() { const q = document.getElementById('search-user-input').value; if(q.length<2)return; try{const res=await fetch(`/api/users/buscar?q=${encodeURIComponent(q)}`); const json=await res.json(); document.getElementById('search-results').innerHTML=(json.usuarios||[]).map(u=>`<button type="button" class="list-group-item list-group-item-action" onclick="GaleriaManager.addColaborador(${u.id}, '${u.username}')">${u.username}</button>`).join('');}catch(e){console.error(e);} },
        addColaborador(id, username) { if(!this.colaboradores.find(c=>c.id===id)){this.colaboradores.push({id,username});this.renderColaboradores();} document.getElementById('search-results').innerHTML=''; document.getElementById('search-user-input').value=''; },
        removeColaborador(id) { this.colaboradores = this.colaboradores.filter(c=>c.id!==id); this.renderColaboradores(); },
        renderColaboradores() { document.getElementById('colaboradores-selecionados').innerHTML = this.colaboradores.map(c => `<span class="badge bg-primary d-flex align-items-center gap-2 p-2">${c.username}<i class="bi bi-x-circle-fill cursor-pointer" onclick="GaleriaManager.removeColaborador(${c.id})"></i></span>`).join(''); },
        togglePublicSection() { document.getElementById('colaboradores-section').style.display = document.getElementById('config-is-public').checked ? 'none' : 'block'; },
        async excluirImagem(id) { if(!await Utils.confirm('Tem certeza?', 'Excluir'))return; try{const res=await fetch(`/api/galeria/${CONFIG.galeriaId}/imagem/${id}`,{method:'DELETE'});const json=await res.json();if(json.success){this.data.imagens=this.data.imagens.filter(img=>img.id!==id);this.renderizar();Utils.alert('Mídia removida.','Sucesso');}}catch(err){Utils.alert('Erro ao excluir.','Erro');} },
        async excluirGaleria() { if(!await Utils.confirm('Isso apagará o álbum inteiro!', 'EXCLUIR TUDO'))return; try{const res=await fetch(`/api/galeria/${CONFIG.galeriaId}`,{method:'DELETE'});const json=await res.json();if(json.success)window.location.href='/galerias'; else throw new Error(json.message);}catch(err){Utils.alert(err.message,'Erro Crítico');} },
        getMediaType(url) { const lower=url.toLowerCase(); if(['.mp4','.mov','.webm','.avi','.mkv','.m4v'].some(ext=>lower.includes(ext)))return 'video'; if(['.mp3','.wav','.ogg','.flac','.m4a','.aac'].some(ext=>lower.includes(ext)))return 'audio'; return 'image'; },
        setupEventListeners() {
            document.getElementById('formUpload').addEventListener('submit', (e) => this.handleUpload(e));
            document.getElementById('formConfig').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                formData.append('colaboradores', JSON.stringify(this.colaboradores.map(c => c.id)));
                formData.set('is_public', document.getElementById('config-is-public').checked);
                formData.set('card_color', document.getElementById('config-card-color').value);
                formData.set('grid_columns', document.getElementById('config-grid-columns').value);
                try {
                    const res = await fetch(`/api/galeria/${CONFIG.galeriaId}`, { method: 'PATCH', body: formData });
                    const json = await res.json();
                    if (json.success) {
                        Object.assign(this.data, json.galeria);
                        this.originalStyles = null;
                        bootstrap.Modal.getInstance(document.getElementById('modalConfig')).hide();
                        this.renderizar();
                        Utils.alert('Salvo!', 'Sucesso');
                    } else throw new Error(json.message);
                } catch (err) { Utils.alert(err.message, 'Erro'); }
            });
            document.querySelectorAll('.preview-trigger').forEach(el => {
                el.addEventListener('input', () => {
                    if(el.id === 'input-bg' && el.files.length > 0) {
                        document.getElementById('flag-remove-bg').value = 'false';
                        document.getElementById('status-bg').classList.add('d-none');
                    }
                    this.applyPreview();
                });
            });
            document.getElementById('config-is-public').addEventListener('change', () => this.togglePublicSection());
            document.getElementById('modalConfig').addEventListener('hidden.bs.modal', () => {
                if (this.originalStyles) { document.getElementById('conteudo-principal').setAttribute('style', this.originalStyles); this.originalStyles = null; this.previewBgUrl = null; }
            });
            document.getElementById('modalMedia').addEventListener('hidden.bs.modal', () => {
                const container = document.getElementById('media-container');
                container.querySelectorAll('video, audio').forEach(el => { el.pause(); el.src = ""; });
                container.innerHTML = '';
            });
            this.enableDrag();
        },
        enableDrag() {
            const container = document.getElementById('lista-imagens');
            if (!container) return;
            this.disableDrag(); 
            this._onDragStart = (ev) => {
                const item = ev.target.closest('.grid-item');
                if (!item || !this.editMode) return; 
                ev.dataTransfer.setData('text/plain', item.dataset.id);
                ev.dataTransfer.effectAllowed = 'move';
                item.classList.add('dragging');
            };
            this._onDragEnd = (ev) => {
                const item = ev.target.closest('.grid-item');
                if (item) item.classList.remove('dragging');
                document.querySelectorAll('.grid-item').forEach(el => el.classList.remove('drag-over'));
            };
            this._onDragOver = (ev) => {
                ev.preventDefault();
                const over = ev.target.closest('.grid-item');
                if (over && !over.classList.contains('dragging')) {
                    document.querySelectorAll('.grid-item.drag-over').forEach(el => {if(el!==over)el.classList.remove('drag-over');});
                    over.classList.add('drag-over');
                }
            };
            this._onDrop = (ev) => {
                ev.preventDefault();
                const srcId = ev.dataTransfer.getData('text/plain');
                const targetEl = ev.target.closest('.grid-item');
                document.querySelectorAll('.grid-item').forEach(el => {el.classList.remove('drag-over'); el.classList.remove('dragging');});
                if (!srcId || !targetEl) return;
                const targetId = targetEl.dataset.id;
                if (srcId === targetId) return;
                const arr = [...this.data.imagens].sort((a,b)=> (a.pos||0)-(b.pos||0));
                const srcIdx = arr.findIndex(i => String(i.id) === String(srcId));
                const targetIdx = arr.findIndex(i => String(i.id) === String(targetId));
                if (srcIdx === -1 || targetIdx === -1) return;
                const [moved] = arr.splice(srcIdx, 1);
                arr.splice(targetIdx, 0, moved);
                arr.forEach((it, i) => it.pos = i + 1);
                this.data.imagens = arr;
                this.renderizarGrid();
            };
            container.addEventListener('dragstart', this._onDragStart);
            container.addEventListener('dragend', this._onDragEnd);
            container.addEventListener('dragover', this._onDragOver);
            container.addEventListener('dragleave', (ev) => {const over = ev.target.closest('.grid-item'); if(over) over.classList.remove('drag-over');});
            container.addEventListener('drop', this._onDrop);
        },
        disableDrag() {
            const container = document.getElementById('lista-imagens');
            if (!container) return;
            if (this._onDragStart) container.removeEventListener('dragstart', this._onDragStart);
            if (this._onDragEnd) container.removeEventListener('dragend', this._onDragEnd);
            if (this._onDragOver) container.removeEventListener('dragover', this._onDragOver);
            if (this._onDrop) container.removeEventListener('drop', this._onDrop);
        }
    };
    document.addEventListener('DOMContentLoaded', () => GaleriaManager.init());
</script>