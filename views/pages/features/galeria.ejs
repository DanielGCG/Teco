<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&family=Montserrat:wght@400;700&family=Open+Sans:wght@400;700&family=Playfair+Display:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

<main class="container py-3">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/galerias">Galerias</a></li>
            <li class="breadcrumb-item active" id="breadcrumb-nome">Carregando...</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2 id="galeria-titulo">Carregando...</h2>
            <p id="galeria-descricao" class="text-muted"></p>
            <small class="text-muted">Criado por <strong id="galeria-autor">...</strong></small>
        </div>
        <div class="d-flex gap-2" id="acoes-galeria">
            <!-- Botões de ação serão inseridos aqui -->
        </div>
    </div>

    <div class="row g-3" id="lista-imagens">
        <!-- Imagens serão carregadas aqui -->
    </div>

    </main>

    <!-- Modal Upload (fora do main) -->
    <div class="modal fade" id="modalUpload" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Adicionar Foto</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formUpload">
                        <div class="mb-3">
                            <label class="form-label">Imagem</label>
                            <input type="file" class="form-control" name="imagem" accept="image/*,video/*" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nome/Legenda (opcional)</label>
                            <input type="text" class="form-control" name="nome">
                        </div>
                        <div class="mb-3" id="upload-progress-wrapper" style="display:none;">
                            <label class="form-label">Progresso do Envio</label>
                            <div class="progress">
                                <div id="upload-progress-bar" class="progress-bar" role="progressbar" style="width: 0%;">0%</div>
                            </div>
                            <small id="upload-progress-text" class="text-muted">0.00 / 0.00 MB</small>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Enviar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Configurações (fora do main) -->
    <div class="modal fade" id="modalConfig" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Configurações do Álbum</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formConfig">
                        <div class="mb-3">
                            <label class="form-label">Nome</label>
                            <input type="text" class="form-control" name="nome" id="config-nome">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <textarea class="form-control" name="descricao" id="config-descricao" rows="2"></textarea>
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" name="is_public" id="config-is-public">
                            <label class="form-check-label" for="config-is-public">Público (todos podem adicionar fotos)</label>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Colaboradores Específicos</label>
                            <div class="input-group mb-2">
                                <input type="text" id="search-user-input" class="form-control" placeholder="Buscar usuário...">
                                <button class="btn btn-outline-primary" type="button" onclick="buscarUsuarios()">Buscar</button>
                            </div>
                            <div id="search-results" class="list-group mb-2" style="max-height: 150px; overflow-y: auto;"></div>
                            <div id="colaboradores-selecionados" class="d-flex flex-wrap gap-2">
                                <!-- Badges de usuários selecionados -->
                            </div>
                        </div>

                        <hr>
                        <h6>Personalização</h6>
                        <div class="mb-3">
                            <label class="form-label">Imagem de Fundo</label>
                            <input type="file" class="form-control" name="background" accept="image/*,.gif">
                            <small class="text-muted">Deixe vazio para manter a atual.</small>
                        </div>
                        <div class="mb-3 d-flex gap-2">
                            <button type="button" class="btn btn-sm btn-danger w-100" onclick="removerBackground()" id="btn-remover-bg" style="display: none;">Remover Imagem de Fundo</button>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cor de Fundo</label>
                            <div class="d-flex gap-2">
                                <input type="color" class="form-control form-control-color" name="background_color" id="config-bg-color" title="Escolha a cor de fundo" style="flex: 1;">
                                <button type="button" class="btn btn-sm btn-secondary" onclick="resetarCorPadrao()" title="Voltar à cor padrão">↺</button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fonte da Página</label>
                            <select class="form-select" name="font_family" id="config-font">
                                <option value="Inter">Inter (Padrão)</option>
                                <option value="'Roboto', sans-serif">Roboto</option>
                                <option value="'Open Sans', sans-serif">Open Sans</option>
                                <option value="'Montserrat', sans-serif">Montserrat</option>
                                <option value="'Playfair Display', serif">Playfair Display</option>
                                <option value="'Courier New', Courier, monospace">Courier New</option>
                                <option value="'Comic Sans MS', cursive">Comic Sans</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">Salvar Alterações</button>
                    </form>
                    <hr>
                    <button class="btn btn-danger w-100" onclick="excluirGaleria()">Excluir Álbum Permanentemente</button>
                </div>
            </div>
        </div>
    </div>

    <script>
    const galeriaId = '<%= galeriaId %>';
    let galeriaData = null;
    let colaboradoresSelecionados = [];

    // Detectar se URL é um vídeo
    function isVideoUrl(url) {
        if (!url) return false;
        const videoExtensions = ['.mp4', '.webm', '.avi', '.mov', '.mkv', '.flv', '.wmv', '.m4v'];
        const lowerUrl = url.toLowerCase();
        return videoExtensions.some(ext => lowerUrl.includes(ext));
    }

    // Validar tamanho do arquivo antes de upload
    function validateFileSize(file) {
        const isVideo = file.type.startsWith('video/') || /\.(mp4|mov|webm|m4v|mkv|avi|mpg|mpeg)$/i.test(file.name);
        const limit = isVideo ? 100 * 1024 * 1024 : 50 * 1024 * 1024; // 100MB vídeo, 50MB imagem
        const typeLabel = isVideo ? 'vídeo' : 'imagem';
        
        if (file.size > limit) {
            mostrarAviso(`Arquivo muito grande para o tipo ${typeLabel}. Limite: ${limit / (1024 * 1024)}MB`, 'Arquivo muito grande');
            return false;
        }
        return true;
    }

    document.addEventListener('DOMContentLoaded', carregarGaleria);

    async function carregarGaleria() {
        try {
            const res = await fetch(`/api/galeria/${galeriaId}`);
            const data = await res.json();
            if (data.success) {
                galeriaData = data.galeria;
                colaboradoresSelecionados = (galeriaData.colaboradores || []).map(c => ({ id: c.id, username: c.username }));
                renderizarGaleria();
            } else {
                alert(data.message);
                window.location.href = '/galerias';
            }
        } catch (err) {
            console.error('Erro ao carregar galeria:', err);
        }
    }

    function renderizarGaleria() {
        document.getElementById('breadcrumb-nome').textContent = galeriaData.nome;
        document.getElementById('galeria-titulo').textContent = galeriaData.nome;
        document.getElementById('galeria-descricao').textContent = galeriaData.descricao || 'Sem descrição.';
        document.getElementById('galeria-autor').textContent = galeriaData.owner.username;

        // Aplicar estilos personalizados apenas no elemento conteudo-principal (seguro)
        try {
            const container = document.getElementById('conteudo-principal');
            if (container) {
                // Adicionar transição suave à cor de fundo
                container.style.transition = 'background-color 2s ease-in-out';
                
                if (galeriaData.background_url) {
                    container.style.backgroundImage = `url('${galeriaData.background_url}')`;
                    container.style.backgroundSize = 'cover';
                    container.style.backgroundAttachment = 'fixed';
                    container.style.backgroundPosition = 'center';
                }
                if (galeriaData.background_color) {
                    container.style.backgroundColor = galeriaData.background_color;
                }
                if (galeriaData.font_family) {
                    container.style.fontFamily = galeriaData.font_family;
                }
            }
        } catch (err) {
            console.warn('Erro aplicando estilos da galeria:', err);
        }

        const acoes = document.getElementById('acoes-galeria');
        acoes.innerHTML = '';

        // Verificar permissão (simplificado no front, o back garante)
        acoes.innerHTML += `<button class="btn btn-success" onclick="abrirModalUpload()">+ Adicionar Foto</button>`;
        acoes.innerHTML += `<button class="btn btn-outline-secondary" onclick="abrirModalConfig()"><i class="bi bi-gear"></i></button>`;

        const container = document.getElementById('lista-imagens');
        container.innerHTML = galeriaData.imagens.map(img => {
            const isVideo = isVideoUrl(img.url);
            return `
            <div class="col-6 col-md-4 col-lg-3">
                <div class="card h-100 shadow-sm image-card">
                    ${isVideo ? 
                        `<video class="card-img-top" controls style="height: 200px; object-fit: cover;">
                            <source src="${img.url}" type="video/mp4">
                            Seu navegador não suporta a tag de vídeo.
                        </video>` 
                        : 
                        `<a href="${img.url}" target="_blank">
                            <img src="${img.url}" class="card-img-top" alt="${img.nome}">
                        </a>`
                    }
                    <div class="card-body p-2 d-flex justify-content-between align-items-center">
                        <small class="text-truncate" title="${img.nome}">${img.nome || 'Sem nome'}</small>
                        <button class="btn btn-sm btn-link text-danger p-0" onclick="excluirImagem(${img.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `}).join('');
    }

    function abrirModalUpload() {
        new bootstrap.Modal(document.getElementById('modalUpload')).show();
    }

    function abrirModalConfig() {
        document.getElementById('config-nome').value = galeriaData.nome;
        document.getElementById('config-descricao').value = galeriaData.descricao || '';
        document.getElementById('config-is-public').checked = galeriaData.is_public;
        document.getElementById('config-bg-color').value = galeriaData.background_color || '#e2e1cf';
        document.getElementById('config-font').value = galeriaData.font_family || 'Inter';
        
        // Mostrar botão de remover background apenas se houver background
        const btnRemoverBg = document.getElementById('btn-remover-bg');
        if (galeriaData.background_url) {
            btnRemoverBg.style.display = 'block';
        } else {
            btnRemoverBg.style.display = 'none';
        }
        
        renderColaboradores();
        atualizarVisibilidadeColaboradores();
        new bootstrap.Modal(document.getElementById('modalConfig')).show();
    }

    // Função para mostrar/ocultar colaboradores baseado no checkbox de público
    function atualizarVisibilidadeColaboradores() {
        const isPublic = document.getElementById('config-is-public').checked;
        const colaboradoresSection = document.querySelector('.mb-3:has(#search-user-input)');
        
        if (isPublic) {
            // Se público, ocultar seção de colaboradores
            colaboradoresSection.style.display = 'none';
            // Limpar colaboradores selecionados
            colaboradoresSelecionados = [];
            renderColaboradores();
        } else {
            // Se privado, mostrar seção de colaboradores
            colaboradoresSection.style.display = 'block';
        }
    }

    // Adicionar listener ao checkbox de público para mostrar/ocultar colaboradores
    document.addEventListener('DOMContentLoaded', () => {
        const checkboxPublico = document.getElementById('config-is-public');
        checkboxPublico?.addEventListener('change', atualizarVisibilidadeColaboradores);
        
        // Adicionar listener ao seletor de cor para transição em tempo real
        const colorPicker = document.getElementById('config-bg-color');
        colorPicker?.addEventListener('change', () => {
            const novaCor = colorPicker.value;
            const container = document.getElementById('conteudo-principal');
            if (container) {
                container.style.transition = 'background-color 2s ease-in-out';
                container.style.backgroundColor = novaCor;
            }
        });
        
        // Também atualizar enquanto o usuário arrasta o slider de cor (input event)
        colorPicker?.addEventListener('input', () => {
            const novaCor = colorPicker.value;
            const container = document.getElementById('conteudo-principal');
            if (container) {
                container.style.transition = 'background-color 2s ease-in-out';
                container.style.backgroundColor = novaCor;
            }
        });
    });

    async function removerBackground() {
        const confirmado = await mostrarConfirmacao('Deseja remover a imagem de fundo?', 'Remover Background');
        if (!confirmado) return;
        
        const formData = new FormData();
        formData.append('remove_background', 'true');
        
        try {
            const res = await fetch(`/api/galeria/${galeriaId}`, {
                method: 'PATCH',
                body: formData
            });
            const data = await res.json();
            if (data.success) {
                // Atualizar dados locais
                galeriaData.background_url = null;
                
                // Renderizar novamente
                renderizarGaleria();
                
                // Fechar modal se estiver aberto (caso tenha sido chamado de lá)
                const modalConfig = bootstrap.Modal.getInstance(document.getElementById('modalConfig'));
                if (modalConfig) modalConfig.hide();

                mostrarAviso('Imagem de fundo removida com sucesso!', 'Sucesso');
            } else {
                await mostrarConfirmacao(data.message, 'Erro');
            }
        } catch (err) {
            await mostrarConfirmacao('Erro ao remover background.', 'Erro');
        }
    }

    // Função para resetar a cor para o padrão
    function resetarCorPadrao() {
        const corPadrao = '#e2e1cf';
        const colorPicker = document.getElementById('config-bg-color');
        const container = document.getElementById('conteudo-principal');
        
        colorPicker.value = corPadrao;
        
        if (container) {
            container.style.transition = 'background-color 5s ease-in-out';
            container.style.backgroundColor = corPadrao;
        }
    }

    // Adicionar listener para busca ao apertar Enter
    document.getElementById('search-user-input')?.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            buscarUsuarios();
        }
    });

    async function buscarUsuarios() {
        const q = document.getElementById('search-user-input').value;
        if (q.length < 2) return;

        try {
            const res = await fetch(`/api/users/buscar?q=${encodeURIComponent(q)}`);
            const data = await res.json();
            const results = document.getElementById('search-results');
            results.innerHTML = data.usuarios.map(u => `
                <button type="button" class="list-group-item list-group-item-action" onclick="selecionarUsuario(${u.id}, '${u.username}')">
                    ${u.username}
                </button>
            `).join('');
        } catch (err) {
            console.error('Erro ao buscar usuários:', err);
        }
    }

    function selecionarUsuario(id, username) {
        if (!colaboradoresSelecionados.find(c => c.id === id)) {
            colaboradoresSelecionados.push({ id, username });
            renderColaboradores();
        }
        document.getElementById('search-results').innerHTML = '';
        document.getElementById('search-user-input').value = '';
    }

    function removerColaborador(id) {
        colaboradoresSelecionados = colaboradoresSelecionados.filter(c => c.id !== id);
        renderColaboradores();
    }

    function renderColaboradores() {
        const container = document.getElementById('colaboradores-selecionados');
        container.innerHTML = colaboradoresSelecionados.map(c => `
            <span class="badge bg-info text-dark d-flex align-items-center gap-1">
                ${c.username}
                <i class="bi bi-x-circle cursor-pointer" onclick="removerColaborador(${c.id})"></i>
            </span>
        `).join('');
    }

    document.getElementById('formUpload').addEventListener('submit', (e) => {
        e.preventDefault();
        const form = e.target;
        const fileInput = form.querySelector('input[name="imagem"]');

        // Validar tamanho do arquivo antes de enviar
        if (fileInput.files.length > 0) {
            if (!validateFileSize(fileInput.files[0])) {
                return;
            }
        }

        const formData = new FormData(form);

        const progressWrapper = document.getElementById('upload-progress-wrapper');
        const progressBar = document.getElementById('upload-progress-bar');
        progressWrapper.style.display = 'block';
        progressBar.style.width = '0%';
        progressBar.textContent = '0%';

        const xhr = new XMLHttpRequest();
        xhr.open('POST', `/api/galeria/${galeriaId}/upload`);
        xhr.withCredentials = true;

        xhr.upload.onprogress = function(ev) {
            if (ev.lengthComputable) {
                const pct = Math.round((ev.loaded / ev.total) * 100);
                const loadedMB = (ev.loaded / (1024 * 1024)).toFixed(2);
                const totalMB = (ev.total / (1024 * 1024)).toFixed(2);
                progressBar.style.width = pct + '%';
                progressBar.textContent = pct + '%';
                const progressText = document.getElementById('upload-progress-text');
                if (progressText) progressText.textContent = `${loadedMB} / ${totalMB} MB`;
            }
        };

        xhr.onload = function() {
            progressWrapper.style.display = 'none';
            try {
                const data = JSON.parse(xhr.responseText);
                if (xhr.status >= 200 && xhr.status < 300 && data.success) {
                    if (data.imagem) galeriaData.imagens.push(data.imagem);
                    bootstrap.Modal.getInstance(document.getElementById('modalUpload')).hide();
                    form.reset();
                    renderizarGaleria();
                    mostrarAviso('Imagem adicionada com sucesso!', 'Sucesso');
                } else {
                    console.error('Erro no upload (servidor):', data);
                    mostrarConfirmacao(data.message || 'Erro desconhecido no servidor.', 'Erro');
                }
            } catch (err) {
                console.error('Resposta inválida do servidor:', err, xhr.responseText);
                mostrarConfirmacao('Erro na resposta do servidor.', 'Erro');
            }
        };

        xhr.onerror = function() {
            progressWrapper.style.display = 'none';
            console.error('Erro de rede no upload');
            mostrarConfirmacao('Erro ao enviar imagem. Verifique sua conexão.', 'Erro');
        };

        xhr.send(formData);
    });

    document.getElementById('formConfig').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        
        // Adicionar colaboradores manualmente pois é um array
        formData.append('colaboradores', JSON.stringify(colaboradoresSelecionados.map(c => c.id)));
        
        // Ajustar o checkbox is_public
        formData.set('is_public', document.getElementById('config-is-public').checked);

        try {
            const res = await fetch(`/api/galeria/${galeriaId}`, {
                method: 'PATCH',
                body: formData // Envia como multipart/form-data
            });
            const data = await res.json();
            if (data.success) {
                // Atualizar dados locais com a resposta
                if (data.galeria) {
                    galeriaData.nome = data.galeria.nome;
                    galeriaData.descricao = data.galeria.descricao;
                    galeriaData.is_public = data.galeria.is_public;
                    galeriaData.background_color = data.galeria.background_color;
                    galeriaData.background_url = data.galeria.background_url;
                    galeriaData.font_family = data.galeria.font_family;
                }
                
                // Fechar modal
                bootstrap.Modal.getInstance(document.getElementById('modalConfig')).hide();
                
                // Renderizar novamente
                renderizarGaleria();
                
                // Mostrar mensagem de sucesso
                mostrarAviso('Configurações salvas com sucesso!', 'Sucesso');
            } else {
                await mostrarConfirmacao(data.message, 'Erro');
            }
        } catch (err) {
            await mostrarConfirmacao('Erro ao salvar configurações.', 'Erro');
        }
    });

    async function excluirImagem(imagemId) {
        const confirmado = await mostrarConfirmacao('Deseja remover esta imagem?', 'Remover Imagem');
        if (!confirmado) return;
        try {
            const res = await fetch(`/api/galeria/${galeriaId}/imagem/${imagemId}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) {
                // Remover da lista local
                galeriaData.imagens = galeriaData.imagens.filter(img => img.id !== imagemId);
                
                // Renderizar novamente
                renderizarGaleria();
                
                mostrarAviso('Imagem removida com sucesso!', 'Sucesso');
            } else {
                await mostrarConfirmacao(data.message, 'Erro');
            }
        } catch (err) {
            await mostrarConfirmacao('Erro ao excluir imagem.', 'Erro');
        }
    }

    async function excluirGaleria() {
        const confirmado = await mostrarConfirmacao('TEM CERTEZA? Isso excluirá o álbum e todas as fotos permanentemente!', 'Excluir Álbum');
        if (!confirmado) return;
        try {
            const res = await fetch(`/api/galeria/${galeriaId}`, { method: 'DELETE' });
            const data = await res.json();
            if (data.success) {
                window.location.href = '/galerias';
            } else {
                await mostrarConfirmacao(data.message, 'Erro');
            }
        } catch (err) {
            await mostrarConfirmacao('Erro ao excluir galeria.', 'Erro');
        }
    }
</script>

<style>
    body {
        transition: background-color 0.5s ease, background-image 0.5s ease;
    }
    
    main.container {
        background: rgba(255, 255, 255, 0.05);
        backdrop-filter: blur(10px);
        border-radius: 15px;
        padding: 20px;
        margin-top: 20px;
        margin-bottom: 20px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    }

    .image-card {
        transition: transform 0.2s;
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(5px);
    }
    
    .image-card:hover {
        transform: scale(1.02);
    }
    .image-card img {
        height: 200px;
        object-fit: cover;
    }
    .image-card video {
        display: block;
        width: 100%;
        height: 200px;
        object-fit: cover;
    }
    .cursor-pointer {
        cursor: pointer;
    }
</style>