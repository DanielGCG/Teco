<main class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Galerias</h2>
        <button class="btn btn-primary" onclick="abrirModalCriarGaleria()">+ Nova Galeria</button>
    </div>

    <div class="galeria" id="lista-galerias">
        <!-- Galerias serão carregadas aqui -->
        <div class="col-12 text-center text-muted">Carregando...</div>
    </div>

    <!-- Modal Criar Galeria -->
    <div class="modal fade" id="modalCriarGaleria" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Criar nova galeria</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCriarGaleria">
                        <div class="mb-3">
                            <label class="form-label">Nome da Galeria</label>
                            <!-- CORREÇÃO: name="nome" -> name="name" -->
                            <input type="text" class="form-control" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <!-- CORREÇÃO: name="descricao" -> name="description" -->
                            <textarea class="form-control" name="description" rows="2"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Capa (opcional)</label>
                            <!-- CORREÇÃO: name="capa" -> name="cover" -->
                            <input type="file" class="form-control" name="cover" accept="image/*,video/*">
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" name="is_public" id="isPublicSwitch">
                            <label class="form-check-label" for="isPublicSwitch">Público (todos podem modificar)</label>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Criar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', carregarGalerias);

    async function carregarGalerias() {
        try {
            const res = await fetch('/api/galeria');
            const data = await res.json();
            
            // CORREÇÃO: data.galerias -> data.galleries (API retorna em inglês agora)
            if (data.success && Array.isArray(data.galleries)) {
                const container = document.getElementById('lista-galerias');
                
                if (data.galleries.length === 0) {
                    container.innerHTML = '<div class="col-12 text-center text-muted p-5">Nenhuma galeria encontrada. Crie a primeira!</div>';
                    return;
                }

                container.innerHTML = data.galleries.map(g => `
                    <div class="imagem">
                        <a href="/galeria/${g.id}">
                            <!-- CORREÇÃO: g.capa_url -> g.cover_url e g.nome -> g.name -->
                            <img src="${g.cover_url || '/images/placeholder-album.png'}" alt="${g.name}" onerror="this.src='/images/placeholder-album.png'">
                            <div class="texto-hover">
                                <div>${g.name}</div>
                                <small>por ${g.owner ? g.owner.username : 'Desconhecido'}</small>
                            </div>
                        </a>
                    </div>
                `).join('');
            }
        } catch (err) {
            console.error('Erro ao carregar galerias:', err);
            document.getElementById('lista-galerias').innerHTML = '<div class="text-danger text-center">Erro ao carregar galerias.</div>';
        }
    }

    function abrirModalCriarGaleria() {
        const modal = new bootstrap.Modal(document.getElementById('modalCriarGaleria'));
        modal.show();
    }

    document.getElementById('formCriarGaleria').addEventListener('submit', async (e) => {
        e.preventDefault();
        const form = e.target;
        const formData = new FormData(form);
        
        // Garante que is_public seja string 'true' ou 'false'
        formData.set('is_public', form.is_public.checked ? 'true' : 'false');
        
        try {
            const res = await fetch('/api/galeria', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            
            if (data.success) {
                bootstrap.Modal.getInstance(document.getElementById('modalCriarGaleria')).hide();
                form.reset();
                carregarGalerias();
                if(typeof mostrarAviso === 'function') mostrarAviso('Álbum criado com sucesso!', 'Sucesso');
            } else {
                if(typeof mostrarConfirmacao === 'function') await mostrarConfirmacao(data.message, 'Erro');
                else alert('Erro: ' + data.message);
            }
        } catch (err) {
            console.error('Erro ao criar galeria:', err);
            if(typeof mostrarConfirmacao === 'function') await mostrarConfirmacao('Erro ao criar galeria.', 'Erro');
            else alert('Erro ao criar galeria.');
        }
    });
</script>

<style>
    .galeria {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        padding: 20px 0;
    }

    .imagem {
        position: relative;
        width: 100%;
        height: 0;
        padding-top: 100%; /* Aspect Ratio 1:1 */
        border-radius: 12px;
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        background-color: #f8f9fa;
    }

    .imagem a {
        display: block;
        width: 100%;
        height: 100%;
        position: absolute; /* Fixa o link sobre toda a área do padding-top */
        top: 0;
        left: 0;
    }

    .imagem img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .imagem:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        z-index: 10;
    }

    .texto-hover {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        background: linear-gradient(transparent, rgba(0,0,0,0.8));
        padding: 20px 10px 10px;
        color: white;
        text-align: center;
        opacity: 0; /* Opcional: só mostrar no hover se preferir, mas o CSS original mantinha visivel ou com transição de fundo */
        transition: opacity 0.3s ease, background 0.3s ease;
        opacity: 1; /* Mantendo visível conforme original, ajustado apenas o gradiente no hover abaixo */
    }

    .imagem:hover .texto-hover {
        background: linear-gradient(transparent, rgba(0,0,0,0.95));
    }

    @media (max-width: 768px) {
        .galeria {
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
        }
    }
</style>