<style>
    /* Popup de confirmação de exclusão */
    #popup-confirmacao .popup-conteudo {
        background: #fffbe6;
        border: 2px solid #ffe58f;
        max-width: 400px;
    }
    
    #popup-confirmacao .popup-conteudo p {
        color: #a67c00;
    }
    
    .confirmacao-nome-filme {
        color: #d48806;
        background: #fffbe6;
        border: 1px dashed #ffe58f;
        user-select: all;
    }
    
    /* Popup de filme/série */
    #popup .popup-conteudo {
        max-width: 800px;
    }
    
    .popup-topo {
        background-size: cover;
        background-position: center;
        border-radius: 12px 12px 0 0;
        min-height: 300px;
    }
    
    #imagem-popup {
        width: 120px;
        height: 180px;
        object-fit: cover;
        border: 3px solid #fff;
    }
    
    .popup-title {
        font-size: 2em;
        color: #fff;
        text-shadow: 1px 1px 8px #000;
    }
    
    .popup-type {
        font-size: 1.2em;
        color: #ffd700;
        text-shadow: 1px 1px 6px #000;
    }
    
    .popup-inferior {
        background: #fff;
        border-radius: 0 0 12px 12px;
    }
    
    .movie-overview {
        max-height: 300px;
        min-height: 120px;
        overflow-y: auto;
        border-right: 1px solid #eee;
    }
    
    /* Grid de obras */
    .tabela {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        gap: 15px;
    }
    
    .conteudo {
        height: 240px;
    }
    
    .conteudo .capa {
        max-height: 80%;
        max-width: 90%;
        object-fit: contain;
        cursor: url('/img/cursor-mao.png'), auto;
    }
    
    .conteudo h1 {
        font-size: 13px;
        text-transform: uppercase;
    }
    
    /* Modal de Loading */
    #loading-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    #loading-modal.show {
        display: flex;
    }
    
    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* Popup base */
    .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.288);
        z-index: 1000;
        overflow: hidden;
    }
    
    .popup-conteudo {
        background-color: rgba(255, 255, 255, 0.212);
        max-width: 800px;
        max-height: 90vh;
        overflow: auto;
    }
    
    /* Busca de filmes */
    #results {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        margin: 20px;
    }
    
    .movie {
        max-width: 120px;
    }
    
    .movie img {
        width: 100%;
    }

    h3 {
        color: #444;
        border-bottom: 2px solid #eee;
        padding-bottom: 10px;
        margin-top: 30px;
    }
</style>

<main class="text-center">
    <h2 class="mb-4">WatchList do Boteco</h2>
    <div class="container mb-4 text-start">
    </div>
    <div class="container">
        <h3 class="text-start mb-3">Para Assistir</h3>
        <div class="tabela mb-5" id="tabela-pendentes">
            <!-- Aqui serão inseridas as obras pendentes -->
        </div>

        <h3 class="text-start mb-3">Já Vistos</h3>
        <div class="tabela" id="tabela-vistos">
            <!-- Aqui serão inseridas as obras vistas -->
        </div>
    </div>

    <div id="popup" class="popup d-none">
        <div id="popup-conteudo" class="popup-conteudo rounded shadow-lg overflow-hidden p-0"></div>
    </div>

    <div id="popup-pesquisa" class="popup d-none">
        <div class="popup-conteudo bg-white rounded shadow-lg p-4">
            <h2 class="mb-3">Buscar por título</h2>
            <div class="mb-3">
                <input type="text" id="search-input" class="form-control" placeholder="Digite o nome do título">
            </div>
            <div class="mb-3">
                <button class="btn btn-secondary" onclick="fecharPopupPesquisa()">Fechar</button>
            </div>
            <div id="results"></div>
        </div>
    </div>

    <!-- Popup de confirmação de exclusão -->
    <div id="popup-confirmacao" class="popup d-none">
        <div id="popup-confirmacao-conteudo" class="popup-conteudo rounded shadow-lg p-4 d-flex flex-column align-items-center">
            <p class="fs-5 text-center mb-3">Tem certeza de que deseja excluir esta obra?</p>
            <div id="confirmacao-nome-filme" class="confirmacao-nome-filme d-none rounded p-2 mb-3 fw-bold text-center"></div>
            <div class="d-flex gap-2">
                <button id="confirmarDelecaoBtn" class="btn btn-danger">Sim, excluir</button>
                <button onclick="fecharConfirmacao()" class="btn btn-secondary">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Loading -->
    <div id="loading-modal">
        <div class="loading-content bg-white rounded shadow-lg p-4 text-center">
            <div class="spinner rounded-circle mx-auto mb-3"></div>
            <div class="loading-text fs-5 fw-medium">Carregando...</div>
        </div>
    </div>
</main>

<script>

// Vetor de obras locais
let obrasWatchlist = [];

// Funções de loading
function OnLoadingScreen() {
    document.getElementById('loading-modal').classList.add('show');
}

function OffLoadingScreen() {
    document.getElementById('loading-modal').classList.remove('show');
}

document.addEventListener('DOMContentLoaded', () => carregarWatchlist());

async function carregarWatchlist() {
    OnLoadingScreen();
    try {
        const response = await fetch(`/api/watchlist/watchlistdownload-movies`);
        const data = await response.json();

        // Verifique se a resposta é um array antes de atribuir a obrasWatchlist
        if (Array.isArray(data)) {
            obrasWatchlist = data;
            listarObras();
        } else {
            console.error('Formato de dados inválido, esperado um array:', data);
        }
    } catch (error) {
        console.error('Erro ao buscar obras do backend:', error);
    } finally {
        OffLoadingScreen();
    }
}

async function removerObra(id) {
    OnLoadingScreen();
    try {
        // Fazendo a requisição DELETE para o backend
        const response = await fetch(`/api/watchlist/watchlistdelete-movie?id=${encodeURIComponent(id)}`, { method: 'DELETE' });
        const data = await response.json();

        if (data.success) {
            // Remove a obra localmente
            obrasWatchlist = obrasWatchlist.filter(obra => String(obra.id) !== String(id));
            // Atualiza a interface
            listarObras();
        } else {
            mostrarAviso(data.message || 'Erro ao excluir a obra.');
        }
    } catch (error) {
        console.error('Erro ao deletar obra:', error);
        mostrarAviso('Erro ao excluir a obra. Verifique a conexão.');
    } finally {
        OffLoadingScreen();
    }
}

async function atualizarStatusObra(id, watched, custom_rating) {
    const body = { id };
    if (watched !== null) body.watched = watched;
    if (custom_rating !== null) body.custom_rating = custom_rating === '' ? null : parseFloat(custom_rating);

    try {
        const response = await fetch('/api/watchlist/watchlistupdate-status', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await response.json();

            if (data.success) {
                // Atualiza localmente
                const index = obrasWatchlist.findIndex(o => String(o.id) === String(id));
                if (index !== -1) {
                    if (watched !== null) obrasWatchlist[index].iswatched = watched;
                    if (custom_rating !== null) obrasWatchlist[index].voteboteco = body.custom_rating;
                    listarObras();
                }
            } else {
            mostrarAviso(data.message || 'Erro ao atualizar status.');
        }
    } catch (error) {
        console.error('Erro ao atualizar status:', error);
        mostrarAviso('Erro ao atualizar status.');
    }
}

function listarObras() {
    const tabelaPendentes = document.getElementById('tabela-pendentes');
    const tabelaVistos = document.getElementById('tabela-vistos');
    tabelaPendentes.innerHTML = '';
    tabelaVistos.innerHTML = '';

    // Quadro de adicionar sempre no início dos pendentes
    const quadroInicial = document.createElement('div');
    quadroInicial.className = 'conteudo card shadow-sm d-flex flex-column align-items-center justify-content-between p-2';
    quadroInicial.innerHTML = `
        <img src="images/+.png" class="capa rounded" alt="Adicionar" onclick="abrirPopupAdicionar()">
        <h1 class="fw-bold text-dark">Adicionar</h1>
    `;
    tabelaPendentes.appendChild(quadroInicial);

    obrasWatchlist.forEach(obra => {
        const conteudo = document.createElement('div');
        conteudo.className = 'conteudo card shadow-sm d-flex flex-column align-items-center justify-content-between p-2';
        
        // Usar posterurl se disponível (nome do campo no modelo), caso contrário poster_path
        const poster = obra.posterurl || obra.poster_path;
        const posterPath = poster ? `https://image.tmdb.org/t/p/w500${poster}` : 'https://via.placeholder.com/200x300?text=No+Image';
        const titulo = obra.title || obra.name;

        conteudo.innerHTML = `
            <img src="${posterPath}" class="capa rounded" alt="Capa de ${titulo}" onclick="abrirPopup('${posterPath}', '${obra.id}')">
            <h1 class="fw-bold text-dark">${titulo}</h1>
            ${obra.voteboteco ? `<div class="badge bg-warning text-dark">★ ${obra.voteboteco.toFixed(1)}</div>` : ''}
        `;

        if (obra.iswatched) {
            tabelaVistos.appendChild(conteudo);
        } else {
            tabelaPendentes.appendChild(conteudo);
        }
    });
}

function abrirPopupAdicionar() {
    const popup = document.getElementById('popup-pesquisa');
    popup.classList.remove('d-none');
    popup.classList.add('d-flex', 'justify-content-center', 'align-items-center');
}

function abrirPopup(url, id) {
    const popup = document.getElementById('popup');
    const popupConteudo = document.getElementById('popup-conteudo');
    const obra = obrasWatchlist.find(o => String(o.id) === String(id));

    if (!obra) {
        popupConteudo.innerHTML = `<p class="p-4">Obra não encontrada!</p>`;
        popup.classList.remove('d-none');
        popup.classList.add('d-flex', 'justify-content-center', 'align-items-center');
        return;
    }

    const nome = obra.title || obra.name;

    function renderStars(nota) {
        const rating = Math.round(nota) / 2;
        const fullStars = Math.floor(rating);
        const halfStar = rating % 1 >= 0.5;
        let stars = '';
        for (let i = 0; i < fullStars; i++) stars += '★';
        if (halfStar) stars += '⯨';
        const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);
        for (let i = 0; i < emptyStars; i++) stars += '☆';
        return `<span style='color: gold; font-size: 1.3em;'>${stars}</span> <span style='font-size: 1em; color: #444;'>(${(nota).toFixed(1)}/10)</span>`;
    }

    const tipo = (obra.type === 'tv' || obra.media_type === 'tv') ? 'Série' : 'Filme';
    // Usar backdropurl se disponível (modelo), senão backdrop_path
    const bdrop = obra.backdropurl || obra.backdrop_path;
    const backdropUrl = bdrop ? `https://image.tmdb.org/t/p/original${bdrop}` : '';
    
    let dataFormatada = 'N/A';
    const relDate = obra.releasedate || obra.release_date;
    if (relDate) {
        const match = relDate.match(/^\d{4}-\d{2}-\d{2}/);
        dataFormatada = match ? match[0] : relDate;
    }

    const vAverage = obra.voteaverage !== undefined ? obra.voteaverage : obra.vote_average;
    const vCount = obra.votecount !== undefined ? obra.votecount : obra.vote_count;

    popupConteudo.innerHTML = `
        <div class="popup-novo-layout">
            <div class="popup-topo d-flex align-items-center p-4 gap-4 placeholder-glow" style="background-color: #6c757d;">
                <img id='imagem-popup' src='${url}' alt='Imagem da obra' class="rounded shadow">
                <div>
                    <div class="popup-title">${obra.title || obra.name}</div>
                    <div class="popup-type mt-2">${tipo}</div>
                </div>
            </div>
            <div class="popup-inferior d-flex gap-4 p-4">
                <div class="movie-overview flex-fill pe-3 text-start">
                    <strong>Sinopse:</strong><br>${obra.overview || 'Sem descrição disponível'}
                </div>
                <div class="popup-movie-info d-flex flex-column gap-2">
                    <div class="text-dark">${dataFormatada}</div>
                    <div class="star-rating">${renderStars(vAverage || 0)}</div>
                    <div class="vote-count text-muted small">${vCount || 0} votos</div>
                    ${obra.original_title && obra.original_title !== obra.title ? `<div><strong>Título original:</strong> ${obra.original_title}</div>` : ''}
                    ${obra.originallang || obra.original_language ? `<div class="text-uppercase">${obra.originallang || obra.original_language}</div>` : ''}
                    <div class="mt-2 small text-muted">
                        Sugerido por: <strong>${obra.requester ? obra.requester.username : 'Sistema'}</strong>
                    </div>
                    
                    <hr class="my-2">
                    
                    <div class="d-flex flex-column gap-2">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="watched-switch" ${obra.iswatched ? 'checked' : ''} onchange="atualizarStatusObra('${obra.id}', this.checked, null)">
                            <label class="form-check-label" for="watched-switch">Já assistimos</label>
                        </div>
                        <div class="d-flex align-items-center gap-2">
                            <label for="custom-rating" class="small">Nossa Nota:</label>
                            <input type="number" id="custom-rating" class="form-control form-control-sm" style="width: 60px;" step="0.1" min="0" max="10" value="${obra.voteboteco || ''}" onchange="atualizarStatusObra('${obra.id}', null, this.value)">
                        </div>
                    </div>

                    <div class="d-flex gap-2 mt-3">
                        <button class='btn btn-danger btn-sm' onclick="abrirConfirmacaoDelecao('${obra.id}')">Deletar</button>
                        <button class='btn btn-secondary btn-sm' onclick='fecharPopup()'>Fechar</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    popup.classList.remove('d-none');
    popup.classList.add('d-flex', 'justify-content-center', 'align-items-center');
    
    // Carregar backdrop com placeholder
    if (backdropUrl) {
        const popupTopo = popupConteudo.querySelector('.popup-topo');
        const img = new Image();
        img.onload = function() {
            popupTopo.style.backgroundImage = `url('${backdropUrl}')`;
            popupTopo.classList.remove('placeholder-glow');
        };
        img.src = backdropUrl;
    }
}

function abrirConfirmacaoDelecao(id) {
    const popupConfirmacao = document.getElementById('popup-confirmacao');
    const confirmarDelecaoBtn = document.getElementById('confirmarDelecaoBtn');
    const obra = obrasWatchlist.find(o => String(o.id) === String(id));

    if (obra) {
        confirmarDelecaoBtn.setAttribute('data-id-obra', obra.id);
        confirmarDelecaoBtn.setAttribute('data-nome-obra', obra.title || obra.name);
        
        const confirmacaoConteudo = document.getElementById('popup-confirmacao-conteudo');
        let inputConfirmacao = document.getElementById('input-confirmacao-nome');
        
        if (!inputConfirmacao) {
            inputConfirmacao = document.createElement('input');
            inputConfirmacao.type = 'text';
            inputConfirmacao.id = 'input-confirmacao-nome';
            inputConfirmacao.className = 'form-control mb-3';
            inputConfirmacao.placeholder = `Digite o nome para confirmar: ${obra.title || obra.name}`;
            confirmacaoConteudo.insertBefore(inputConfirmacao, confirmacaoConteudo.querySelector('.d-flex'));
        } else {
            inputConfirmacao.value = '';
            inputConfirmacao.placeholder = `Digite o nome para confirmar: ${obra.title || obra.name}`;
        }
        
        const nomeFilmeDiv = document.getElementById('confirmacao-nome-filme');
        if (nomeFilmeDiv) {
            nomeFilmeDiv.textContent = obra.title || obra.name;
            nomeFilmeDiv.classList.remove('d-none');
        }
        
        popupConfirmacao.classList.remove('d-none');
        popupConfirmacao.classList.add('d-flex', 'justify-content-center', 'align-items-center');
    } else {
        mostrarAviso('Obra não encontrada!');
    }
}

function fecharPopup(){
    const popup = document.getElementById('popup');
    popup.classList.add('d-none');
    popup.classList.remove('d-flex');
}

function fecharPopupPesquisa(){
    const popup = document.getElementById('popup-pesquisa');
    popup.classList.add('d-none');
    popup.classList.remove('d-flex');
    document.getElementById("search-input").value = '';
    document.getElementById("results").innerHTML = '';
}

// Confirmar a exclusão diretamente ao clicar no botão
document.getElementById('confirmarDelecaoBtn').addEventListener('click', async function () {
    const idObra = this.getAttribute('data-id-obra'); // Obter o ID da obra
    const nomeObra = this.getAttribute('data-nome-obra');
    const inputConfirmacao = document.getElementById('input-confirmacao-nome');
    if (idObra && inputConfirmacao) {
        if (inputConfirmacao.value.trim() === nomeObra) {
            await removerObra(idObra);
            fecharConfirmacao();
            fecharPopup();
        } else {
            inputConfirmacao.style.border = '2px solid #ff4e50';
            inputConfirmacao.value = '';
            inputConfirmacao.placeholder = 'Nome incorreto, tente novamente.';
        }
    }
});

function fecharConfirmacao() {
    const popupConfirmacao = document.getElementById('popup-confirmacao');
    popupConfirmacao.classList.add('d-none');
    popupConfirmacao.classList.remove('d-flex');
    
    const nomeFilmeDiv = document.getElementById('confirmacao-nome-filme');
    if (nomeFilmeDiv) nomeFilmeDiv.classList.add('d-none');
}

let lastQuery = '';
let searchTimeout = null;

document.getElementById('search-input').addEventListener('input', function() {
    const query = this.value;

    if (query.length < 3) {
        document.getElementById('results').innerHTML = '';
        return;
    }

    if (query !== lastQuery) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchMovies(query);
        }, 500); // 500ms debounce
    }
});

async function searchMovies(query) {
    lastQuery = query;

    try {
        const response = await fetch(`/api/watchlist/watchlistsearch-movies?query=${encodeURIComponent(query)}&language='pt-BR'`);
        const data = await response.json();

        if (response.status !== 200) {
            throw new Error(data.message || 'Erro ao buscar filmes.');
        }

        displayResults(data);
    } catch (error) {
        console.error('Error:', error);
        // A função displayResults irá criar o elemento #results
        const resultsContainer = document.getElementById('results');
        if (resultsContainer) {
            resultsContainer.innerHTML = `<p>${error.message}</p>`;
        }
    }
}

function displayResults(items) {
    const resultsContainer = document.getElementById('results');
    resultsContainer.innerHTML = '';

    items.forEach(item => {
        const itemElement = document.createElement('div');
        itemElement.className = 'movie text-center';

        const posterPath = item.poster_path ? `https://image.tmdb.org/t/p/w500${item.poster_path}` : 'https://via.placeholder.com/200x300?text=No+Image';

        itemElement.innerHTML = `
            <img src="${posterPath}" alt="${item.title || item.name}" class="rounded">
            <div class="movie-title mt-2">${item.title || item.name}</div>
        `;

        itemElement.addEventListener('click', async () => {
            const shouldSave = await confirm(`Deseja adicionar "${item.title || item.name}" à Watchlist?`);
            if (shouldSave) {
                adicionarObra(item);
            }
        });

        resultsContainer.appendChild(itemElement);
    });
}

    async function adicionarObra(obra) {
        OnLoadingScreen();
        try {
            // Mapping TMDb fields to Model fields
            const mappedObra = {
                id: obra.id,
                title: obra.title || obra.name,
                overview: obra.overview,
                popularity: obra.popularity,
                type: obra.media_type,
                originallang: obra.original_language,
                posterurl: obra.poster_path,
                backdropurl: obra.backdrop_path,
                releasedate: obra.release_date || obra.first_air_date,
                voteaverage: obra.vote_average,
                votecount: obra.vote_count
            };

            // Enviando o filme/série para o backend
            const response = await fetch('/api/watchlist/watchlistupload-movies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(mappedObra),
            });

            const data = await response.json();
            if (!response.ok) {
                const errMsg = data.message || 'Erro ao adicionar o filme/série.';
                const details = data.errors ? ('\n' + data.errors.map(e => `${e.field}: ${e.message}`).join('\n')) : '';
                mostrarAviso(errMsg + details);
                return;
            }

            if (data.success) {
                // Preferir o registro salvo retornado pelo backend, se existir
                const saved = data.saved || null;
                const newEntry = saved ? saved : { ...obra, fileUrl: data.fileUrl };

                // Remover se já existir (evitar duplicatas na UI)
                obrasWatchlist = obrasWatchlist.filter(item => String(item.id) !== String(newEntry.id));

                // Encontrar a posição correta para inserir o filme/série na ordem alfabética
                const index = obrasWatchlist.findIndex(item => {
                    const itemTitle = (item.title || item.name || '').toString();
                    const obraTitle = (newEntry.title || newEntry.name || '').toString();
                    return itemTitle.localeCompare(obraTitle, undefined, { sensitivity: 'base' }) > 0;
                });

                // Adiciona o filme na posição correta
                obrasWatchlist.splice(
                    index === -1 ? obrasWatchlist.length : index,
                    0,
                    newEntry
                );

                // Atualiza a interface sem recarregar tudo
                listarObras();
                fecharPopupPesquisa();
            } else {
                mostrarAviso('Erro ao adicionar o filme/série.');
            }
        } catch (error) {
            console.error('Erro ao adicionar filme/série:', error);
            mostrarAviso('Erro ao adicionar o filme/série.');
        } finally {
            OffLoadingScreen();
        }
    }
</script>