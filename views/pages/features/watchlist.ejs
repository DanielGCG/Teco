<style>
    .watchlist-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
        border: none;
        background: var(--fundo-card, #fff);
    }
    .watchlist-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0,0,0,0.1) !important;
    }
    .watchlist-capa {
        aspect-ratio: 2/3;
        object-fit: cover;
    }
    .watchlist-title {
        font-size: 0.85rem;
        font-weight: 600;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        min-height: 1rem;
        line-height: 1.1rem;
    }
    .btn-adicionar-obra {
        width: 100%;
        border: 2px dashed #dee2e6;
        background: rgba(var(--bs-light-rgb), 0.5);
        color: var(--bs-secondary);
        transition: all 0.2s;
    }
    .btn-adicionar-obra:hover {
        border-color: var(--bs-primary);
        color: var(--bs-primary);
        background: rgba(var(--bs-primary-rgb), 0.05);
    }
    .modal-backdrop-blur {
        backdrop-filter: blur(5px);
    }
    .modal-hero {
        height: 300px;
        background-size: cover;
        background-position: center;
        position: relative;
    }
    .modal-hero::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(to bottom, rgba(0,0,0,0) 20%, rgba(0,0,0,0.8));
    }
    .search-result-item {
        cursor: pointer;
        transition: opacity 0.2s;
    }
    .search-result-item:hover {
        opacity: 0.8;
    }
    /* Star Rating Interactive */
    .star-wrapper {
        display: inline-block;
        position: relative;
        font-size: 1.5rem;
    }
    .star-half-zone {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 50%;
        z-index: 2;
        cursor: pointer;
    }
    .star-half-zone.left { left: 0; }
    .star-half-zone.right { right: 0; }
</style>

<main class="container">
    <!-- Para Assistir -->
    <section class="mb-5">
        <div class="d-flex align-items-center mb-4">
            <h3 class="fw-bold mb-0 me-3">Para Assistir</h3>
            <span class="badge bg-primary rounded-pill" id="count-pendentes">0</span>
        </div>
        <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 row-cols-xl-6 g-4" id="tabela-pendentes">
            <!-- Botão Adicionar (Fixo) -->
            <div class="col border-end pe-4">
                <div class="btn-adicionar-obra rounded-4 d-flex flex-column align-items-center justify-content-center h-100" onclick="bsModalBusca.show()">
                    <i class="bi bi-plus-lg fs-1"></i>
                    <span class="fw-bold mt-2">Adicionar</span>
                </div>
            </div>
            <!-- Inserido via JS -->
        </div>
    </section>

    <!-- Já Vistos -->
    <section>
        <div class="d-flex align-items-center mb-4">
            <h3 class="fw-bold mb-0 me-3 text-secondary">Já Vistos</h3>
            <span class="badge bg-secondary rounded-pill" id="count-vistos">0</span>
        </div>
        <div class="row row-cols-2 row-cols-sm-3 row-cols-md-4 row-cols-lg-5 row-cols-xl-6 g-4" id="tabela-vistos">
            <!-- Inserido via JS -->
        </div>
    </section>
</main>

<template id="template-card">
    <div class="col">
        <div class="card watchlist-card rounded-4 shadow-sm overflow-hidden h-100">
            <img class="watchlist-capa" src="">
            <div class="card-body p-2 pb-1 text-center">
                <div class="watchlist-title mb-0"></div>
                <div class="badge-boteco-container"></div>
            </div>
        </div>
    </div>
</template>

<!-- Modal Detalhes -->
<div class="modal fade" id="modalObra" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg overflow-hidden">
            <div id="modal-hero" class="modal-hero">
                <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3 z-3" data-bs-dismiss="modal"></button>
                <div class="position-absolute bottom-0 start-0 p-4 text-white z-2 d-flex gap-4 align-items-end">
                    <img id="modal-poster" src="" class="rounded-3 shadow" style="width: 120px; border: 2px solid #fff;">
                    <div>
                        <h2 id="modal-title" class="fw-bold bg-light"></h2>
                        <div class="opacity-75 small">
                            <span id="modal-type" class="text-uppercase badge bg-light text-dark me-2"></span>
                            <span id="modal-date"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-body p-4 bg-white">
                <div class="row g-4">
                    <div class="col-md-7 border-end">
                        <h6 class="fw-bold text-uppercase text-secondary mb-3">Sinopse</h6>
                        <p id="modal-overview" class="mb-0 text-dark"></p>
                    </div>
                    <div class="col-md-5">
                        <div class="small mb-4">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted">Avaliação TMDb:</span>
                                <span class="fw-bold"><i class="bi bi-star-fill text-warning me-1"></i><span id="modal-tmdb-vote"></span>/10</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Original:</span>
                                <span id="modal-lang" class="text-uppercase"></span>
                            </div>
                            <div class="text-muted small">Sugerido por: <span id="modal-requester" class="fw-bold text-dark"></span></div>
                        </div>

                        <div class="card bg-light border-0 p-3 rounded-4">
                            <div class="form-check form-switch mb-3">
                                <input class="form-check-input" type="checkbox" id="sw-watched">
                                <label class="form-check-label fw-bold" for="sw-watched">Já assistimos</label>
                            </div>
                            <div class="mb-3">
                                <label class="small text-muted fw-bold d-block mb-1">Nosso Indicador (Clique para avaliar)</label>
                                <div id="modal-stars-display" class="mb-2"></div>
                            </div>
                            <div class="d-flex gap-2">
                                <button id="btn-remover-obra" class="btn btn-outline-danger btn-sm flex-grow-1">
                                    <i class="bi bi-trash"></i> Remover
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Busca -->
<div class="modal fade" id="modalBusca" tabindex="-1" aria-labelledby="modalBuscaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold" id="modalBuscaLabel">Adicionar novo título</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="input-group mb-4 shadow-sm">
                    <span class="input-group-text bg-white border-end-0"><i class="bi bi-search"></i></span>
                    <input type="text" id="search-input" class="form-control border-start-0 ps-0" placeholder="Digite o nome do filme ou série...">
                </div>
                <div id="results" class="row row-cols-3 g-2"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Confirmação -->
<div class="modal fade" id="modalConfirmacao" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow text-center p-4">
            <div class="text-danger mb-3"><i class="bi bi-exclamation-triangle fs-1"></i></div>
            <h5 class="fw-bold mb-2">Remover título?</h5>
            <p class="small text-muted mb-3">Para confirmar, digite o nome:</p>
            <div id="confirmacao-nome-exibicao" class="p-2 bg-light rounded small mb-3 fw-bold"></div>
            <input type="text" id="input-confirmacao-nome" class="form-control mb-4 text-center" placeholder="...">
            <div class="d-grid gap-2">
                <button id="btnConfirmarDelecao" class="btn btn-danger py-2 fw-bold">Confirmar Exclusão</button>
                <button class="btn btn-light py-2" data-bs-dismiss="modal">Cancelar</button>
            </div>
        </div>
    </div>
</div>

<script>
let obrasWatchlist = [];
let bsModalObra, bsModalBusca, bsModalConfirmacao;

// Helper para renderizar estrelas
function renderStars(nota, interactive = false, publicid = null) {
    const rating = (nota !== null && nota !== undefined && nota !== '') ? parseFloat(nota) : 0;
    let html = `<div class="text-warning d-inline-flex gap-1 mt-1 ${interactive ? 'interactive-stars' : ''}">`;
    
    for (let i = 1; i <= 5; i++) {
        const fullVal = i * 2;
        const halfVal = fullVal - 1;
        
        if (interactive) {
            html += `
                <span class="star-wrapper">
                    <i class="bi ${rating >= fullVal ? 'bi-star-fill' : (rating >= halfVal ? 'bi-star-half' : 'bi-star')}"></i>
                    <span class="star-half-zone left" onclick="atualizarStatusObra('${publicid}', null, ${halfVal}); updateModalStars('${publicid}', ${halfVal})"></span>
                    <span class="star-half-zone right" onclick="atualizarStatusObra('${publicid}', null, ${fullVal}); updateModalStars('${publicid}', ${fullVal})"></span>
                </span>`;
        } else {
            if (rating >= fullVal) html += '<i class="bi bi-star-fill"></i>';
            else if (rating >= halfVal) html += '<i class="bi bi-star-half"></i>';
            else if (!interactive) html += '<i class="bi bi-star text-muted opacity-25"></i>';
        }
    }
    
    html += '</div>';
    return (nota || interactive) ? html : '';
}

function updateModalStars(publicid, nota) {
    const display = document.getElementById('modal-stars-display');
    if (display) display.innerHTML = renderStars(nota, true, publicid);
}

document.addEventListener('DOMContentLoaded', () => {
    // Inicializar modais do Bootstrap
    bsModalObra = new bootstrap.Modal(document.getElementById('modalObra'));
    bsModalBusca = new bootstrap.Modal(document.getElementById('modalBusca'));
    bsModalConfirmacao = new bootstrap.Modal(document.getElementById('modalConfirmacao'));

    carregarWatchlist();
});

async function carregarWatchlist() {
    try {
        const response = await fetch(`/api/watchlist/watchlistdownload-movies`);
        const data = await response.json();
        if (Array.isArray(data)) {
            obrasWatchlist = data;
            listarObras();
        }
    } catch (error) {
        console.error('Erro ao buscar obras:', error);
    }
}

function listarObras() {
    const pendentesList = document.getElementById('tabela-pendentes');
    const vistosList = document.getElementById('tabela-vistos');
    const template = document.getElementById('template-card');

    // Limpar conteúdo dinâmico, mas manter o botão de adicionar
    const cardsPendentes = pendentesList.querySelectorAll('.col:not(:first-child)');
    cardsPendentes.forEach(c => c.remove());
    vistosList.innerHTML = '';

    let pendentesCount = 0;
    let vistosCount = 0;

    obrasWatchlist.forEach(obra => {
        const clone = template.content.cloneNode(true);
        const card = clone.querySelector('.card');
        const img = clone.querySelector('.watchlist-capa');
        const titleEl = clone.querySelector('.watchlist-title');
        const badgeContainer = clone.querySelector('.badge-boteco-container');

        const poster = obra.posterurl || obra.poster_path;
        const posterPath = poster ? `https://image.tmdb.org/t/p/w500${poster}` : 'https://via.placeholder.com/200x300?text=Sem+Capa';
        const titulo = obra.title || obra.name;

        img.src = posterPath;
        titleEl.textContent = titulo;
        
        badgeContainer.innerHTML = renderStars(obra.voteboteco);

        card.onclick = () => abrirPopupDetalhes(obra.publicid);

        if (obra.iswatched) {
            vistosList.appendChild(clone);
            vistosCount++;
        } else {
            pendentesList.appendChild(clone);
            pendentesCount++;
        }
    });

    document.getElementById('count-pendentes').textContent = pendentesCount;
    document.getElementById('count-vistos').textContent = vistosCount;
}

function abrirPopupDetalhes(publicid) {
    const obra = obrasWatchlist.find(o => o.publicid === publicid);
    if (!obra) return;

    // Elementos do Modal
    const hero = document.getElementById('modal-hero');
    const posterImg = document.getElementById('modal-poster');
    const titleEl = document.getElementById('modal-title');
    const typeEl = document.getElementById('modal-type');
    const dateEl = document.getElementById('modal-date');
    const overviewEl = document.getElementById('modal-overview');
    const tmdbVoteEl = document.getElementById('modal-tmdb-vote');
    const langEl = document.getElementById('modal-lang');
    const requesterEl = document.getElementById('modal-requester');
    const swWatched = document.getElementById('sw-watched');
    const btnRemover = document.getElementById('btn-remover-obra');

    // Backdrop e Poster
    const bdrop = obra.backdropurl || obra.backdrop_path;
    const bannerUrl = bdrop ? `https://image.tmdb.org/t/p/original${bdrop}` : '';
    const poster = obra.posterurl || obra.poster_path;
    const posterPath = `https://image.tmdb.org/t/p/w500${poster}`;

    hero.style.backgroundImage = bannerUrl ? `url('${bannerUrl}')` : 'none';
    posterImg.src = posterPath;
    titleEl.textContent = obra.title || obra.name;
    typeEl.textContent = obra.type === 'tv' ? 'Série' : 'Filme';
    dateEl.textContent = obra.releasedate || obra.release_date || 'N/A';
    overviewEl.textContent = obra.overview || 'Nenhuma descrição disponível.';
    tmdbVoteEl.textContent = parseFloat(obra.voteaverage || obra.vote_average || 0).toFixed(1);
    langEl.textContent = obra.originallang || obra.original_language || '??';
    
    if (obra.requester) {
        requesterEl.innerHTML = `<a href="/${obra.requester.username}" class="text-decoration-none fw-bold text-primary">${obra.requester.username}</a>`;
    } else {
        requesterEl.textContent = 'Sistema';
    }

    // Status e Nota
    swWatched.checked = !!obra.iswatched;
    document.getElementById('modal-stars-display').innerHTML = renderStars(obra.voteboteco, true, obra.publicid);

    // Eventos (limpar antigos e adicionar novos)
    swWatched.onchange = (e) => atualizarStatusObra(obra.publicid, e.target.checked, null);
    btnRemover.onclick = () => iniciarDelecao(obra.publicid);

    bsModalObra.show();
}

async function atualizarStatusObra(publicid, watched, custom_rating) {
    const body = { publicid };
    if (watched !== null) body.watched = watched;
    if (custom_rating !== null) body.custom_rating = custom_rating === '' ? null : parseFloat(custom_rating);

    try {
        const response = await fetch('/api/watchlist/watchlistupdate-status', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        const data = await response.json();
        if (data.success) {
            const index = obrasWatchlist.findIndex(o => o.publicid === publicid);
            if (index !== -1) {
                if (watched !== null) obrasWatchlist[index].iswatched = watched;
                if (custom_rating !== null) obrasWatchlist[index].voteboteco = body.custom_rating;
                listarObras();
            }
        }
    } catch (e) {
        console.error('Erro ao atualizar:', e);
    }
}

function iniciarDelecao(publicid) {
    const obra = obrasWatchlist.find(o => o.publicid === publicid);
    if (!obra) return;

    document.getElementById('confirmacao-nome-exibicao').textContent = obra.title || obra.name;
    document.getElementById('input-confirmacao-nome').value = '';
    document.getElementById('btnConfirmarDelecao').onclick = () => confirmarDelecao(publicid);
    
    bsModalConfirmacao.show();
}

async function confirmarDelecao(publicid) {
    const obra = obrasWatchlist.find(o => o.publicid === publicid);
    const input = document.getElementById('input-confirmacao-nome');
    if (!obra || input.value.trim().toLowerCase() !== (obra.title || obra.name).toLowerCase()) {
        input.classList.add('is-invalid');
        return;
    }

    bsModalConfirmacao.hide();
    try {
        const response = await fetch(`/api/watchlist/watchlistdelete-movie?publicid=${publicid}`, { method: 'DELETE' });
        const data = await response.json();
        if (data.success) {
            obrasWatchlist = obrasWatchlist.filter(o => o.publicid !== publicid);
            listarObras();
            bsModalObra.hide();
        }
    } catch (e) {
        console.error('Erro ao deletar:', e);
    }
}

// Lógica de Busca
let searchTimer;
document.getElementById('search-input').addEventListener('input', (e) => {
    clearTimeout(searchTimer);
    const query = e.target.value;
    if (query.length < 3) return;
    searchTimer = setTimeout(() => buscarTitulos(query), 500);
});

async function buscarTitulos(query) {
    try {
        const res = await fetch(`/api/watchlist/watchlistsearch-movies?query=${encodeURIComponent(query)}`);
        const items = await res.json();
        const resultsEl = document.getElementById('results');
        resultsEl.innerHTML = '';

        items.forEach(item => {
            const poster = item.poster_path ? `https://image.tmdb.org/t/p/w200${item.poster_path}` : 'https://via.placeholder.com/200x300';
            const col = document.createElement('div');
            col.className = 'col search-result-item p-1';
            col.innerHTML = `<img src="${poster}" class="w-100 rounded-3 shadow-sm" title="${item.title || item.name}">`;
            col.onclick = () => adicionarObra(item);
            resultsEl.appendChild(col);
        });
    } catch (e) { console.error('Busca falhou:', e); }
}

async function adicionarObra(tmdbItem) {
    if (!confirm(`Adicionar "${tmdbItem.title || tmdbItem.name}"?`)) return;
    bsModalBusca.hide();
    try {
        const mapped = {
            id: tmdbItem.id,
            title: tmdbItem.title || tmdbItem.name,
            overview: tmdbItem.overview,
            popularity: tmdbItem.popularity,
            type: tmdbItem.media_type,
            originallang: tmdbItem.original_language,
            posterurl: tmdbItem.poster_path,
            backdropurl: tmdbItem.backdrop_path,
            releasedate: tmdbItem.release_date || tmdbItem.first_air_date,
            voteaverage: tmdbItem.vote_average,
            votecount: tmdbItem.vote_count
        };

        const res = await fetch('/api/watchlist/watchlistupload-movies', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(mapped)
        });
        const data = await res.json();
        if (data.success) {
            carregarWatchlist();
        } else {
            alert(data.message || 'Erro ao adicionar.');
        }
    } catch (e) { console.error('Erro:', e); }
}
</script>