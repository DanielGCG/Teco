
<main class="container py-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card shadow-sm mb-4">
                <div class="card-header py-3">
                    <h4 class="mb-1 fw-bold">Nova Sugestão</h4>
                </div>
                <div class="card-body">
                    <form id="formSugestao" enctype="multipart/form-data">
                        <div class="mb-4">
                            <label for="imagem" class="form-label fw-semibold">Selecione uma imagem:</label>
                            <input type="file" class="form-control" id="imagem" accept="image/png,image/jpeg,image/gif" required>
                            <div class="mt-3 d-none justify-content-center align-items-center" id="preview-container">
                                <div style="position:relative;display:inline-block;">
                                    <img id="preview-img" src="" alt="Preview" style="width:200px;height:200px;object-fit:cover;box-shadow:0 0 8px #ccc;" />
                                    <img id="preview-border" src="" alt="Border" style="width:200px;height:200px;display:none;position:absolute;left:0;top:0;z-index:2;pointer-events:none;object-fit:cover;" />
                                </div>
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="defaultBorderSelect" class="form-label fw-semibold">Escolha uma moldura:</label>
                            <select id="defaultBorderSelect" class="form-select mb-3">
                                <!-- Molduras padrão serão carregadas dinamicamente -->
                            </select>
                            <div class="text-center">
                                <img id="preview-border-img" src="" alt="Preview Moldura" style="width:100px;height:100px;object-fit:cover;border:1px solid #eee;" />
                            </div>
                        </div>
                        <div class="mb-4">
                            <label for="texto" class="form-label fw-semibold">Texto da plaquinha:</label>
                            <input type="text" class="form-control" id="texto" placeholder="Máximo 32 caracteres" maxlength="32" required>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 py-2" id="adicionarButton">
                            <span id="btnText">Enviar Sugestão</span>
                            <span id="spinner" class="spinner-border spinner-border-sm d-none"></span>
                        </button>
                        <div id="feedback" class="mt-3 text-center"></div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</main>

<script>
const imagemInput = document.getElementById("imagem");
const previewImg = document.getElementById("preview-img");
const previewBorder = document.getElementById("preview-border");
const previewBorderImg = document.getElementById("preview-border-img");
const defaultBorderSelect = document.getElementById("defaultBorderSelect");
let currentBorderUrl = "";

async function carregarMoldurasPadrao() {
    try {
        const res = await fetch("/api/imagemdodia/borders");
        const borders = await res.json();
        // Armazenar os objetos para recuperar a URL no preview
        window.bordersCache = borders;
        defaultBorderSelect.innerHTML = borders.map(b => `<option value="${b.publicid}">${b.name}</option>`).join('');
        if (borders.length > 0) {
            defaultBorderSelect.value = borders[0].publicid;
            atualizarPreviewMoldura(borders[0].url);
        }
    } catch (err) {
        console.error("Erro ao carregar molduras:", err);
    }
}

function atualizarPreviewMoldura(url) {
    currentBorderUrl = url;
    previewBorderImg.src = url;
    // Só mostra a moldura no preview principal se já houver uma imagem carregada
    if (previewImg.src && previewImg.src.startsWith('data:')) {
        previewBorder.src = url;
        previewBorder.style.display = "block";
    }
}

defaultBorderSelect.addEventListener("change", (e) => {
    const border = window.bordersCache.find(b => b.publicid === e.target.value);
    if (border) atualizarPreviewMoldura(border.url);
});

imagemInput.addEventListener("change", function() {
    const file = this.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            previewImg.src = e.target.result;
            const container = document.getElementById("preview-container");
            container.classList.remove("d-none");
            container.classList.add("d-flex");
            previewBorder.src = currentBorderUrl;
            previewBorder.style.display = "block";
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById("formSugestao").addEventListener("submit", async function(e) {
    e.preventDefault();
    const btn = document.getElementById("adicionarButton");
    const feedback = document.getElementById("feedback");
    
    btn.disabled = true;
    document.getElementById("btnText").classList.add("d-none");
    document.getElementById("spinner").classList.remove("d-none");

    const formData = new FormData();
    formData.append("file", imagemInput.files[0]);
    formData.append("text", document.getElementById("texto").value.trim());
    formData.append("borderPublicId", defaultBorderSelect.value);

    try {
        const res = await fetch("/api/imagemdodia", { method: "POST", body: formData });
        if (res.ok) {
            feedback.textContent = "Sugestão enviada com sucesso!";
            feedback.className = "text-success";
            this.reset();
            const container = document.getElementById("preview-container");
            container.classList.add("d-none");
            container.classList.remove("d-flex");
            previewImg.src = "";
            previewBorder.style.display = "none";
        } else {
            const data = await res.json();
            feedback.textContent = data.message || "Erro ao enviar.";
            feedback.className = "text-danger";
        }
    } catch (err) {
        feedback.textContent = "Erro de conexão.";
        feedback.className = "text-danger";
    } finally {
        btn.disabled = false;
        document.getElementById("btnText").classList.remove("d-none");
        document.getElementById("spinner").classList.add("d-none");
    }
});

carregarMoldurasPadrao();
</script>
