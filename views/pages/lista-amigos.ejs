<style>
    .friends-container {
        padding: 2rem 0;
    }

    .tab-content {
        margin-top: 1.5rem;
    }

    .friend-card {
        transition: all 0.2s;
        border: 1px solid #dee2e6;
        margin-bottom: 0.75rem;
    }

        .friend-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            background: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 0.5rem;
            border: 2px solid white;
        }

        .status-indicator.online {
            background-color: #28a745;
        }

        .status-indicator.ausente {
            background-color: #ffc107;
        }

        .status-indicator.offline {
            background-color: #6c757d;
        }

        .search-box {
            margin-bottom: 1.5rem;
        }

        .no-results {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .request-card {
            background-color: #f8f9fa;
            border-left: 4px solid var(--mensagem-roxo, #7c4dff);
        }

        .badge-pending {
            background-color: #ffc107;
            color: #000;
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #6c757d;
        }

        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
        }
</style>

<div class="container friends-container">
    <div class="row">
        <div class="col-12">
            <!-- Tabs de navegação -->
            <ul class="nav nav-tabs" id="friendsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="friends-tab" data-bs-toggle="tab" data-bs-target="#friends" type="button" role="tab">
                            <i class="bi bi-people"></i> Amigos <span id="friends-count" class="badge bg-primary">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="requests-tab" data-bs-toggle="tab" data-bs-target="#requests" type="button" role="tab">
                            <i class="bi bi-inbox"></i> Pedidos Recebidos <span id="requests-count" class="badge bg-danger">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="sent-tab" data-bs-toggle="tab" data-bs-target="#sent" type="button" role="tab">
                            <i class="bi bi-send"></i> Pedidos Enviados <span id="sent-count" class="badge bg-warning text-dark">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search" type="button" role="tab">
                            <i class="bi bi-search"></i> Buscar Usuários
                        </button>
                    </li>
                </ul>

                <!-- Conteúdo das tabs -->
                <div class="tab-content" id="friendsTabContent">
                    <!-- Lista de Amigos -->
                    <div class="tab-pane fade show active" id="friends" role="tabpanel">
                        <div id="friends-list">
                            <div class="text-center">
                                <span class="spinner-border spinner-border-sm"></span> Carregando...
                            </div>
                        </div>
                    </div>

                    <!-- Pedidos Recebidos -->
                    <div class="tab-pane fade" id="requests" role="tabpanel">
                        <div id="requests-list">
                            <div class="text-center">
                                <span class="spinner-border spinner-border-sm"></span> Carregando...
                            </div>
                        </div>
                    </div>

                    <!-- Pedidos Enviados -->
                    <div class="tab-pane fade" id="sent" role="tabpanel">
                        <div id="sent-list">
                            <div class="text-center">
                                <span class="spinner-border spinner-border-sm"></span> Carregando...
                            </div>
                        </div>
                    </div>

                    <!-- Buscar Usuários -->
                    <div class="tab-pane fade" id="search" role="tabpanel">
                        <div class="search-box">
                            <div class="input-group">
                                <input type="text" id="search-input" class="form-control" placeholder="Digite o nome de usuário...">
                                <button class="btn btn-primary" id="search-btn">
                                    <i class="bi bi-search"></i> Buscar
                                </button>
                            </div>
                        </div>
                        <div id="search-results"></div>
                    </div>
                </div>
            </div>
    </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script>
    // Estado da aplicação
    let friends = [];
    let requests = [];
    let sent = [];
    
    // Reutiliza conexão Socket.IO global
    const friendsSocket = window.appSocket || notificationsSocket;
    
    if (!friendsSocket) {
        console.error('[Lista Amigos] Socket.IO não disponível!');
    } else {
        console.log('[Lista Amigos] Reutilizando conexão Socket.IO existente');
    }

    // ==================== Inicialização ====================
    document.addEventListener('DOMContentLoaded', () => {
        carregarAmigos();
        carregarPedidosRecebidos();
        carregarPedidosEnviados();

        // Event listeners
        document.getElementById('search-btn').addEventListener('click', buscarUsuarios);
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') buscarUsuarios();
        });
        
        // Socket.IO listeners
        friendsSocket.on('newFriendRequest', () => {
            carregarPedidosRecebidos();
        });
        
        friendsSocket.on('friendRequestAccepted', () => {
            carregarAmigos();
        });
        
        friendsSocket.on('friendRequestsUpdated', () => {
            carregarPedidosRecebidos();
            carregarPedidosEnviados();
        });
        
        // Socket.IO listeners para status online em tempo real (consolidados)
        friendsSocket.on('userStatusChanged', ({ userId, status }) => {
            console.log('[Amigos] Status do usuário', userId, 'mudou para:', status);
            atualizarStatusAmigo(userId, status);
        });
        
        friendsSocket.on('userStatusBatch', (statusMap) => {
            console.log('[Amigos] Status em lote recebidos:', statusMap);
            Object.entries(statusMap).forEach(([userId, status]) => {
                atualizarStatusAmigo(parseInt(userId), status);
            });
        });
    });
    
    // Solicita status atualizados de todos os amigos
    function requestAllFriendStatuses() {
        const friendIds = friends.map(f => f.id).filter(id => id);
        if (friendIds.length > 0) {
            console.log('[Amigos] Solicitando status atualizados para:', friendIds);
            friendsSocket.emit('requestUserStatus', { userIds: friendIds });
        }
    }
    
    // Função para atualizar status de um amigo em tempo real
    function atualizarStatusAmigo(userId, status) {
        const friend = friends.find(f => f.id === userId);
        if (friend) friend.status = status;
        
        const friendCards = document.querySelectorAll(`[data-user-id="${userId}"]`);
        friendCards.forEach(card => {
            const indicator = card.querySelector('.status-indicator');
            if (indicator) indicator.className = `status-indicator ${status}`;
        });
    }

        // ==================== Funções de carregamento ====================
        async function carregarAmigos() {
            try {
                const res = await fetch('/amigos/api/', { credentials: 'include' });
                if (!res.ok) throw new Error('Erro ao carregar amigos');
                
                const data = await res.json();
                friends = data.friends || [];
                
                document.getElementById('friends-count').textContent = friends.length;
                renderizarAmigos();
                
                // Solicita status atualizados após renderizar
                setTimeout(requestAllFriendStatuses, 100);
            } catch (err) {
                console.error('Erro ao carregar amigos:', err);
                document.getElementById('friends-list').innerHTML = 
                    '<div class="alert alert-danger">Erro ao carregar amigos</div>';
            }
        }

        async function carregarPedidosRecebidos() {
            try {
                const res = await fetch('/amigos/api/requests', { credentials: 'include' });
                if (!res.ok) throw new Error('Erro ao carregar pedidos');
                
                const data = await res.json();
                requests = data.requests || [];
                
                document.getElementById('requests-count').textContent = requests.length;
                renderizarPedidosRecebidos();
            } catch (err) {
                console.error('Erro ao carregar pedidos:', err);
                document.getElementById('requests-list').innerHTML = 
                    '<div class="alert alert-danger">Erro ao carregar pedidos</div>';
            }
        }

        async function carregarPedidosEnviados() {
            try {
                const res = await fetch('/amigos/api/sent', { credentials: 'include' });
                if (!res.ok) throw new Error('Erro ao carregar pedidos enviados');
                
                const data = await res.json();
                sent = data.sent || [];
                
                document.getElementById('sent-count').textContent = sent.length;
                renderizarPedidosEnviados();
            } catch (err) {
                console.error('Erro ao carregar pedidos enviados:', err);
                document.getElementById('sent-list').innerHTML = 
                    '<div class="alert alert-danger">Erro ao carregar pedidos enviados</div>';
            }
        }

        // ==================== Funções de renderização ====================
        function renderizarAmigos() {
            const container = document.getElementById('friends-list');
            
            if (friends.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-people"></i>
                        <p>Você ainda não tem amigos adicionados</p>
                        <p class="text-muted">Use a aba "Buscar Usuários" para encontrar pessoas</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = friends.map(friend => `
                <div class="card friend-card" data-user-id="${friend.id}">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-3">
                            <div class="friend-avatar">
                                ${friend.avatar ? 
                                    `<img src="${friend.avatar}" alt="${friend.username}" style="width:100%;height:100%;border-radius:50%;">` :
                                    friend.username.charAt(1).toUpperCase()
                                }
                            </div>
                            <div>
                                <h6 class="mb-0">
                                    ${friend.username}
                                    <span class="status-indicator ${friend.status || 'offline'}"></span>
                                </h6>
                                ${friend.bio ? `<small class="text-muted">${friend.bio}</small>` : ''}
                                <br>
                                <small class="text-muted">Amigos desde ${formatarData(friend.friend_since)}</small>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <a href="/conversas?user=${friend.username}" class="btn btn-sm btn-outline-primary">
                                <i class="bi bi-chat-dots"></i> Mensagem
                            </a>
                            <button class="btn btn-sm btn-outline-danger" onclick="removerAmigo(${friend.id})">
                                <i class="bi bi-person-dash"></i> Remover
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderizarPedidosRecebidos() {
            const container = document.getElementById('requests-list');
            
            if (requests.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-inbox"></i>
                        <p>Nenhum pedido de amizade pendente</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = requests.map(request => `
                <div class="card friend-card request-card">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-3">
                            <div class="friend-avatar">
                                ${request.avatar ? 
                                    `<img src="${request.avatar}" alt="${request.username}" style="width:100%;height:100%;border-radius:50%;">` :
                                    request.username.charAt(1).toUpperCase()
                                }
                            </div>
                            <div>
                                <h6 class="mb-0">${request.username}</h6>
                                ${request.bio ? `<small class="text-muted">${request.bio}</small>` : ''}
                                <br>
                                <small class="text-muted">Recebido ${formatarData(request.created_at)}</small>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-success" onclick="aceitarPedido(${request.friendship_id})">
                                <i class="bi bi-check-lg"></i> Aceitar
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="rejeitarPedido(${request.friendship_id})">
                                <i class="bi bi-x-lg"></i> Rejeitar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderizarPedidosEnviados() {
            const container = document.getElementById('sent-list');
            
            if (sent.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="bi bi-send"></i>
                        <p>Nenhum pedido pendente</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = sent.map(request => `
                <div class="card friend-card">
                    <div class="card-body d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-3">
                            <div class="friend-avatar">
                                ${request.avatar ? 
                                    `<img src="${request.avatar}" alt="${request.username}" style="width:100%;height:100%;border-radius:50%;">` :
                                    request.username.charAt(1).toUpperCase()
                                }
                            </div>
                            <div>
                                <h6 class="mb-0">
                                    ${request.username}
                                    <span class="badge badge-pending">Pendente</span>
                                </h6>
                                ${request.bio ? `<small class="text-muted">${request.bio}</small>` : ''}
                                <br>
                                <small class="text-muted">Enviado ${formatarData(request.created_at)}</small>
                            </div>
                        </div>
                        <div class="action-buttons">
                            <button class="btn btn-sm btn-outline-danger" onclick="cancelarPedido(${request.friendship_id})">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ==================== Buscar usuários ====================
        async function buscarUsuarios() {
            const query = document.getElementById('search-input').value.trim();
            const resultsContainer = document.getElementById('search-results');
            
            if (!query) {
                resultsContainer.innerHTML = '<div class="alert alert-warning">Digite algo para buscar</div>';
                return;
            }

            resultsContainer.innerHTML = '<div class="text-center"><span class="spinner-border spinner-border-sm"></span> Buscando...</div>';

            try {
                const res = await fetch(`/api/users/buscar?q=${encodeURIComponent(query)}`, { credentials: 'include' });
                if (!res.ok) throw new Error('Erro ao buscar usuários');
                
                const data = await res.json();
                const usuarios = data.usuarios || [];

                if (usuarios.length === 0) {
                    resultsContainer.innerHTML = `
                        <div class="no-results">
                            <i class="bi bi-search" style="font-size: 2rem;"></i>
                            <p>Nenhum usuário encontrado</p>
                        </div>
                    `;
                    return;
                }

                // Para cada usuário, verificar status de amizade
                const usuariosComStatus = await Promise.all(
                    usuarios.map(async (user) => {
                        const statusRes = await fetch(`/amigos/api/check/${user.id}`, { credentials: 'include' });
                        const statusData = await statusRes.json();
                        return { ...user, friendshipStatus: statusData.status };
                    })
                );

                resultsContainer.innerHTML = usuariosComStatus.map(user => {
                    let actionButton = '';
                    
                    switch (user.friendshipStatus) {
                        case 'friends':
                            actionButton = '<span class="badge bg-success"><i class="bi bi-check-lg"></i> Amigos</span>';
                            break;
                        case 'pending_sent':
                            actionButton = '<span class="badge bg-warning text-dark"><i class="bi bi-clock"></i> Pendente</span>';
                            break;
                        case 'pending_received':
                            actionButton = '<span class="badge bg-info"><i class="bi bi-inbox"></i> Respondeu Você</span>';
                            break;
                        case 'self':
                            actionButton = '<span class="badge bg-secondary">Você</span>';
                            break;
                        default:
                            actionButton = `<button class="btn btn-sm btn-primary" onclick="enviarPedido(${user.id})">
                                <i class="bi bi-person-plus"></i> Adicionar
                            </button>`;
                    }

                    return `
                        <div class="card friend-card">
                            <div class="card-body d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="friend-avatar">
                                        ${user.avatar ? 
                                            `<img src="${user.avatar}" alt="${user.username}" style="width:100%;height:100%;border-radius:50%;">` :
                                            user.username.charAt(1).toUpperCase()
                                        }
                                    </div>
                                    <div>
                                        <h6 class="mb-0">
                                            ${user.username}
                                            <span class="status-indicator ${user.status}"></span>
                                        </h6>
                                    </div>
                                </div>
                                <div>
                                    ${actionButton}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                console.error('Erro ao buscar:', err);
                resultsContainer.innerHTML = '<div class="alert alert-danger">Erro ao buscar usuários</div>';
            }
        }

        // ==================== Ações de amizade ====================
        async function enviarPedido(userId) {
            try {
                const res = await fetch('/amigos/api/request', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({ addressee_id: userId })
                });

                const data = await res.json();
                
                if (res.ok) {
                    alert('Pedido de amizade enviado!');
                    await carregarPedidosEnviados();
                    buscarUsuarios(); // Atualiza a busca
                } else {
                    alert(data.message);
                }
            } catch (err) {
                console.error('Erro ao enviar pedido:', err);
                alert('Erro ao enviar pedido de amizade');
            }
        }

        async function aceitarPedido(friendshipId) {
            try {
                const res = await fetch(`/amigos/api/accept/${friendshipId}`, {
                    method: 'PUT',
                    credentials: 'include'
                });

                const data = await res.json();
                
                if (res.ok) {
                    alert('Pedido aceito!');
                    await carregarAmigos();
                    await carregarPedidosRecebidos();
                } else {
                    alert(data.message);
                }
            } catch (err) {
                console.error('Erro ao aceitar pedido:', err);
                alert('Erro ao aceitar pedido');
            }
        }

        async function rejeitarPedido(friendshipId) {
            if (!await confirm('Tem certeza que deseja rejeitar este pedido?')) return;

            try {
                const res = await fetch(`/amigos/api/reject/${friendshipId}`, {
                    method: 'PUT',
                    credentials: 'include'
                });

                const data = await res.json();
                
                if (res.ok) {
                    alert('Pedido rejeitado');
                    await carregarPedidosRecebidos();
                } else {
                    alert(data.message);
                }
            } catch (err) {
                console.error('Erro ao rejeitar pedido:', err);
                alert('Erro ao rejeitar pedido');
            }
        }

        async function cancelarPedido(friendshipId) {
            if (!await confirm('Tem certeza que deseja cancelar este pedido?')) return;

            try {
                const res = await fetch(`/amigos/api/cancel/${friendshipId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await res.json();
                
                if (res.ok) {
                    alert('Pedido cancelado');
                    await carregarPedidosEnviados();
                } else {
                    alert(data.message);
                }
            } catch (err) {
                console.error('Erro ao cancelar pedido:', err);
                alert('Erro ao cancelar pedido');
            }
        }

        async function removerAmigo(userId) {
            if (!await confirm('Tem certeza que deseja remover este amigo?')) return;

            try {
                const res = await fetch(`/amigos/api/${userId}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                const data = await res.json();
                
                if (res.ok) {
                    alert('Amigo removido');
                    await carregarAmigos();
                } else {
                    alert(data.message);
                }
            } catch (err) {
                console.error('Erro ao remover amigo:', err);
                alert('Erro ao remover amigo');
            }
        }

        // ==================== Utilitários ====================
        function formatarData(dateStr) {
            const date = new Date(dateStr);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));

            if (days === 0) return 'hoje';
            if (days === 1) return 'ontem';
            if (days < 7) return `há ${days} dias`;
            if (days < 30) return `há ${Math.floor(days / 7)} semanas`;
            if (days < 365) return `há ${Math.floor(days / 30)} meses`;
            return `há ${Math.floor(days / 365)} anos`;
        }
    </script>
