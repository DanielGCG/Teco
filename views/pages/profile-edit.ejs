<div class="container py-5">
  <div class="row justify-content-center">
    <!-- Formulário de edição de perfil -->
    <div class="col-md-6">
      <div class="card shadow-sm mb-4">
        <div class="card-header text-center">
          <h3>Editar Perfil</h3>
        </div>
        <div class="card-body">
          <form id="edit-profile-form">
            <!-- Username -->
            <div class="mb-3">
              <label for="username" class="form-label">Nome de usuário</label>
              <input type="text" class="form-control" id="username" name="username" maxlength="12" required>
            </div>

            <!-- Background Image URL -->
            <div class="mb-3">
              <label for="background_image" class="form-label">Imagem de fundo (URL)</label>
              <input type="url" class="form-control" id="background_image" name="background_image">
              <div class="mt-2">
                <img id="bg-preview" class="img-fluid rounded" style="max-height:150px; display:none;">
              </div>
            </div>

            <!-- Profile Image URL -->
            <div class="mb-3">
              <label for="profile_image" class="form-label">Foto de perfil (URL)</label>
              <input type="url" class="form-control" id="profile_image" name="profile_image">
              <div class="mt-2">
                <img id="pf-preview" style="max-height:100px; display:none; border-radius: 10%;">
              </div>
            </div>

            <!-- Bio -->
            <div class="mb-3">
              <label for="bio" class="form-label">Bio</label>
              <textarea class="form-control" id="bio" name="bio" rows="3" maxlength="80" oninput="atualizarContadorBio()"></textarea>
              <small id="bio-contador" class="form-text text-muted">0 / 80</small>
            </div>

            <div class="text-center">
              <button type="submit" class="btn btn-success">Salvar alterações</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Formulário de alteração de senha -->
    <div class="col-md-6">
      <div class="card shadow-sm mb-4">
        <div class="card-header text-center">
          <h3>Alterar Senha</h3>
        </div>
        <div class="card-body">
          <form id="change-password-form">
            <div class="mb-3">
              <label for="current_password" class="form-label">Senha atual</label>
              <input type="password" class="form-control" id="current_password" required>
            </div>
            <div class="mb-3">
              <label for="new_password" class="form-label">Nova senha</label>
              <input type="password" class="form-control" id="new_password" required>
            </div>
            <div class="mb-3">
              <label for="confirm_password" class="form-label">Confirme a nova senha</label>
              <input type="password" class="form-control" id="confirm_password" required>
            </div>
            <div class="text-center">
              <button type="submit" class="btn btn-warning">Alterar senha</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ================= Funções utilitárias =================

// Atualiza contador da bio
function atualizarContadorBio() {
  const bio = document.getElementById('bio');
  const contador = document.getElementById('bio-contador');
  contador.textContent = `${bio.value.length} / 80`;
}

// Normaliza username: adiciona @ e limita 13 caracteres
function normalizarUsername(username) {
  username = username.trim();
  if (!username.startsWith('@')) username = '@' + username;
  if (username.length > 13) username = username.slice(0, 13);
  return username.toLowerCase();
}

// Atualiza previews de imagens e campos do perfil
function atualizarPreviews(user) {
  const bgPreview = document.getElementById('bg-preview');
  const pfPreview = document.getElementById('pf-preview');

  if(user.background_image){
    bgPreview.src = user.background_image;
    bgPreview.style.display = 'block';
    document.getElementById('background_image').value = user.background_image;
  }

  if(user.profile_image){
    pfPreview.src = user.profile_image;
    pfPreview.style.display = 'block';
    document.getElementById('profile_image').value = user.profile_image;
  }

  document.getElementById('username').value = user.username || '';
  document.getElementById('bio').value = user.bio || '';
  atualizarContadorBio();
}

// ================= Funções principais =================

// Carrega perfil do usuário
async function carregarPerfil() {
  try {
    const res = await fetch('/api/users/me', { credentials: 'include' });
    if(res.ok){
      const user = await res.json();
      atualizarPreviews(user);
    } else {
      alert("Não foi possível carregar os dados do perfil.");
    }
  } catch(err){
    console.error(err);
    alert("Erro ao conectar com o servidor.");
  }
}

// ================= Eventos =================

// Normaliza username enquanto digita
document.getElementById('username').addEventListener('input', function() {
  this.value = normalizarUsername(this.value);
});

// Submissão formulário de perfil
document.getElementById('edit-profile-form').addEventListener('submit', async function(e){
  e.preventDefault();

  const payload = {
    username: normalizarUsername(document.getElementById('username').value),
    background_image: document.getElementById('background_image').value,
    profile_image: document.getElementById('profile_image').value,
    bio: document.getElementById('bio').value
  };

  try {
    const res = await fetch('/api/users/me', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify(payload)
    });

    const data = await res.json();
    if(res.ok){
      alert(data.message || "Perfil atualizado com sucesso!");

      // Atualiza previews
      if(payload.background_image){
        const bgPreview = document.getElementById('bg-preview');
        bgPreview.src = payload.background_image;
        bgPreview.style.display = 'block';
      }
      if(payload.profile_image){
        const pfPreview = document.getElementById('pf-preview');
        pfPreview.src = payload.profile_image;
        pfPreview.style.display = 'block';
      }

      atualizarContadorBio();
      document.getElementById('username').value = payload.username;

    } else {
      alert(data.message || "Erro ao atualizar perfil.");
    }
  } catch(err){
    console.error(err);
    alert("Erro de conexão com o servidor");
  }
});

// Submissão formulário de alteração de senha
document.getElementById('change-password-form').addEventListener('submit', async function(e){
  e.preventDefault();

  const currentPassword = document.getElementById('current_password').value.trim();
  const newPassword = document.getElementById('new_password').value.trim();
  const confirmPassword = document.getElementById('confirm_password').value.trim();

  if(newPassword !== confirmPassword){
    alert("As senhas novas não coincidem.");
    return;
  }

  try {
    const res = await fetch('/api/users/me/password', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      credentials: 'include',
      body: JSON.stringify({ currentPassword, newPassword })
    });

    const data = await res.json();

    if(res.ok){
      alert(data.message || "Senha alterada com sucesso!");
      document.getElementById('current_password').value = '';
      document.getElementById('new_password').value = '';
      document.getElementById('confirm_password').value = '';
    } else {
      alert(data.message || "Erro ao alterar senha.");
    }
  } catch(err){
    console.error(err);
    alert("Erro de conexão com o servidor.");
  }
});

// Executa ao carregar
carregarPerfil();
</script>