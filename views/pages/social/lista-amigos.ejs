<link rel="stylesheet" href="/styles/posts.css">

<style>
    .feed-sidebar {
        flex-shrink: 0;
        position: sticky;
        top: 0;
        max-height: calc(100vh - 2rem);
        overflow-y: auto;
    }
    .feed-tabs-container {
        position: sticky;
        flex-shrink: 0;
        z-index: 5;
        background-color: var(--fundo-global);
        top: 0;
    }
</style>

<div class="container-xxl mt-4">
    <div class="row justify-content-center">
        <!-- Sidebar -->
        <div class="col-4 d-flex flex-column">
            <div class="feed-sidebar rounded shadow-sm">
                <h3 class="fw-bold px-3 pt-3">
                    <span class="marca-texto-roxo">Painel social</span>
                </h3>
                <div class="p-3">
                    <div class="d-flex justify-content-between text-center mb-3 bg-white rounded shadow-sm p-2 gap-1">
                        <div class="flex-grow-1 border-end">
                            <div class="small text-muted" style="font-size: 0.75rem;">Amigos</div>
                            <div class="fw-bold h6 mb-0" id="stat-friends">0</div>
                        </div>
                        <div class="flex-grow-1 border-end">
                            <div class="small text-muted" style="font-size: 0.75rem;">Seguindo</div>
                            <div class="fw-bold h6 mb-0" id="stat-following">0</div>
                        </div>
                        <div class="flex-grow-1">
                            <div class="small text-muted" style="font-size: 0.75rem;">Seguidores</div>
                            <div class="fw-bold h6 mb-0" id="stat-followers">0</div>
                        </div>
                    </div>
                    
                    <div class="search-section mt-3">
                        <div class="input-group input-group-sm">
                            <input type="text" id="user-search-input" class="form-control" placeholder="Buscar usuários...">
                            <button class="btn btn-primary" id="btn-search"><i class="bi bi-search"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-8">
            <div id="tabs-container" class="feed-tabs-container d-flex border-bottom mb-3 rounded-top">
                <button class="btn flex-grow-1 py-1 fw-bold feed-tab active" data-type="following" onclick="changeSection('following')">Seguindo</button>
                <button class="btn flex-grow-1 py-1 fw-bold feed-tab" data-type="followers" onclick="changeSection('followers')">Seguidores</button>
            </div>

            <div id="search-header" class="d-none mb-3 d-flex justify-content-between align-items-center bg-white p-2 rounded shadow-sm">
                <h6 class="mb-0 fw-bold"><i class="bi bi-search me-2"></i>Resultados da busca</h6>
                <button class="btn btn-sm btn-outline-danger border-0" onclick="clearSearch()"><i class="bi bi-x-lg"></i></button>
            </div>

            <div id="social-list-container" class="row row-cols-1 g-3">
                <!-- Lista será renderizada aqui -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/js/commons/follow-common.js"></script>
<script>
    let currentSection = 'following';
    let isSearching = false;
    let loggedUser = null;
    let dataCache = { following: [], followers: [], friends: new Set(), search: [] };

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            // Tenta obter usuário do contexto global ou via refresh se necessário
            loggedUser = window.currentUser || (await UserContext.refresh());

            await loadAllData();
            changeSection('following');

            const searchInput = document.getElementById('user-search-input');
            const searchBtn = document.getElementById('btn-search');

            const performSearch = debounce(async () => {
                const query = searchInput.value.trim();
                if (query.length > 0) {
                    isSearching = true;
                    await searchUsers(query);
                    document.getElementById('tabs-container').classList.add('d-none');
                    document.getElementById('search-header').classList.remove('d-none');
                    renderList();
                } else {
                    clearSearch();
                }
            }, 400);

            if (searchInput) searchInput.addEventListener('input', performSearch);
            if (searchBtn) searchBtn.addEventListener('click', performSearch);
            
        } catch (err) {
            console.error('[Social] Erro na inicialização:', err);
        }
    });

    async function loadAllData() {
        const container = document.getElementById('social-list-container');
        try {
            const [friends, followData, followerData] = await Promise.all([
                FollowAPI.carregarAmigos().catch(e => (console.error(e), [])),
                fetch(`/api/follows/following/${loggedUser.publicid}`).then(r => r.json()).catch(e => ({ following: [] })),
                fetch(`/api/follows/followers/${loggedUser.publicid}`).then(r => r.json()).catch(e => ({ followers: [] }))
            ]);
            
            dataCache.friends = new Set((friends || []).map(u => u.publicid));
            dataCache.following = followData.following || [];
            dataCache.followers = followerData.followers || [];

            const statFriends = document.getElementById('stat-friends');
            const statFollowing = document.getElementById('stat-following');
            const statFollowers = document.getElementById('stat-followers');

            if (statFriends) statFriends.textContent = dataCache.friends.size;
            if (statFollowing) statFollowing.textContent = dataCache.following.length;
            if (statFollowers) statFollowers.textContent = dataCache.followers.length;
            
        } catch (err) {
            console.error('[Social] Erro ao carregar dados:', err);
            if (container) container.innerHTML = '<div class="col-12 text-center py-5 text-danger">Erro ao carregar dados sociais.</div>';
        }
    }

    function clearSearch() {
        isSearching = false;
        document.getElementById('user-search-input').value = '';
        document.getElementById('tabs-container').classList.remove('d-none');
        document.getElementById('search-header').classList.add('d-none');
        renderList();
    }

    function changeSection(type) {
        if (isSearching) return;
        currentSection = type;
        document.querySelectorAll('.feed-tab').forEach(tab => {
            tab.classList.toggle('active', tab.dataset.type === type);
        });
        renderList();
    }

    function renderList() {
        const container = document.getElementById('social-list-container');
        const list = isSearching ? dataCache.search : dataCache[currentSection];
        container.innerHTML = '';

        if (!list || list.length === 0) {
            container.innerHTML = `<div class="col-12 text-center py-5 text-muted"><i class="bi bi-info-circle fs-2 d-block mb-2"></i>Nenhum usuário encontrado.</div>`;
            return;
        }

        list.forEach(user => {
            if (user.publicid === loggedUser.publicid) return;
            const col = document.createElement('div');
            col.className = 'col';
            
            const isFriend = dataCache.friends.has(user.publicid);
            const isFollowing = dataCache.following.some(f => f.publicid === user.publicid);
            
            // Injetar isFriend para o UIUtils usar na badge (em 'search' type)
            user.isFriend = isFriend;

            const actions = [
                UIUtils.createActionLink({ icon: 'bi bi-chat-fill', href: `/dms?user=${user.username}`, variant: 'primary', className: 'btn-sm' })
            ];

            const btnFollowLabel = isFollowing ? 'Deixar de seguir' : 'Seguir';
            const btnFollowVariant = isFollowing ? 'outline-secondary' : 'success';
            
            actions.push(UIUtils.createActionButton({
                text: btnFollowLabel,
                icon: isFollowing ? 'bi bi-person-x' : 'bi bi-person-plus',
                variant: btnFollowVariant,
                size: 'sm',
                onClick: async (e) => {
                    const btn = e.currentTarget;
                    btn.disabled = true;
                    const action = isFollowing ? FollowAPI.deixarDeSeguir : FollowAPI.seguir;
                    const res = await action(user.publicid, { showAlert: false, confirmMessage: isFollowing ? 'Deseja deixar de seguir?' : null });
                    if (res.success) { 
                        await loadAllData(); 
                        if (isSearching) await searchUsers(document.getElementById('user-search-input').value);
                        renderList(); 
                    } else btn.disabled = false;
                }
            }));

            // Usar type 'search' porque ele já suporta a badge de Amigo no ui-common.js
            const card = UIUtils.createUserCard(user, { type: 'search', avatarSize: 48, actions });
            card.dataset.userId = user.publicid;
            col.appendChild(card);
            container.appendChild(col);
        });
        
        UIUtils.requestPageStatuses();
    }

    async function searchUsers(query) {
        if (!query) return;
        try {
            const res = await fetch(`/api/dms/search?q=${encodeURIComponent(query)}`);
            const data = await res.json();
            dataCache.search = data.users || [];
        } catch (err) {
            console.error('Erro na busca:', err);
        }
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
</script>

