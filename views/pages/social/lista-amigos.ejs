<style>
    .friends-container { height: 100%; }
    .tab-content { margin-top: 1.5rem; }
    .friend-card { transition: all 0.2s; border: 1px solid #dee2e6; margin-bottom: 0.75rem; }
    .friend-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .search-box { margin-bottom: 1.5rem; }
    .no-results { text-align: center; padding: 2rem; color: #6c757d; }
    .action-buttons { display: flex; gap: 0.5rem; }
    .empty-state { text-align: center; padding: 3rem 1rem; color: #6c757d; }
    .empty-state i { font-size: 3rem; margin-bottom: 1rem; }
</style>

<div class="container-fluid friends-container" style="padding: 0px;">
    <div class="card h-100 d-flex flex-column" style="background-color: var(--verde);">
        <!-- Tabs de navegação -->
        <ul class="card-header nav nav-tabs" id="friendsTabs" role="tablist" style="padding: 0px;">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="friends-tab" data-bs-toggle="tab" data-bs-target="#friends" type="button" role="tab">
                    <i class="bi bi-people"></i> Amigos <span id="friends-count" class="badge bg-primary">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="following-tab" data-bs-toggle="tab" data-bs-target="#following" type="button" role="tab">
                    <i class="bi bi-person-check"></i> Seguindo <span id="following-count" class="badge bg-secondary">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="followers-tab" data-bs-toggle="tab" data-bs-target="#followers" type="button" role="tab">
                    <i class="bi bi-person-heart"></i> Seguidores <span id="followers-count" class="badge bg-info">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="search-tab" data-bs-toggle="tab" data-bs-target="#search" type="button" role="tab">
                    <i class="bi bi-search"></i> Buscar
                </button>
            </li>
        </ul>

        <!-- Conteúdo das tabs -->
        <div class="tab-content px-2" id="friendsTabContent">
            <!-- Amigos (Mútuos) -->
            <div class="tab-pane fade show active" id="friends" role="tabpanel">
                <div id="friends-list">
                    <div class="text-center"><span class="spinner-border spinner-border-sm"></span> Carregando...</div>
                </div>
            </div>

            <!-- Seguindo -->
            <div class="tab-pane fade" id="following" role="tabpanel">
                <div id="following-list">
                    <div class="text-center"><span class="spinner-border spinner-border-sm"></span> Carregando...</div>
                </div>
            </div>

            <!-- Seguidores -->
            <div class="tab-pane fade" id="followers" role="tabpanel">
                <div id="followers-list">
                    <div class="text-center"><span class="spinner-border spinner-border-sm"></span> Carregando...</div>
                </div>
            </div>

            <!-- Buscar -->
            <div class="tab-pane fade" id="search" role="tabpanel">
                <div class="search-box">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" id="user-search-input" class="form-control" placeholder="Buscar por username...">
                    </div>
                </div>
                <div id="search-results"></div>
            </div>
        </div>
    </div>
</div>

<script src="/js/commons/ui-common.js"></script>
<script src="/js/commons/follow-common.js"></script>
<script>
    let friends = [];
    let following = [];
    let followers = [];
    let currentUserId = null;

    document.addEventListener('DOMContentLoaded', async () => {
        const meRes = await fetch('/api/users/me');
        if (meRes.ok) {
            const me = await meRes.json();
            currentUserId = me.id;
        }

        carregarTudo();

        document.getElementById('user-search-input').addEventListener('input', debounce(buscarUsuarios, 500));
    });

    async function carregarTudo() {
        await Promise.all([
            carregarAmigos(),
            carregarSeguindo(),
            carregarSeguidores()
        ]);
    }

    async function carregarAmigos() {
        friends = await FollowAPI.carregarAmigos();
        document.getElementById('friends-count').textContent = friends.length;
        renderizarLista('friends-list', friends, 'friend');
    }

    async function carregarSeguindo() {
        if (!currentUserId) return;
        const res = await fetch(`/api/follows/following/${currentUserId}`);
        const data = await res.json();
        following = data.following || [];
        document.getElementById('following-count').textContent = following.length;
        renderizarLista('following-list', following, 'following');
    }

    async function carregarSeguidores() {
        if (!currentUserId) return;
        const res = await fetch(`/api/follows/followers/${currentUserId}`);
        const data = await res.json();
        followers = data.followers || [];
        document.getElementById('followers-count').textContent = followers.length;
        renderizarLista('followers-list', followers, 'follower');
    }

    function renderizarLista(containerId, list, type) {
        const container = document.getElementById(containerId);
        if (list.length === 0) {
            container.innerHTML = `<div class="empty-state"><i class="bi bi-people"></i><p>Ninguém por aqui ainda.</p></div>`;
            return;
        }

        container.innerHTML = '';
        list.forEach(user => {
            const actions = [
                UIUtils.createActionLink({
                    text: 'Mensagem',
                    icon: 'bi bi-chat-dots',
                    href: `/dms?user=${user.username}`,
                    variant: 'primary'
                })
            ];

            if (type === 'following' || type === 'friend') {
                actions.push(UIUtils.createActionButton({
                    text: 'Deixar de Seguir',
                    icon: 'bi bi-person-dash',
                    variant: 'outline-danger',
                    onClick: async (e) => {
                        const btn = e.currentTarget;
                        btn.disabled = true;
                        const res = await FollowAPI.deixarDeSeguir(user.id, { showAlert: false });
                        if (res.success) await carregarTudo();
                        else btn.disabled = false;
                    }
                }));
            } else if (type === 'follower' && !following.some(f => f.id === user.id)) {
                actions.push(UIUtils.createActionButton({
                    text: 'Seguir de Volta',
                    icon: 'bi bi-person-plus-fill',
                    variant: 'success',
                    onClick: async (e) => {
                        const btn = e.currentTarget;
                        btn.disabled = true;
                        const res = await FollowAPI.seguir(user.id, { showAlert: false });
                        if (res.success) await carregarTudo();
                        else btn.disabled = false;
                    }
                }));
            }

            container.appendChild(UIUtils.createUserCard(user, { type: 'friend', avatarSize: 40, actions }));
        });
    }

    async function buscarUsuarios() {
        const query = document.getElementById('user-search-input').value.trim();
        if (query.length < 2) {
            document.getElementById('search-results').innerHTML = '';
            return;
        }

        try {
            const res = await fetch(`/api/users/search?q=${encodeURIComponent(query)}`);
            const users = await res.json();
            const container = document.getElementById('search-results');
            container.innerHTML = '';

            if (users.length === 0) {
                container.innerHTML = '<div class="no-results">Nenhum usuário encontrado</div>';
                return;
            }

            users.forEach(user => {
                if (user.id === currentUserId) return;

                const isFollowing = following.some(f => f.id === user.id);
                const btn = UIUtils.createActionButton({
                    text: isFollowing ? 'Seguindo' : 'Seguir',
                    icon: isFollowing ? 'bi bi-check-lg' : 'bi bi-person-plus',
                    variant: isFollowing ? 'secondary' : 'primary',
                    onClick: async (e) => {
                        const b = e.currentTarget;
                        b.disabled = true;
                        const action = isFollowing ? FollowAPI.deixarDeSeguir : FollowAPI.seguir;
                        const res = await action(user.id, { showAlert: false });
                        if (res.success) {
                            await carregarTudo();
                            await buscarUsuarios();
                        } else {
                            b.disabled = false;
                        }
                    }
                });

                container.appendChild(UIUtils.createUserCard(user, { type: 'friend', avatarSize: 40, actions: [btn] }));
            });
        } catch (err) {
            console.error('Erro na busca:', err);
        }
    }

    function debounce(func, wait) {
        let timeout;
        return function(...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
        };
    }
</script>
