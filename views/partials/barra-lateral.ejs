<style>
/* Card do usuário */
.user-card {
    padding: 1.5rem;
    border-radius: 0.5rem;
    text-align: center;
    color: white;
    background: linear-gradient(135deg, #6c5ce7, var(--roxo));
    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
}

/* Avatar do usuário */
.user-avatar {
    width: 130px;
    height: 130px;
    border-radius: 10%;
    object-fit: cover;
    border: 2px solid rgba(255, 255, 255, 0.15);
}

/* Nome e status */
.user-name {
    font-size: 0.9rem;
    margin-bottom: 0;
}

/* Navegação */
.sidebar-nav {
    width: 100%;
}

.nav-item-custom {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 0.5rem 1rem;
    color: #3E3F29;
    text-decoration: none !important;
    transition: all 0.2s;
    border-radius: 0.5rem;
    margin-bottom: 0.1rem;
    font-size: 0.85rem;
    font-weight: 500;
}

.nav-item-custom:hover {
    background: rgba(255, 255, 255, 0.3);
    color: #000;
}

.nav-item-custom i {
    font-size: 1.1rem;
    color: var(--roxo-escuro);
    width: 20px;
    text-align: center;
}

.nav-group-label {
    display: flex;
    align-items: center;
    font-size: 0.65rem;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: rgba(0, 0, 0, 0.4);
    padding: 0.8rem 1rem 0.3rem;
    font-weight: 700;
}

.nav-group-label::before,
.nav-group-label::after {
    content: "";
    flex: 1;
    height: 1px;
    background: rgba(0, 0, 0, 0.1);
}

/* Botões da barra lateral */
.sidebar-buttons button {
    width: 100%;
}

/* Número da versão no final da barra lateral */
.version-text {
    position: absolute;
    bottom: 20px; /* distância do chão */
    left: 0;
    width: 100%;
}
</style>

<div class="sidebar d-flex flex-column align-items-center">
    <!-- Card do usuário -->
    <% 
        // A opção certeira: usamos loggedUser que é garantido pelo authMiddleware
        const u = locals.loggedUser;
        const hasUser = !!u;
        const profilePic = hasUser ? u.profileimage : '';
        const profileLink = hasUser ? `/${u.username}` : '#';
        const username = hasUser ? u.username : '';
        const bgStyle = 'background: linear-gradient(135deg, #6c5ce7, var(--roxo));';
    %>
    <a id="sidebar-profile-link" href="<%= profileLink %>" class="text-decoration-none w-100">
        <div class="user-card text-center mb-3 w-100" style="<%= bgStyle %>">
            <img src="<%= profilePic %>" alt="Foto de Perfil" class="user-avatar mb-2">
            <h5 class="user-name mb-0"><%= username %></h5>
        </div>
    </a>

    <!-- Navegação Principal -->
    <div class="sidebar-nav mb-2">
        <a href="/chat" class="nav-item-custom"><i class="bi bi-chat-dots"></i> Chat</a>
        <a href="/dms" class="nav-item-custom"><i class="bi bi-chat-heart"></i> DM</a>
        <a href="/cartinhas" class="nav-item-custom"><i class="bi bi-envelope"></i> Correio</a>
        <a href="/amigos" class="nav-item-custom"><i class="bi bi-people"></i> Amigos</a>
        <a href="/galerias" class="nav-item-custom"><i class="bi bi-images"></i> Galerias</a>
        
        <div class="nav-group-label">Ferramentas</div>
        <a href="/watchlist" class="nav-item-custom"><i class="bi bi-film"></i> Watchlist</a>
        <a href="/manutencao" class="nav-item-custom"><i class="bi bi-hand-index"></i> Cutucar</a>
    </div>

    <hr class="w-100 mt-0">
    <!-- Links ou botões da barra lateral -->
    <div class="sidebar-buttons d-flex flex-column align-items-center w-100">
        <% if (u && u.roleId <= 5) { %>
            <button class="btn btn-warning mb-2 w-100" id="admin-panel-btn" onclick="window.location.href='/admin'">Painel admin</button>
        <% } %>
        <button class="btn btn-outline-danger mb-2 w-100" id="logoutBtn">Sair</button>
    </div>
    <!-- Número da versão -->
    <div class="version-text text-center w-100">
        <h5><a href="/credits">Teco</a></h5>
        <small><a href="/changelog"><%= locals.version %></a></small>
    </div>
</div>

<script>
function renderizarPerfil(user) {
    if (!user) return;

    const userCard = document.querySelector(".user-card");
    const userAvatar = document.querySelector(".user-avatar");
    const profileLink = document.getElementById("sidebar-profile-link");
    const userName = document.querySelector(".user-name");
    const sidebarButtons = document.querySelector(".sidebar-buttons");

    if (profileLink) profileLink.href = `/${user.username}`;
    if (userName) userName.textContent = user.username;
    if (userAvatar && user.profileimage) userAvatar.src = user.profileimage;

    if (userCard) {
        if (user.backgroundimage) {
            userCard.style.backgroundImage = `url('${user.backgroundimage}'), linear-gradient(135deg, #6c5ce7, var(--roxo))`;
            userCard.style.backgroundSize = 'cover';
            userCard.style.backgroundPosition = 'center';
        } else {
            userCard.style.background = 'linear-gradient(135deg, #6c5ce7, var(--roxo))';
        }
    }

    // Botão Admin (se necessário)
    if (user.roleId <= 5 && !document.getElementById('admin-panel-btn')) {
        const adminBtn = document.createElement("button");
        adminBtn.id = 'admin-panel-btn';
        adminBtn.className = "btn btn-warning mb-2 w-100";
        adminBtn.textContent = "Painel admin";
        adminBtn.onclick = () => window.location.href = "/admin";
        sidebarButtons.insertBefore(adminBtn, sidebarButtons.firstChild);
    }
}

async function sincronizarContexto() {
    // 1. Tenta pegar do cookie (instantâneo)
    const user = UserContext.get();
    if (user) {
        renderizarPerfil(user);
    } else {
        // 2. Se não houver cookie, tenta refresh via API
        const freshUser = await UserContext.refresh();
        if (freshUser) {
            renderizarPerfil(freshUser);
        }
    }
}

// Logout
document.getElementById("logoutBtn").addEventListener("click", async () => {
    await UserContext.logout();
});

// Sincroniza ao carregar
document.addEventListener("DOMContentLoaded", sincronizarContexto);
</script>
