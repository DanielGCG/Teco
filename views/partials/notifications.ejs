<!-- Notifications Bell Icon -->
<div class="position-relative ms-3">
    <button class="btn btn-link position-relative p-0" type="button" id="notificationsDropdownBtn" 
            data-bs-toggle="dropdown" aria-expanded="false" style="text-decoration: none; color: #333;">
        <i class="bi bi-bell-fill fs-4"></i>
        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" 
              id="notificationsBadge" style="display: none; font-size: 0.65rem;">
            0
        </span>
    </button>
    
    <div class="dropdown-menu dropdown-menu-end shadow" style="width: 380px; max-height: 500px;">
        <div class="d-flex justify-content-between align-items-center px-3 py-2 border-bottom bg-light">
            <h6 class="mb-0 fw-bold">Notificações</h6>
            <button class="btn btn-sm btn-link text-decoration-none p-0" id="markAllReadBtn" style="font-size: 0.85rem;">
                Marcar todas como lidas
            </button>
        </div>
        
        <div id="notificationsList" class="overflow-auto" style="max-height: 400px;">
            <div class="text-center py-4 text-muted">
                <i class="bi bi-bell-slash fs-1"></i>
                <p class="mb-0 mt-2">Nenhuma notificação</p>
            </div>
        </div>
    </div>
</div>

<style>
    #notificationsList::-webkit-scrollbar {
        width: 6px;
    }
    
    #notificationsList::-webkit-scrollbar-track {
        background: #f1f1f1;
    }
    
    #notificationsList::-webkit-scrollbar-thumb {
        background: #888;
        border-radius: 3px;
    }
    
    #notificationsList::-webkit-scrollbar-thumb:hover {
        background: #555;
    }
    
    .notification-item {
        border-bottom: 1px solid #e9ecef;
        transition: background-color 0.2s;
    }
    
    .notification-item:hover {
        background-color: #f8f9fa;
    }
    
    .notification-item.unread {
        background-color: #e7f3ff;
    }
    
    .notification-item.unread:hover {
        background-color: #d0e8ff;
    }
    /* Animação do sino quando chega nova notificação */
    .bell-pulse {
        animation: bell-pulse 1s ease-in-out 0s 4;
    }

    @keyframes bell-pulse {
        0% { transform: translateY(0) scale(1); }
        25% { transform: translateY(-4px) scale(1.05); }
        50% { transform: translateY(0) scale(1); }
        75% { transform: translateY(-2px) scale(1.02); }
        100% { transform: translateY(0) scale(1); }
    }
</style>

<script src="/js/global/socket-connector.js"></script>
<script>
    // Inicializa conexão Socket.IO global
    const notificationsSocket = SocketConnector.init();
    window.appSocket = notificationsSocket;
    
    const notificationsBadge = document.getElementById('notificationsBadge');
    const notificationsList = document.getElementById('notificationsList');
    const markAllReadBtn = document.getElementById('markAllReadBtn');

    // Função de reconexão - executada ao conectar/reconectar
    function onSocketConnect() {
        notificationsSocket.emit('joinUserRoom');
        notificationsSocket.emit('getNotificationsCount');
    }

    // Registra handler de reconexão
    SocketConnector.onReconnect(onSocketConnect);

        // ==================== Rastreamento de Atividade do Usuário ====================
        let activityTimeout;
        
        // Função para enviar atividade ao servidor
        function sendUserActivity() {
            notificationsSocket.emit('userActivity');
        }
        
        // Detecta atividade do usuário (movimento do mouse, teclado, cliques)
        function handleUserActivity() {
            // Limpa timeout anterior
            if (activityTimeout) {
                clearTimeout(activityTimeout);
            }
            
            // Envia imediatamente
            sendUserActivity();
            
            // Agenda próximo envio após 2 minutos de inatividade
            activityTimeout = setTimeout(() => {
                // Não faz nada, apenas para de enviar
            }, 120000);
        }
        
        // Event listeners para detectar atividade
        document.addEventListener('mousemove', handleUserActivity);
        document.addEventListener('keydown', handleUserActivity);
        document.addEventListener('click', handleUserActivity);
        document.addEventListener('scroll', handleUserActivity);
        
        // Envia atividade inicial
        handleUserActivity();

        // Update badge count
        function updateNotificationsBadge(count) {
            if (count > 0) {
                notificationsBadge.textContent = count > 99 ? '99+' : count;
                notificationsBadge.style.display = 'inline-block';
            } else {
                notificationsBadge.style.display = 'none';
            }
        }

        // Listen for count updates
        notificationsSocket.on('notificationsCount', (data) => {
            updateNotificationsBadge(data.count);
        });

        // Load notifications when dropdown opens and stop bell animation
        document.getElementById('notificationsDropdownBtn').addEventListener('click', async (e) => {
            // remove pulse animation when user opens the dropdown
            const btn = document.getElementById('notificationsDropdownBtn');
            btn.classList.remove('bell-pulse');

            if (!e.target.closest('.dropdown-menu')) {
                await loadNotifications();
            }
        });

        // Load notifications from API
        async function loadNotifications() {
            try {
                const response = await fetch('/api/notifications?limit=20');
                const data = await response.json();

                if (data.success && data.notifications.length > 0) {
                    // Cache para ícones e cores
                    const iconMap = {
                        'FRIEND_REQUEST': { icon: 'bi-person-plus', color: 'text-info' },
                        'FRIEND_ACCEPTED': { icon: 'bi-person-check', color: 'text-success' },
                        'NEW_DM': { icon: 'bi-chat-dots', color: 'text-primary' },
                        'NEW_CARTINHA': { icon: 'bi-envelope-heart', color: 'text-danger' },
                        'MENTION': { icon: 'bi-at', color: 'text-warning' },
                        'SYSTEM': { icon: 'bi-info-circle', color: 'text-secondary' }
                    };
                    
                    // Limpa a lista
                    notificationsList.innerHTML = '';
                    
                    // Fragment para melhor performance
                    const fragment = document.createDocumentFragment();
                    
                    data.notifications.forEach(notification => {
                        const isUnread = !notification.read_at;
                        const timeAgo = getTimeAgo(notification.created_at);
                        const { icon = 'bi-bell', color = 'text-primary' } = iconMap[notification.type] || {};

                        // Container principal
                        const itemDiv = document.createElement('div');
                        itemDiv.className = `notification-item ${isUnread ? 'unread' : ''} px-3 py-2`;
                        itemDiv.dataset.id = notification.id;
                        itemDiv.dataset.link = notification.link || '#';
                        itemDiv.style.cursor = 'pointer';
                        
                        // Flex container
                        const flexDiv = document.createElement('div');
                        flexDiv.className = 'd-flex align-items-start';
                        
                        // Ícone
                        const iconI = document.createElement('i');
                        iconI.className = `bi ${icon} ${color} fs-4 me-3 mt-1`;
                        flexDiv.appendChild(iconI);
                        
                        // Conteúdo
                        const contentDiv = document.createElement('div');
                        contentDiv.className = 'flex-grow-1 min-width-0';
                        
                        // Header (Título + Badge)
                        const headerDiv = document.createElement('div');
                        headerDiv.className = 'd-flex justify-content-between align-items-start';
                        
                        const titleH6 = document.createElement('h6');
                        titleH6.className = 'mb-1 fw-bold text-truncate';
                        titleH6.style.fontSize = '0.9rem';
                        titleH6.textContent = notification.title; // Safe textContent
                        headerDiv.appendChild(titleH6);
                        
                        if (isUnread) {
                            const badgeSpan = document.createElement('span');
                            badgeSpan.className = 'badge bg-primary rounded-circle';
                            badgeSpan.style.width = '8px';
                            badgeSpan.style.height = '8px';
                            badgeSpan.style.padding = '0';
                            headerDiv.appendChild(badgeSpan);
                        }
                        contentDiv.appendChild(headerDiv);
                        
                        // Body
                        const bodyP = document.createElement('p');
                        bodyP.className = 'mb-1 text-muted small';
                        bodyP.textContent = notification.body; // Safe textContent
                        contentDiv.appendChild(bodyP);
                        
                        // Footer (Time)
                        const timeSmall = document.createElement('small');
                        timeSmall.className = 'text-muted';
                        timeSmall.style.fontSize = '0.75rem';
                        
                        const clockIcon = document.createElement('i');
                        clockIcon.className = 'bi bi-clock';
                        timeSmall.appendChild(clockIcon);
                        timeSmall.appendChild(document.createTextNode(' ' + timeAgo));
                        
                        contentDiv.appendChild(timeSmall);
                        
                        flexDiv.appendChild(contentDiv);
                        itemDiv.appendChild(flexDiv);
                        
                        // Event Listener
                        itemDiv.addEventListener('click', () => handleNotificationClick(itemDiv));
                        
                        fragment.appendChild(itemDiv);
                    });

                    notificationsList.appendChild(fragment);
                } else {
                    notificationsList.innerHTML = `
                        <div class="text-center py-4 text-muted">
                            <i class="bi bi-bell-slash fs-1"></i>
                            <p class="mb-0 mt-2">Nenhuma notificação</p>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Erro ao carregar notificações:', err);
                notificationsList.innerHTML = `
                    <div class="text-center py-4 text-danger">
                        <i class="bi bi-exclamation-triangle fs-1"></i>
                        <p class="mb-0 mt-2">Erro ao carregar notificações</p>
                    </div>
                `;
            }
        }

        // Handle notification click
        async function handleNotificationClick(item) {
            const id = item.dataset.id;
            const link = item.dataset.link;
            const isUnread = item.classList.contains('unread');

            // Mark as read if unread
            if (isUnread) {
                try {
                    await fetch(`/api/notifications/${id}/read`, { method: 'PUT' });
                    item.classList.remove('unread');
                    notificationsSocket.emit('getNotificationsCount');
                } catch (err) {
                    console.error('Erro ao marcar notificação como lida:', err);
                }
            }

            // Navigate to link
            if (link && link !== '#') {
                window.location.href = link;
            }
        }

        // Mark all as read
        markAllReadBtn.addEventListener('click', async () => {
            try {
                await fetch('/api/notifications/read-all', { method: 'PUT' });
                notificationsList.querySelectorAll('.notification-item.unread').forEach(item => {
                    item.classList.remove('unread');
                });
                notificationsSocket.emit('getNotificationsCount');
            } catch (err) {
                console.error('Erro ao marcar todas como lidas:', err);
            }
        });

        // Listen for new notifications
        notificationsSocket.on('newNotification', async (data) => {
            // Update count
            notificationsSocket.emit('getNotificationsCount');

            // Reload list if dropdown is open
            const dropdown = document.querySelector('#notificationsDropdownBtn + .dropdown-menu');
            if (dropdown && dropdown.classList.contains('show')) {
                await loadNotifications();
            } else {
                // Indicate new notification on the bell (visual) and try to play sound
                animateBell();
                tryPlaySound(data?.type);
            }
        });

        // Animate the bell icon with a pulse; stops automatically after animation.
        function animateBell() {
            const btn = document.getElementById('notificationsDropdownBtn');
            if (!btn) return;
            // add class to trigger CSS animation
            btn.classList.remove('bell-pulse');
            // trigger reflow to restart animation
            void btn.offsetWidth;
            btn.classList.add('bell-pulse');

            // remove after animation cycles (4 iterations * 1s == 4s)
            setTimeout(() => {
                btn.classList.remove('bell-pulse');
            }, 4200);
        }

        // Try to play a short notification sound using bundled public asset; ignores errors (autoplay blocked)
        function tryPlaySound(type) {
            try {
                const soundFile = type === 'friend' ? '/sounds/friend.mp3' : '/sounds/notify.mp3';
                const audio = new Audio(soundFile);
                audio.preload = 'auto';
                audio.volume = 0.3;
                audio.play().catch(() => {});
            } catch (e) {
                // ignore
            }
        }

        // Time ago helper
        function getTimeAgo(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const seconds = Math.floor((now - date) / 1000);

            if (seconds < 60) return 'Agora';
            if (seconds < 3600) return `${Math.floor(seconds / 60)}m`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)}h`;
            if (seconds < 604800) return `${Math.floor(seconds / 86400)}d`;
            return date.toLocaleDateString('pt-BR');
        }

        // ==================== PEDIDOS DE AMIZADE ====================
        notificationsSocket.emit('getFriendRequestsCount');

        notificationsSocket.on('friendRequestsCount', ({ count }) => {
            const badge = document.getElementById('friend-requests-badge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        });

        notificationsSocket.on('newFriendRequest', () => {
            notificationsSocket.emit('getFriendRequestsCount');
            // Dispara evento customizado para páginas que precisam reagir
            document.dispatchEvent(new CustomEvent('friendRequest:new'));
        });

        notificationsSocket.on('friendRequestsUpdated', () => {
            notificationsSocket.emit('getFriendRequestsCount');
            // Dispara evento customizado para páginas que precisam reagir
            document.dispatchEvent(new CustomEvent('friendRequest:updated'));
        });

        notificationsSocket.on('friendRequestAccepted', () => {
            notificationsSocket.emit('getFriendRequestsCount');
            // Dispara evento customizado para páginas que precisam reagir
            document.dispatchEvent(new CustomEvent('friendRequest:accepted'));
        });
        
        // ==================== STATUS DE USUÁRIOS (para página de amigos) ====================
        notificationsSocket.on('userStatusChanged', ({ userId, status }) => {
            // Dispara evento customizado com os dados
            document.dispatchEvent(new CustomEvent('user:statusChanged', { 
                detail: { userId, status } 
            }));
        });
        
        notificationsSocket.on('userStatusBatch', (statusMap) => {
            // Dispara evento customizado com os dados
            document.dispatchEvent(new CustomEvent('user:statusBatch', { 
                detail: { statusMap } 
            }));
        });

        // ==================== MENSAGENS NÃO LIDAS ====================
        notificationsSocket.emit('getUnreadDMsCount');

        notificationsSocket.on('unreadDMsCount', ({ count }) => {
            const badge = document.getElementById('unread-dms-badge');
            if (badge) {
                if (count > 0) {
                    badge.textContent = count;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        });

        notificationsSocket.on('newMessage', () => {
            notificationsSocket.emit('getUnreadDMsCount');
        });

        notificationsSocket.on('messageRead', () => {
            notificationsSocket.emit('getUnreadDMsCount');
        });
    </script>
