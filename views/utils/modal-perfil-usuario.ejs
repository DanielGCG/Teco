<!-- Modal de Perfil do Usuário -->
<div class="modal fade" id="userProfileModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center pb-4">
                <div class="row align-items-start mb-3">
                    <div class="col d-flex flex-column align-items-center">
                        <!-- Avatar com Status -->
                        <div id="profile-modal-avatar-container" class="position-relative d-inline-block mb-3">
                            <img id="profile-modal-avatar" src="" alt="Avatar" class="rounded" style="width: 120px; height: 120px; object-fit: cover; border: 4px solid #f8f9fa;">
                            <span id="profile-modal-status-indicator" class="position-absolute bottom-0 end-0 border border-white rounded-circle" style="width: 30px; height: 30px; background: #6c757d;"></span>
                        </div>
                        <!-- Username -->
                        <a id="profile-modal-username-link" href="" class="text-decoration-none text-dark">
                            <h4 id="profile-modal-username" class="fw-bold mb-1"></h4>
                        </a>
                        <!-- Badge de Amigos (abaixo do username) -->
                        <div id="profile-modal-friend-badge" class="mb-3"></div>
                    </div>
                    <div class="col d-flex align-items-center justify-content-center">
                        <!-- Bio -->
                        <div id="profile-modal-bio" class="text-muted" style="max-width: 300px;">
                            <small><em>Sem biografia</em></small>
                        </div>
                    </div>
                </div>
                <div class="d-flex justify-content-center gap-3">
                    <!-- Ações de Amizade -->
                    <div id="profile-modal-friendship-actions"></div>

                    <!-- Botão de Conversa -->
                    <div id="profile-modal-dm-button"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Importar módulos compartilhados -->
<script src="/js/commons/follow-common.js"></script>

<style>
#userProfileModal .modal-content {
    border-radius: 1rem;
}

#userProfileModal .modal-body {
    padding: 2rem 1.5rem;
}

#profile-modal-bio {
    line-height: 1.5;
    white-space: pre-wrap;
}

</style>

<script>
    // Objeto global para gerenciar o modal de perfil
    window.UserProfileModal = (function() {
        const modal = new bootstrap.Modal(document.getElementById('userProfileModal'));
        let currentUserData = null;
        let onDmClickCallback = null;

        // Mapa consolidado de status
        const statusMap = {
            'online': { color: '#28a745', badgeClass: 'bg-success' },
            'ausente': { color: '#ffc107', badgeClass: 'bg-warning text-dark' },
            'offline': { color: '#6c757d', badgeClass: 'bg-secondary' }
        };

        // Mostra o modal com os dados do usuário
        function show(userData, options = {}) {
            currentUserData = userData;
            onDmClickCallback = options.onDmClick ?? null;

            // Vincular ID para atualizações automáticas via UIUtils
            const avatarContainer = document.getElementById('profile-modal-avatar-container');
            if (avatarContainer) avatarContainer.setAttribute('data-user-id', userData.publicid);

            // Avatar - com fallback automático
            const avatarImg = document.getElementById('profile-modal-avatar');
            avatarImg.src = userData.profileimage;
            avatarImg.onerror = () => { avatarImg.src = '/images/placeholder.webp'; };

            // Username
            document.getElementById('profile-modal-username').textContent = userData.username;
            document.getElementById('profile-modal-username-link').href = `/${userData.username}`;

            // Status
            updateStatus(userData.status || 'offline');

            // Bio
            const bioContainer = document.getElementById('profile-modal-bio');
            const bioSmall = document.createElement('small');
            if (userData.bio && userData.bio.trim()) {
                bioSmall.textContent = userData.bio;
            } else {
                const em = document.createElement('em');
                em.textContent = 'Sem biografia';
                bioSmall.appendChild(em);
            }
            bioContainer.innerHTML = '';
            bioContainer.appendChild(bioSmall);

            // Ações de seguimento
            renderFollowActions(userData);

            // Botão de conversa
            renderDmButton(userData);

            modal.show();
        }

        // Atualiza o status do usuário
        function updateStatus(status) {
            const indicator = document.getElementById('profile-modal-status-indicator');
            const statusInfo = statusMap[status] || statusMap.offline;
            
            if (indicator) {
                indicator.style.background = statusInfo.color;
            }

            if (currentUserData) {
                currentUserData.status = status;
            }
        }

        // Renderiza as ações de seguimento
        async function renderFollowActions(userData) {
            const actions = document.getElementById('profile-modal-friendship-actions');
            const badges = document.getElementById('profile-modal-friend-badge');
            
            badges.innerHTML = '';
            actions.innerHTML = '<div class="text-center"><span class="spinner-border spinner-border-sm"></span></div>';
            
            const status = await FollowAPI.verificarStatus(userData.publicid);
            actions.innerHTML = '';
            if (!status) return;

            const config = status.isMutual 
                ? { badge: 'Amigos', bClass: 'bg-primary', bIcon: 'bi-people-fill', text: 'Deixar de Seguir', variant: 'outline-danger', action: 'unfollow' }
                : status.following 
                    ? { badge: 'Seguindo', bClass: 'bg-secondary', bIcon: 'bi-check-lg', text: 'Deixar de Seguir', variant: 'outline-danger', action: 'unfollow' }
                    : status.followedBy 
                        ? { text: 'Seguir de Volta', variant: 'success', action: 'follow' }
                        : { text: 'Seguir', variant: 'primary', action: 'follow' };

            if (config.badge) {
                badges.innerHTML = `<span class="badge ${config.bClass}"><i class="bi ${config.bIcon}"></i> ${config.badge}</span>`;
            }

            actions.appendChild(UIUtils.createActionButton({
                text: config.text,
                variant: config.variant,
                className: 'friendship-action-btn',
                onClick: () => UserProfileModal[config.action]()
            }));
        }

        // Renderiza o botão de conversa
        function renderDmButton(userData) {
            const container = document.getElementById('profile-modal-dm-button');
            container.innerHTML = '';
            
            if (onDmClickCallback) {
                const btn = UIUtils.createActionButton({
                    text: 'Enviar Mensagem',
                    icon: 'bi bi-chat-dots',
                    variant: 'outline-primary',
                    className: 'friendship-action-btn',
                    onClick: () => UserProfileModal.openDm()
                });
                container.appendChild(btn);
            } else if (userData.username) {
                const link = UIUtils.createActionLink({
                    text: 'Enviar Mensagem',
                    icon: 'bi bi-chat-dots',
                    variant: 'primary',
                    className: 'friendship-action-btn',
                    href: `/dms?user=${encodeURIComponent(userData.username)}`
                });
                container.appendChild(link);
            }
        }

        // Ações de seguimento
        async function follow() {
            if (!currentUserData?.publicid) return;
            await FollowAPI.seguir(currentUserData.publicid, { showAlert: false });
            renderFollowActions(currentUserData);
        }

        async function unfollow() {
            if (!currentUserData?.publicid) return;
            const res = await FollowAPI.deixarDeSeguir(currentUserData.publicid, { 
                confirmMessage: `Parar de seguir ${currentUserData.username}?`,
                showAlert: false 
            });
            if (res.success) renderFollowActions(currentUserData);
        }

        function openDm() {
            if (onDmClickCallback && currentUserData) {
                modal.hide();
                onDmClickCallback(currentUserData);
            }
        }

        function hide() {
            modal.hide();
        }

        function getCurrentUserId() {
            return currentUserData ? currentUserData.publicid : null;
        }

        // API pública
        return {
            show,
            updateStatus,
            hide,
            follow,
            unfollow,
            openDm,
            getCurrentUserId
        };
    })();
</script>
